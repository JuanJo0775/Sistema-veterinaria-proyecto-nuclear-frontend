{% extends "client/client_base.html" %}

{% block title %}Historia Cl√≠nica de Mascotas{% endblock %}

{% block content %}
<div class="medical-history-page">
    <!-- ENCABEZADO -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-clipboard-list"></i>
            Historia Cl√≠nica de tus Mascotas
        </h1>
        <p class="page-subtitle">
            Consulta el historial m√©dico completo de cada una de tus mascotas
        </p>
    </div>

    <!-- SELECTOR DE MASCOTA -->
    <div class="pet-selector-container">
        <div class="form-group">
            <label for="petSelect" class="form-label">
                <i class="fas fa-paw"></i>
                Selecciona una mascota
            </label>
            <select id="petSelect" class="form-select" onchange="loadMedicalHistory()">
                <option value="">-- Elige una mascota para ver su historia --</option>
            </select>
        </div>

        <!-- Loading del selector -->
        <div id="petsLoading" class="loading-inline" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Cargando mascotas...</span>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="medicalHistoryContainer" class="history-container">

        <!-- Estado vac√≠o inicial -->
        <div id="emptyState" class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <h3>Selecciona una mascota</h3>
            <p>Elige una de tus mascotas para ver su historia cl√≠nica completa</p>
        </div>

        <!-- Loading de historia -->
        <div id="loadingState" class="loading-state" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Cargando historia cl√≠nica...</span>
            </div>
        </div>

        <!-- Estado sin registros -->
        <div id="noRecordsState" class="no-records-state" style="display: none;">
            <div class="no-records-icon">
                <i class="fas fa-file-medical"></i>
            </div>
            <h3>Sin registros m√©dicos</h3>
            <p>Esta mascota a√∫n no tiene registros en su historia cl√≠nica.</p>
            <div class="no-records-actions">
                <a href="/client/appointments/book" class="btn btn-primary">
                    <i class="fas fa-calendar-plus"></i>
                    Agendar Primera Cita
                </a>
            </div>
        </div>

        <!-- Contenido de la historia -->
        <div id="historyContent" class="history-content" style="display: none;">
            <!-- INFORMACI√ìN DE LA MASCOTA -->
            <div id="petInfo" class="pet-info-card">
                <div class="pet-info-header">
                    <img id="petPhoto" class="pet-avatar" style="display: none;" alt="Foto de mascota">
                    <div id="petInitial" class="pet-initial" style="display: none;">üêæ</div>
                    <div class="pet-basic-info">
                        <h2 id="petName">Nombre de la mascota</h2>
                        <div class="pet-details">
                            <span id="petSpecies">Especie</span> ‚Ä¢ <span id="petAge">Edad</span>
                        </div>
                    </div>
                </div>
                <div class="pet-info-grid">
                    <div class="pet-stat">
                        <div class="pet-stat-value" id="petWeight">N/A</div>
                        <div class="pet-stat-label">Peso (kg)</div>
                    </div>
                    <div class="pet-stat">
                        <div class="pet-stat-value" id="petVaccination">N/A</div>
                        <div class="pet-stat-label">Vacunaci√≥n</div>
                    </div>
                </div>
            </div>

            <!-- ESTAD√çSTICAS R√ÅPIDAS -->
            <div id="quickStats" class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon consultations">ü©∫</div>
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">Total Consultas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon vaccinations">üíâ</div>
                    <div class="stat-number" id="totalVaccinations">0</div>
                    <div class="stat-label">Vacunaciones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon emergencies">üö®</div>
                    <div class="stat-number" id="totalEmergencies">0</div>
                    <div class="stat-label">Emergencias</div>
                </div>
            </div>

            <!-- FILTROS Y B√öSQUEDA -->
            <div class="records-filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="dateFilter">Filtrar por fecha:</label>
                        <select id="dateFilter" onchange="filterRecords()">
                            <option value="all">Todos los registros</option>
                            <option value="last30">√öltimos 30 d√≠as</option>
                            <option value="last90">√öltimos 3 meses</option>
                            <option value="lastyear">√öltimo a√±o</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="typeFilter">Filtrar por tipo:</label>
                        <select id="typeFilter" onchange="filterRecords()">
                            <option value="all">Todos los tipos</option>
                            <option value="consultation">Consultas</option>
                            <option value="vaccination">Vacunaciones</option>
                            <option value="surgery">Cirug√≠as</option>
                            <option value="emergency">Emergencias</option>
                        </select>
                    </div>
                    <div class="filter-group export-group">
                        <label>Exportar historia:</label>
                        <div class="export-buttons">
                            <button id="downloadPdfBtn" onclick="downloadMedicalHistoryPDF()" class="btn btn-primary" disabled>
                                <i class="fas fa-file-pdf"></i>
                                <span>Descargar PDF</span>
                            </button>
                            <button id="printBtn" onclick="printMedicalHistory()" class="btn btn-secondary" disabled>
                                <i class="fas fa-print"></i>
                                <span>Imprimir</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- L√çNEA DE TIEMPO DE REGISTROS -->
            <div id="recordsTimeline" class="records-timeline">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>
</div>

<style>
.medical-history-page {
    padding: 20px;
    max-width: 1200%;
    margin: 0 auto;
}

.page-header {
    color: white;
    text-align: center;
    margin-bottom: 40px;
    padding: 30px 20px;
    background: linear-gradient(135deg, #2D6A4F 0%, #52B788 100%);
    border-radius: 20px;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.page-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
}

.pet-selector-container {
    max-width: 100%;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    position: relative;
}

.form-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #2D6A4F;
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.form-select {
    width: 100%;
    padding: 15px 20px;
    border: 2px solid #B7E4C7;
    border-radius: 10px;
    font-size: 1rem;
    background: white;
    transition: all 0.3s ease;
}

.form-select:focus {
    border-color: #52B788;
    outline: none;
    box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
}

.loading-inline {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95rem;
  color: #52B788;
  margin-left: auto;
}
.loading-inline i {
  font-size: 1.1rem;
}

.history-container {
    min-height: 400px;
}

.empty-state, .no-records-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.empty-icon, .no-records-icon {
    font-size: 4rem;
    color: #B7E4C7;
    margin-bottom: 20px;
}

.empty-state h3, .no-records-state h3 {
    color: #2D6A4F;
    margin-bottom: 10px;
    font-size: 1.5rem;
}

.empty-state p, .no-records-state p {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 20px;
}

.no-records-actions {
    margin-top: 20px;
}

.loading-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 1.1rem;
    color: #52B788;
    background-color: #f8fdf9;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin: 20px auto;
    max-width: fit-content;
    animation: fadeIn 0.3s ease-in-out;
    position: relative;
    z-index: 10;
}

.loading-spinner i {
    font-size: 1.5rem;
}

.history-content {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.pet-info-card {
    background: linear-gradient(135deg, #D8F3DC 0%, #B7E4C7 100%);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid #95D5B2;
}

.pet-info-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.pet-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.pet-initial {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #52B788;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    border: 4px solid white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.pet-basic-info h2 {
    color: #2D6A4F;
    margin: 0 0 5px 0;
    font-size: 1.8rem;
}

.pet-basic-info .pet-details {
    color: #40916C;
    font-size: 1.1rem;
}

.pet-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.pet-stat {
    background: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.pet-stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2D6A4F;
    margin-bottom: 5px;
}

.pet-stat-label {
    color: #666;
    font-size: 0.9rem;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border: 1px solid #B7E4C7;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.stat-icon.consultations { color: #40916C; }
.stat-icon.vaccinations { color: #2D6A4F; }
.stat-icon.emergencies { color: #e74c3c; }

.stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2D6A4F;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
}

.records-filters {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.filters-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2D6A4F;
}

.filter-group select {
    width: 100%;
    padding: 10px 15px;
    border: 2px solid #B7E4C7;
    border-radius: 8px;
    font-size: 0.95rem;
}

.export-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 200px;
}

.export-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    min-width: 120px;
    justify-content: center;
}

.btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-primary {
    background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    box-shadow: 0 4px 12px rgba(82, 183, 136, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #B7E4C7 0%, #D8F3DC 100%);
    color: #2D6A4F;
    border: 2px solid #B7E4C7;
}

.btn-secondary:hover:not(:disabled) {
    background: #B7E4C7;
}

.records-timeline {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.timeline-item {
    position: relative;
    padding-left: 60px;
    margin-bottom: 30px;
    border-left: 3px solid #B7E4C7;
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-dot {
    position: absolute;
    left: -12px;
    top: 8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.timeline-dot.consultation { background: #40916C; }
.timeline-dot.vaccination { background: #2D6A4F; }
.timeline-dot.emergency { background: #e74c3c; }
.timeline-dot.surgery { background: #8e44ad; }

.record-card {
    background: #f8fffe;
    border: 1px solid #B7E4C7;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.record-card:hover {
    box-shadow: 0 8px 25px rgba(45, 106, 79, 0.1);
    transform: translateY(-2px);
}

.record-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.record-date {
    background: #2D6A4F;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.record-type {
    background: #D8F3DC;
    color: #2D6A4F;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.record-title {
    color: #2D6A4F;
    font-size: 1.2rem;
    font-weight: 700;
    margin: 10px 0;
}

.record-vet {
    color: #52B788;
    font-size: 0.95rem;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.record-content {
    margin-bottom: 15px;
}

.record-field {
    margin-bottom: 12px;
}

.record-label {
    font-weight: 600;
    color: #2D6A4F;
    margin-bottom: 5px;
}

.record-value {
    color: #333;
    line-height: 1.5;
    padding: 8px 0;
}

.medications-list {
    background: #f0f9f4;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

.medication-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #B7E4C7;
}

.medication-item:last-child {
    border-bottom: none;
}

.medication-name {
    font-weight: 600;
    color: #2D6A4F;
}

.medication-dose {
    color: #666;
    font-size: 0.9rem;
}

.no-data-message {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 20px;
}

@media (max-width: 768px) {
    .page-title {
        font-size: 2rem;
    }

    .pet-info-header {
        flex-direction: column;
        text-align: center;
    }

    .pet-info-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .filters-row {
        grid-template-columns: 1fr;
    }

    .timeline-item {
        padding-left: 40px;
    }

    .export-buttons {
        width: 100%;
        justify-content: center;
    }

    .btn {
        flex: 1;
        min-width: auto;
    }
}
</style>

<script>
// =============== VARIABLES GLOBALES ===============
let currentPetId = null;
let currentPetData = null;
let allMedicalRecords = [];
let filteredMedicalRecords = [];

// =============== INICIALIZACI√ìN ===============
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando Historia Cl√≠nica del Cliente...');
    loadClientPets();
});

// =============== CARGA DE MASCOTAS DEL CLIENTE ===============
async function loadClientPets() {
    try {
        console.log('üêæ Cargando mascotas del cliente...');

        // Mostrar loading
        const loadingElement = document.getElementById('petsLoading');
        if (loadingElement) {
            loadingElement.style.display = 'flex';
        }

        const response = await fetch('/api/client/pets', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                populatePetSelector(data.pets);
                console.log(`‚úÖ ${data.pets.length} mascotas cargadas`);
            } else {
                console.error('‚ùå Error obteniendo mascotas:', data.message);
                showMessage('Error cargando tus mascotas', 'error');
            }
        } else {
            console.error('‚ùå Error de conexi√≥n obteniendo mascotas');
            showMessage('Error de conexi√≥n al cargar mascotas', 'error');
        }
    } catch (error) {
        console.error('‚ùå Error cargando mascotas:', error);
        showMessage('Error cargando mascotas del servidor', 'error');
    } finally {
        // Ocultar loading
        const loadingElement = document.getElementById('petsLoading');
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }
}

// =============== POBLAR SELECTOR DE MASCOTAS ===============
function populatePetSelector(pets) {
    const selector = document.getElementById('petSelect');
    if (!selector) {
        console.error('‚ùå No se encontr√≥ el selector de mascotas');
        return;
    }

    // Limpiar opciones existentes
    selector.innerHTML = '<option value="">-- Elige una mascota para ver su historia --</option>';

    // Agregar mascotas
    pets.forEach(pet => {
        const option = document.createElement('option');
        option.value = pet.id;
        option.textContent = `${pet.name} (${pet.species})`;
        selector.appendChild(option);
    });
}

// =============== CARGAR HISTORIA CL√çNICA ===============
function loadMedicalHistory() {
    const petSelect = document.getElementById('petSelect');
    if (!petSelect) {
        console.error('‚ùå No se encontr√≥ el selector de mascotas');
        return;
    }

    const selectedPetId = petSelect.value;
    console.log('üîç DEBUG - Pet ID seleccionado:', selectedPetId);

    // Variables globales
    currentPetId = selectedPetId;

    if (!selectedPetId) {
        // Estado vac√≠o
        showState('empty');
        disableButtons();
        return;
    }

    // Mostrar loading
    console.log('üîÑ Mostrando estado de carga...');
    showState('loading');

    // Construir URL del endpoint
    const apiUrl = `/api/client/pets/${selectedPetId}/medical-history`;
    console.log('üì° Llamando a endpoint:', apiUrl);

    // Cargar historia cl√≠nica
    fetch(apiUrl, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('üì° Respuesta del servidor:', response.status, response.statusText);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('üìä Datos recibidos:', data);

        if (data.success) {
            // ‚úÖ GUARDAR DATOS GLOBALES
            currentPetData = data.pet_info;
            allMedicalRecords = data.medical_records || [];

            console.log('üìã Registros m√©dicos encontrados:', allMedicalRecords.length);

            if (data.medical_records && data.medical_records.length > 0) {
                // Hay registros - mostrar contenido
                console.log('‚úÖ Mostrando contenido de historia cl√≠nica...');
                displayPetInfo(data.pet_info);
                displayHistoryContent(data.medical_records, data.pet_info);
                showState('content');
                enableButtons();
            } else {
                // Sin registros
                console.log('‚ö†Ô∏è No hay registros m√©dicos');
                showState('noRecords');
                enableButtons(); // Mantener botones habilitados
            }
        } else {
            // Error en response
            console.error('‚ùå Error en respuesta:', data.message);
            showState('noRecords');
            showMessage('Error cargando historia cl√≠nica: ' + data.message, 'error');
            disableButtons();
        }
    })
    .catch(error => {
        console.error('‚ùå Error completo:', error);
        showState('noRecords');
        showMessage('Error de conexi√≥n: ' + error.message, 'error');
        disableButtons();
    });
}

// =============== GESTI√ìN DE ESTADOS ===============
function showState(state) {
    // Ocultar todos los estados
    const states = ['emptyState', 'loadingState', 'noRecordsState', 'historyContent'];
    states.forEach(stateId => {
        const element = document.getElementById(stateId);
        if (element) {
            element.style.display = 'none';
        }
    });

    // Mostrar el estado solicitado
    let targetElement;
    switch(state) {
        case 'empty':
            targetElement = document.getElementById('emptyState');
            break;
        case 'loading':
            targetElement = document.getElementById('loadingState');
            break;
        case 'noRecords':
            targetElement = document.getElementById('noRecordsState');
            break;
        case 'content':
            targetElement = document.getElementById('historyContent');
            break;
    }

    if (targetElement) {
        targetElement.style.display = 'block';
    }
}

// =============== MOSTRAR INFORMACI√ìN DE LA MASCOTA ===============
function displayPetInfo(petInfo) {
    console.log('üìù Mostrando informaci√≥n de la mascota:', petInfo);

    // Verificar que los elementos existen antes de usarlos
    const petNameEl = document.getElementById('petName');
    const petSpeciesEl = document.getElementById('petSpecies');
    const petAgeEl = document.getElementById('petAge');
    const petWeightEl = document.getElementById('petWeight');
    const petVaccinationEl = document.getElementById('petVaccination');
    const petPhotoEl = document.getElementById('petPhoto');
    const petInitialEl = document.getElementById('petInitial');

    if (petNameEl) {
        petNameEl.textContent = petInfo.name || 'Nombre no disponible';
    }

    if (petSpeciesEl) {
        petSpeciesEl.textContent = getSpeciesLabel(petInfo.species) || 'No especificado';
    }

    if (petAgeEl) {
        const age = calculateAge(petInfo.birth_date);
        petAgeEl.textContent = age || 'No especificado';
    }

    if (petWeightEl) {
        petWeightEl.textContent = petInfo.weight ? `${petInfo.weight} kg` : 'No registrado';
    }

    if (petVaccinationEl) {
        petVaccinationEl.textContent = getVaccinationStatus(petInfo.vaccination_status) || 'No especificado';
    }

    // Configurar foto o inicial
    if (petPhotoEl && petInitialEl) {
        if (petInfo.photo_url) {
            petPhotoEl.src = petInfo.photo_url;
            petPhotoEl.style.display = 'block';
            petInitialEl.style.display = 'none';
        } else {
            petPhotoEl.style.display = 'none';
            petInitialEl.style.display = 'flex';
            petInitialEl.textContent = petInfo.name ? petInfo.name[0].toUpperCase() : 'üêæ';
        }
    }
}

// =============== MOSTRAR CONTENIDO DE HISTORIA ===============
function displayHistoryContent(records, petInfo) {
    console.log('üìã Mostrando contenido de historia cl√≠nica:', records.length, 'registros');

    // Estad√≠sticas r√°pidas
    const totalRecords = records.length;
    const totalVaccinations = records.filter(r => isVaccination(r)).length;
    const totalEmergencies = records.filter(r => r.is_emergency).length;

    // Actualizar estad√≠sticas
    const totalRecordsEl = document.getElementById('totalRecords');
    const totalVaccinationsEl = document.getElementById('totalVaccinations');
    const totalEmergenciesEl = document.getElementById('totalEmergencies');

    if (totalRecordsEl) totalRecordsEl.textContent = totalRecords;
    if (totalVaccinationsEl) totalVaccinationsEl.textContent = totalVaccinations;
    if (totalEmergenciesEl) totalEmergenciesEl.textContent = totalEmergencies;

    // Timeline de registros
    displayTimeline(records);

    // ‚úÖ AGREGAR: Verificar y habilitar botones de PDF cuando todo est√© listo
    setTimeout(() => {
        enableButtonsWhenReady();
    }, 500);
}

// =============== MOSTRAR TIMELINE ===============
function displayTimeline(records) {
    const timelineElement = document.getElementById('recordsTimeline');
    if (!timelineElement) {
        console.error('‚ùå No se encontr√≥ el elemento timeline');
        return;
    }

    if (!records || records.length === 0) {
        timelineElement.innerHTML = '<div class="no-data-message">No hay registros m√©dicos disponibles</div>';
        return;
    }

    const sortedRecords = records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    const timelineHtml = sortedRecords.map(record => `
        <div class="timeline-item">
            <div class="timeline-dot ${getRecordType(record)}"></div>
            <div class="record-card">
                <div class="record-header">
                    <div>
                        <div class="record-title">${getRecordIcon(record)} ${record.reason || 'Consulta m√©dica'}</div>
                        <div class="record-vet">üë®‚Äç‚öïÔ∏è ${record.veterinarian_name || 'Dr. Veterinario'}</div>
                    </div>
                    <div>
                        <div class="record-date">${formatDateTime(record.created_at)}</div>
                        <div class="record-type">${getRecordTypeLabel(record)}</div>
                    </div>
                </div>

                <div class="record-content">
                    ${record.diagnosis ? `
                        <div class="record-field">
                            <div class="record-label">Diagn√≥stico:</div>
                            <div class="record-value">${record.diagnosis}</div>
                        </div>
                    ` : ''}

                    ${record.treatment ? `
                        <div class="record-field">
                            <div class="record-label">Tratamiento:</div>
                            <div class="record-value">${record.treatment}</div>
                        </div>
                    ` : ''}

                    ${record.symptoms_description || record.symptoms ? `
                        <div class="record-field">
                            <div class="record-label">S√≠ntomas:</div>
                            <div class="record-value">${record.symptoms_description || record.symptoms}</div>
                        </div>
                    ` : ''}

                    ${record.observations ? `
                        <div class="record-field">
                            <div class="record-label">Observaciones:</div>
                            <div class="record-value">${record.observations}</div>
                        </div>
                    ` : ''}

                    ${record.medications && record.medications.length > 0 ? `
                        <div class="record-field">
                            <div class="record-label">Medicamentos:</div>
                            <div class="medications-list">
                                ${record.medications.map(med => `
                                    <div class="medication-item">
                                        <div class="medication-name">${med.medication_name || med.name}</div>
                                        <div class="medication-dose">${med.dosage || med.dose || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div style="text-align: right; margin-top: 15px; padding-top: 15px; border-top: 1px solid #B7E4C7;">
                    <button onclick="downloadIndividualRecordPDF('${record.id}')" class="btn btn-primary" style="font-size: 0.85rem; padding: 8px 16px;">
                        üìÑ Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    `).join('');

    timelineElement.innerHTML = timelineHtml;
}

// =============== FUNCIONES DE UTILIDAD ===============
function getSpeciesLabel(species) {
    const labels = {
        'perro': 'üêï Perro',
        'gato': 'üê± Gato',
        'ave': 'ü¶ú Ave',
        'conejo': 'üê∞ Conejo',
        'hamster': 'üêπ H√°mster',
        'otro': 'üêæ Otro'
    };
    return labels[species] || species || 'No especificado';
}

function getVaccinationStatus(status) {
    const statuses = {
        'completo': '‚úÖ Completo',
        'parcial': 'üü° Parcial',
        'pendiente': '‚ùå Pendiente',
        'vencido': 'üî¥ Vencido'
    };
    return statuses[status] || status || 'No especificado';
}

function calculateAge(birthDate) {
    if (!birthDate) return 'No especificado';

    try {
        const birth = new Date(birthDate);
        const today = new Date();
        const ageYears = (today - birth) / (365.25 * 24 * 60 * 60 * 1000);

        if (ageYears < 1) {
            const ageMonths = Math.floor(ageYears * 12);
            return `${ageMonths} mes${ageMonths !== 1 ? 'es' : ''}`;
        } else {
            const years = Math.floor(ageYears);
            return `${years} a√±o${years !== 1 ? 's' : ''}`;
        }
    } catch {
        return 'No especificado';
    }
}

function formatDateTime(dateString) {
    if (!dateString) return 'Fecha no disponible';

    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    } catch {
        return 'Fecha no disponible';
    }
}

function getRecordType(record) {
    if (record.is_emergency) return 'emergency';
    if (isVaccination(record)) return 'vaccination';
    return 'consultation';
}

function getRecordIcon(record) {
    if (record.is_emergency) return 'üö®';
    if (isVaccination(record)) return 'üíâ';
    return 'ü©∫';
}

function getRecordTypeLabel(record) {
    if (record.is_emergency) return 'Emergencia';
    if (isVaccination(record)) return 'Vacunaci√≥n';
    return 'Consulta';
}

function isVaccination(record) {
    const reason = (record.reason || '').toLowerCase();
    const diagnosis = (record.diagnosis || '').toLowerCase();
    const treatment = (record.treatment || '').toLowerCase();

    return reason.includes('vacun') ||
           reason.includes('inmuniz') ||
           diagnosis.includes('vacun') ||
           treatment.includes('vacun');
}

// =============== FUNCIONES DE BOTONES ===============
function enableButtons() {
    const downloadBtn = document.getElementById('downloadPdfBtn');
    const printBtn = document.getElementById('printBtn');
    if (downloadBtn) downloadBtn.disabled = false;
    if (printBtn) printBtn.disabled = false;
}

function disableButtons() {
    const downloadBtn = document.getElementById('downloadPdfBtn');
    const printBtn = document.getElementById('printBtn');
    if (downloadBtn) downloadBtn.disabled = true;
    if (printBtn) printBtn.disabled = true;
}

// =============== FUNCI√ìN PRINCIPAL: DESCARGAR PDF DE HISTORIA CL√çNICA COMPLETA - CORREGIDA ===============
async function downloadMedicalHistoryPDF() {
    if (!currentPetId || !currentPetData) {
        showMessage('No hay mascota seleccionada', 'error');
        return;
    }

    try {
        console.log(`üìÑ Descargando PDF de historia cl√≠nica completa: ${currentPetId}`);

        // Mostrar indicador de carga
        showMessage('Generando PDF de historia cl√≠nica...', 'info');

        // Deshabilitar bot√≥n temporalmente
        const downloadBtn = document.getElementById('downloadPdfBtn');
        if (downloadBtn) {
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando PDF...';
        }

        // CORRECCI√ìN: Usar el endpoint correcto del backend que ya existe
        const response = await fetch(`/api/client/pets/${currentPetId}/medical-history/export`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'text/html'
            }
        });

        if (!response.ok) {
            if (response.status === 404) {
                showMessage('Historia cl√≠nica no encontrada', 'error');
                return;
            } else if (response.status === 403) {
                showMessage('No tienes acceso a esta historia cl√≠nica', 'error');
                return;
            } else {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
        }

        // Obtener el contenido HTML del PDF
        const htmlContent = await response.text();

        // Crear nueva ventana para mostrar/descargar el PDF
        const printWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');

        if (!printWindow) {
            throw new Error('Ventana bloqueada. Permite popups para descargar el PDF.');
        }

        // Escribir el contenido HTML en la nueva ventana
        printWindow.document.write(htmlContent);
        printWindow.document.close();

        // Agregar JavaScript para auto-abrir di√°logo de impresi√≥n despu√©s de cargar
        printWindow.addEventListener('load', function() {
            setTimeout(() => {
                printWindow.focus();
                // Mostrar instrucciones al usuario
                showMessage('üí° Usa Ctrl+P para imprimir o guardar como PDF. En "Destino" selecciona "Guardar como PDF"', 'info');
            }, 1000);
        });

        console.log(`‚úÖ PDF de historia cl√≠nica generado exitosamente para mascota: ${currentPetData.name}`);

    } catch (error) {
        console.error(`‚ùå Error descargando PDF de historia cl√≠nica:`, error);
        showMessage(`Error generando PDF: ${error.message}`, 'error');
    } finally {
        // Rehabilitar bot√≥n
        const downloadBtn = document.getElementById('downloadPdfBtn');
        if (downloadBtn) {
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = '<i class="fas fa-file-pdf"></i> <span>Descargar PDF</span>';
        }
    }
}

// =============== FUNCI√ìN MEJORADA PARA DESCARGAR PDF DE REGISTRO INDIVIDUAL ===============
async function downloadIndividualRecordPDF(recordId) {
    if (!currentPetId) {
        showMessage('No hay mascota seleccionada', 'error');
        return;
    }

    try {
        console.log(`üìÑ Descargando PDF de registro individual: ${recordId}`);

        // Mostrar indicador de carga
        showMessage('Generando PDF del registro m√©dico...', 'info');

        // CORRECCI√ìN: Usar el endpoint correcto del backend
        const response = await fetch(`/api/client/pets/${currentPetId}/medical-records/${recordId}/pdf`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'text/html'
            }
        });

        if (!response.ok) {
            if (response.status === 404) {
                showMessage('Registro m√©dico no encontrado', 'error');
                return;
            } else if (response.status === 403) {
                showMessage('No tienes acceso a este registro m√©dico', 'error');
                return;
            } else {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
        }

        // Obtener el contenido HTML del PDF
        const htmlContent = await response.text();

        // Crear nueva ventana para mostrar/descargar el PDF
        const printWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');

        if (!printWindow) {
            throw new Error('Ventana bloqueada. Permite popups para descargar el PDF.');
        }

        // Escribir el contenido HTML en la nueva ventana
        printWindow.document.write(htmlContent);
        printWindow.document.close();

        // Agregar JavaScript para auto-abrir di√°logo de impresi√≥n despu√©s de cargar
        printWindow.addEventListener('load', function() {
            setTimeout(() => {
                printWindow.focus();
                showMessage('üí° Usa Ctrl+P para imprimir o guardar como PDF. En "Destino" selecciona "Guardar como PDF"', 'info');
            }, 1000);
        });

        console.log(`‚úÖ PDF del registro ${recordId} generado exitosamente`);

    } catch (error) {
        console.error(`‚ùå Error descargando PDF del registro ${recordId}:`, error);
        showMessage(`Error generando PDF: ${error.message}`, 'error');
    }
}

// =============== FUNCI√ìN PARA VERIFICAR SI LOS ENDPOINTS EST√ÅN DISPONIBLES ===============
async function checkPDFEndpoints() {
    if (!currentPetId) {
        console.log('‚ö†Ô∏è No hay mascota seleccionada para verificar endpoints');
        return false;
    }

    try {
        console.log('üîç Verificando disponibilidad de endpoints de PDF...');

        // Verificar endpoint de historia completa
        const historyResponse = await fetch(`/api/client/pets/${currentPetId}/medical-history/export`, {
            method: 'HEAD', // Solo verificar que existe, no descargar
            credentials: 'include'
        });

        console.log(`üì° Endpoint historia completa: ${historyResponse.status}`);

        if (historyResponse.ok) {
            enableButtons();
            return true;
        } else {
            console.log('‚ö†Ô∏è Endpoint de PDF no disponible');
            return false;
        }

    } catch (error) {
        console.error('‚ùå Error verificando endpoints:', error);
        return false;
    }
}

// =============== FUNCI√ìN DE IMPRIMIR ===============
function printMedicalHistory() {
    if (!currentPetId || !currentPetData) {
        showMessage('No hay mascota seleccionada', 'error');
        return;
    }

    try {
        // Generar contenido imprimible usando datos locales
        const printContent = generatePrintableContent();

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();

        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);

        showMessage('Ventana de impresi√≥n abierta', 'info');

    } catch (error) {
        console.error('‚ùå Error imprimiendo:', error);
        showMessage('Error al imprimir historia cl√≠nica', 'error');
    }
}

// =============== GENERAR CONTENIDO IMPRIMIBLE LOCAL ===============
function generatePrintableContent() {
    const petName = currentPetData.name || 'Mascota';
    const recordsHTML = allMedicalRecords.map(record => `
        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px;">
            <h4 style="color: #2D6A4F; margin: 0 0 10px 0;">
                ${record.reason || 'Consulta m√©dica'} - ${formatDateTime(record.created_at)}
            </h4>
            <p><strong>Veterinario:</strong> ${record.veterinarian_name || 'Dr. Veterinario'}</p>
            ${record.diagnosis ? `<p><strong>Diagn√≥stico:</strong> ${record.diagnosis}</p>` : ''}
            ${record.treatment ? `<p><strong>Tratamiento:</strong> ${record.treatment}</p>` : ''}
            ${record.observations ? `<p><strong>Observaciones:</strong> ${record.observations}</p>` : ''}
        </div>
    `).join('');

    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Historia Cl√≠nica - ${petName}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                .header { text-align: center; border-bottom: 2px solid #52B788; padding-bottom: 20px; margin-bottom: 30px; }
                .title { color: #2D6A4F; font-size: 24px; margin-bottom: 10px; }
                .pet-info { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                .records { margin-top: 20px; }
                .no-records { text-align: center; color: #666; padding: 40px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 class="title">üè• Historia Cl√≠nica Veterinaria</h1>
                <h2>${petName}</h2>
                <p>Generado el ${new Date().toLocaleDateString('es-ES', {
                    year: 'numeric', month: 'long', day: 'numeric'
                })}</p>
            </div>

            <div class="pet-info">
                <h3>üìã Informaci√≥n de la Mascota</h3>
                <p><strong>Nombre:</strong> ${currentPetData.name || 'N/A'}</p>
                <p><strong>Especie:</strong> ${getSpeciesLabel(currentPetData.species) || 'N/A'}</p>
                <p><strong>Peso:</strong> ${currentPetData.weight ? currentPetData.weight + ' kg' : 'N/A'}</p>
                <p><strong>Estado de Vacunaci√≥n:</strong> ${getVaccinationStatus(currentPetData.vaccination_status) || 'N/A'}</p>
            </div>

            <div class="records">
                <h3>üìã Registros M√©dicos (${allMedicalRecords.length})</h3>
                ${allMedicalRecords.length > 0 ? recordsHTML : '<div class="no-records">No hay registros m√©dicos disponibles</div>'}
            </div>
        </body>
        </html>
    `;
}

// =============== FUNCIONES DE FILTRADO ===============
function filterRecords() {
    // Implementar filtrado si es necesario
    console.log('Filtros aplicados');
}

// =============== FUNCI√ìN DE MENSAJES ===============
function showMessage(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;

    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;

    switch(type) {
        case 'success':
            notification.style.background = 'linear-gradient(135deg, #52B788, #38A3A5)';
            notification.innerHTML = `‚úÖ ${message}`;
            break;
        case 'error':
            notification.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            notification.innerHTML = `‚ùå ${message}`;
            break;
        case 'warning':
            notification.style.background = 'linear-gradient(135deg, #ffc107, #e0a800)';
            notification.style.color = '#212529';
            notification.innerHTML = `‚ö†Ô∏è ${message}`;
            break;
        default:
            notification.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
            notification.innerHTML = `‚ÑπÔ∏è ${message}`;
    }

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);

    notification.addEventListener('click', () => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    });
}

// =============== ESTILOS PARA ANIMACIONES ===============
const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    .notification {
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .notification:hover {
        transform: translateX(-5px);
    }
`;
document.head.appendChild(notificationStyles);

// =============== FUNCIONES GLOBALES PARA DEBUG ===============
window.debugPDFGeneration = debugPDFGeneration;
window.checkPDFEndpoints = checkPDFEndpoints;
window.enableButtonsWhenReady = enableButtonsWhenReady;

console.log('‚úÖ Sistema de Historia Cl√≠nica del Cliente inicializado correctamente');
console.log('üîß Funciones de debug disponibles: debugPDFGeneration(), checkPDFEndpoints()');

// =============== FUNCI√ìN DE PRUEBA PARA VERIFICAR CONEXI√ìN ===============
function testPDFConnection() {
    console.log('üß™ Iniciando prueba de conexi√≥n para PDF...');

    if (!currentPetId) {
        console.log('‚ùå No hay mascota seleccionada para probar');
        showMessage('Selecciona una mascota primero para probar la descarga', 'warning');
        return;
    }

    // Probar conexi√≥n con el endpoint
    fetch(`/api/client/pets/${currentPetId}/medical-history/export`, {
        method: 'HEAD',
        credentials: 'include'
    })
    .then(response => {
        console.log(`üì° Respuesta del servidor: ${response.status}`);
        if (response.ok) {
            showMessage('‚úÖ Conexi√≥n con el servidor exitosa - PDF disponible', 'success');
        } else {
            showMessage(`‚ö†Ô∏è Problema con el servidor: ${response.status}`, 'warning');
        }
    })
    .catch(error => {
        console.error('‚ùå Error probando conexi√≥n:', error);
        showMessage('‚ùå Error de conexi√≥n con el servidor', 'error');
    });
}

// Hacer funci√≥n disponible globalmente
window.testPDFConnection = testPDFConnection;

// =============== FUNCI√ìN PARA MOSTRAR INFORMACI√ìN DE DEBUG ===============
function debugPDFGeneration() {
    console.log('üîß Informaci√≥n de debug para generaci√≥n de PDF:');
    console.log('üìã Datos actuales:', {
        currentPetId,
        currentPetData,
        allMedicalRecords: allMedicalRecords?.length || 0,
        endpointHistoria: `/api/client/pets/${currentPetId}/medical-history/export`,
        endpointRegistro: `/api/client/pets/${currentPetId}/medical-records/[ID]/pdf`
    });

    if (!currentPetId) {
        console.log('‚ùå No hay mascota seleccionada');
        return;
    }

    if (!currentPetData) {
        console.log('‚ùå No hay datos de la mascota');
        return;
    }

    if (!allMedicalRecords || allMedicalRecords.length === 0) {
        console.log('‚ö†Ô∏è No hay registros m√©dicos cargados');
        return;
    }

    console.log('‚úÖ Todos los datos necesarios est√°n disponibles');

    // Probar llamada al endpoint
    checkPDFEndpoints().then(available => {
        console.log(`üîó Endpoints disponibles: ${available}`);
    });
}

// =============== FUNCI√ìN PARA HABILITAR BOTONES CUANDO LOS DATOS EST√âN LISTOS ===============
function enableButtonsWhenReady() {
    // Verificar que tengamos todos los datos necesarios
    if (currentPetId && currentPetData && allMedicalRecords) {
        // Verificar endpoints antes de habilitar
        checkPDFEndpoints().then(available => {
            if (available) {
                enableButtons();
                console.log('‚úÖ Botones de PDF habilitados - datos y endpoints listos');
            } else {
                console.log('‚ö†Ô∏è Endpoints no disponibles, botones deshabilitados');
                disableButtons();
            }
        });
    } else {
        console.log('‚ö†Ô∏è Datos incompletos, botones deshabilitados');
        disableButtons();
    }
}

</script>
{% endblock %}