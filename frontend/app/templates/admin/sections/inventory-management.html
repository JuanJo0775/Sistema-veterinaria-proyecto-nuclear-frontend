{% extends "admin/admin_base.html" %}

{% block title %}Gesti√≥n de Inventario{% endblock %}
{% block page_title %}Gesti√≥n de Inventario{% endblock %}

{% block custom_styles %}
<style>
    /* =============== MAIN CONTAINER =============== */
    .inventory-container {
        padding: 30px;
        background: white;
        min-height: calc(100vh - 80px);
    }

    /* =============== HEADER SECTION =============== */
    .inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .inventory-title-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .inventory-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .inventory-title {
        font-size: 2rem;
        font-weight: 600;
        color: #2D6A4F;
        margin: 0;
    }

    .inventory-subtitle {
        color: #52B788;
        font-size: 0.95rem;
        margin: 5px 0 0 0;
    }

    .inventory-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    /* =============== BUTTONS =============== */
    .btn {
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        font-size: 0.9rem;
        white-space: nowrap;
        min-height: 42px;
        justify-content: center;
    }

    .btn-primary {
        background: #52B788;
        color: white;
        border: 2px solid #52B788;
    }

    .btn-primary:hover {
        background: #2D6A4F;
        border-color: #2D6A4F;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #B7E4C7;
        color: #2D6A4F;
        border: 2px solid #B7E4C7;
    }

    .btn-secondary:hover {
        background: #D8F3DC;
        border-color: #52B788;
    }

    .btn-outline {
        background: transparent;
        color: #52B788;
        border: 2px solid #52B788;
    }

    .btn-outline:hover {
        background: #52B788;
        color: white;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
        min-height: 32px;
    }

    /* =============== STATS SECTION =============== */
    .stats-section {
        margin-bottom: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .stat-card {
        background: white;
        border: 2px solid #D8F3DC;
        border-radius: 12px;
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        border-color: #B7E4C7;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(82, 183, 136, 0.1);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        flex-shrink: 0;
    }

    .stat-icon.icon-total { background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%); }
    .stat-icon.icon-value { background: linear-gradient(135deg, #38A3A5 0%, #22577A 100%); }
    .stat-icon.icon-low { background: linear-gradient(135deg, #22577A 0%, #2D6A4F 100%); }
    .stat-icon.icon-expiring { background: linear-gradient(135deg, #2D6A4F 0%, #081C15 100%); }

    .stat-content {
        flex: 1;
    }

    .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2D6A4F;
        margin-bottom: 4px;
    }

    .stat-label {
        color: #52B788;
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* =============== FILTER SECTION =============== */
    .filter-section {
        background: #D8F3DC;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2D6A4F;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
    }

    .filter-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 20px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #2D6A4F;
    }

    .search-container {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #52B788;
        font-size: 16px;
        pointer-events: none;
    }

    .form-select {
        padding: 12px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .form-select:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
    }

    /* =============== VIEW TOGGLE =============== */
    .view-toggle {
        display: flex;
        background: white;
        border-radius: 8px;
        border: 2px solid #B7E4C7;
        overflow: hidden;
    }

    .view-btn {
        padding: 8px 16px;
        background: transparent;
        border: none;
        color: #52B788;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .view-btn.active {
        background: #52B788;
        color: white;
    }

    .view-btn:hover:not(.active) {
        background: #D8F3DC;
    }

    /* =============== MEDICATION TABLE =============== */
    .medications-container {
        background: white;
        border: 2px solid #D8F3DC;
        border-radius: 12px;
        overflow: hidden;
    }

    .table-header {
        background: #D8F3DC;
        padding: 20px;
        border-bottom: 2px solid #B7E4C7;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .table-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2D6A4F;
        margin: 0;
    }

    .table-container {
        overflow-x: auto;
        position: relative;
    }

    .medications-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
    }

    .medications-table thead {
        background: #B7E4C7;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .medications-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
        color: #2D6A4F;
        border: none;
        white-space: nowrap;
    }

    .medications-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #D8F3DC;
        vertical-align: middle;
        font-size: 0.85rem;
    }

    .medications-table tbody tr:hover {
        background: #D8F3DC;
        cursor: pointer;
    }

    /* =============== MEDICATION ITEM =============== */
    .medication-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .medication-image {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .medication-info {
        flex: 1;
        min-width: 0;
    }

    .medication-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
        font-size: 0.9rem;
    }

    .medication-details {
        color: #52B788;
        font-size: 0.8rem;
        opacity: 0.8;
    }

    /* =============== STATUS BADGES =============== */
    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        white-space: nowrap;
    }

    .status-in-stock {
        background: #B7E4C7;
        color: #2D6A4F;
    }

    .status-low-stock {
        background: #22577A;
        color: white;
    }

    .status-out-of-stock {
        background: #081C15;
        color: white;
    }

    /* =============== STOCK INDICATOR =============== */
    .stock-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stock-number {
        font-weight: 600;
        color: #2D6A4F;
        min-width: 40px;
    }

    .stock-bar {
        width: 60px;
        height: 6px;
        background: #D8F3DC;
        border-radius: 3px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .stock-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 3px;
    }

    .stock-high { background: #52B788; }
    .stock-medium { background: #38A3A5; }
    .stock-low { background: #22577A; }
    .stock-empty { background: #081C15; }

    /* =============== ACTION BUTTONS =============== */
    .action-buttons {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .action-btn.btn-edit {
        background: #B7E4C7;
        color: #2D6A4F;
    }

    .action-btn.btn-edit:hover {
        background: #52B788;
        color: white;
    }

    .action-btn.btn-stock {
        background: #38A3A5;
        color: white;
    }

    .action-btn.btn-stock:hover {
        background: #22577A;
    }

    .action-btn.btn-delete {
        background: #22577A;
        color: white;
    }

    .action-btn.btn-delete:hover {
        background: #081C15;
    }

    /* =============== LOADING STATE =============== */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        border-radius: 12px;
    }

    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #D8F3DC;
        border-top: 3px solid #52B788;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .loading-text {
        color: #2D6A4F;
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* =============== EMPTY STATE =============== */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #52B788;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.6;
    }

    .empty-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 10px;
    }

    .empty-subtitle {
        color: #52B788;
        margin-bottom: 25px;
    }

    /* =============== MODALS =============== */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(8, 28, 21, 0.7);
        backdrop-filter: blur(5px);
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
        margin: auto;
    }

    .modal-header {
        padding: 25px;
        border-bottom: 2px solid #D8F3DC;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .modal-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #2D6A4F;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #52B788;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        background: #D8F3DC;
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 25px;
    }

    .modal-footer {
        padding: 20px 25px;
        border-top: 2px solid #D8F3DC;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        position: sticky;
        bottom: 0;
        background: white;
    }

    /* =============== FORM STYLES =============== */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-label {
        font-weight: 600;
        color: #2D6A4F;
        font-size: 0.9rem;
    }

    .form-label.required::after {
        content: '*';
        color: #22577A;
        margin-left: 4px;
    }

    .form-control {
        padding: 12px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
    }

    .form-textarea {
        padding: 12px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 8px;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
        background: white;
    }

    /* =============== TABS SECTION =============== */
    .inventory-tabs {
        display: flex;
        background: #D8F3DC;
        border-radius: 12px;
        padding: 6px;
        gap: 4px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .inventory-tabs::-webkit-scrollbar {
        display: none;
    }

    .tab-item {
        padding: 12px 20px;
        background: transparent;
        border: none;
        border-radius: 8px;
        color: #2D6A4F;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: fit-content;
        font-size: 0.9rem;
    }

    .tab-item.active {
        background: white;
        color: #52B788;
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.2);
    }

    .tab-item:hover:not(.active) {
        background: rgba(82, 183, 136, 0.1);
    }

    /* =============== QUICK ACTIONS =============== */
    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .quick-action-btn {
        background: white;
        border: 2px solid #D8F3DC;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        color: #2D6A4F;
        text-align: left;
        font-size: 0.9rem;
    }

    .quick-action-btn:hover {
        border-color: #B7E4C7;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(82, 183, 136, 0.1);
    }

    .quick-action-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
        flex-shrink: 0;
    }

    /* =============== TAB CONTENT =============== */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    /* =============== BUTTON FIXES =============== */
    .action-btn.btn-delete {
        background: #dc3545;
        color: white;
    }

    .action-btn.btn-delete:hover {
        background: #c82333;
        transform: scale(1.05);
    }

    /* =============== VIEW CONTENT =============== */
    .medications-view-container {
        background: white;
        border: 2px solid #D8F3DC;
        border-radius: 12px;
        overflow: hidden;
    }

    #medicationsCardsContainer {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
    }

    /* =============== RESPONSIVE TABS =============== */
    @media (max-width: 768px) {
        .tabs-section {
            margin: 0 -20px 30px -20px;
            padding: 0 20px;
        }

        .quick-actions-grid {
            grid-template-columns: 1fr;
        }

        .tab-item {
            padding: 10px 16px;
            font-size: 0.85rem;
        }
    }
    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .filter-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
    }

    @media (max-width: 768px) {
        .inventory-container {
            padding: 20px;
        }

        .inventory-header {
            flex-direction: column;
            align-items: stretch;
            text-align: center;
        }

        .inventory-actions {
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .filter-section {
            padding: 20px;
        }

        .filter-header {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-actions {
            justify-content: center;
        }

        .table-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .modal-content {
            margin: 10px;
            max-height: calc(100vh - 20px);
        }

        .modal-header {
            padding: 20px;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            flex-direction: column-reverse;
        }

        .modal-footer .btn {
            width: 100%;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
            gap: 4px;
        }
    }

    /* =============== ANIMATIONS =============== */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .view-toggle-container {
    display: flex;
    gap: 5px;
    margin-left: 10px;
}

.view-toggle-buttons {
    display: flex;
    gap: 2px;
    background: #D8F3DC;
    border-radius: 8px;
    padding: 2px;
}

.view-toggle {
    border-radius: 6px !important;
    padding: 6px 12px !important;
    font-size: 0.75rem !important;
    border: none !important;
    background: transparent !important;
    color: #2D6A4F !important;
}

.view-toggle.active {
    background: white !important;
    color: #52B788 !important;
    box-shadow: 0 2px 8px rgba(82, 183, 136, 0.2) !important;
}

.medications-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    padding: 20px 0;
}

.medication-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(8, 28, 21, 0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.medication-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(8, 28, 21, 0.15);
    border-color: #52B788;
}

.medication-card-header {
    padding: 20px;
    background: linear-gradient(135deg, #D8F3DC 0%, #B7E4C7 100%);
    display: flex;
    align-items: flex-start;
    gap: 15px;
}

.medication-card .medication-image {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: linear-gradient(135deg, #52B788 0%, #2D6A4F 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.medication-info {
    flex: 1;
    min-width: 0;
}

.medication-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2D6A4F;
    margin: 0 0 5px 0;
    line-height: 1.3;
    word-break: break-word;
}

.medication-category {
    font-size: 0.85rem;
    color: #52B788;
    margin: 0;
    font-weight: 500;
}

.medication-status {
    flex-shrink: 0;
}

.medication-card-body {
    padding: 20px;
}

.medication-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 15px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.stat-label {
    font-size: 0.75rem;
    color: #666;
    font-weight: 500;
}

.stat-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: #2D6A4F;
}

.medication-card .stock-indicator {
    margin-bottom: 15px;
}

.medication-card .stock-bar {
    width: 100%;
    height: 8px;
    margin-bottom: 5px;
}

.medication-card-footer {
    padding: 15px 20px;
    background: #D8F3DC;
    display: flex;
    gap: 8px;
    justify-content: center;
}

.medication-card-footer .btn {
    flex: 1;
    min-width: 0;
    font-size: 0.75rem;
    padding: 8px 12px;
}

@media (max-width: 768px) {
    .medications-cards-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .view-toggle-container {
        width: 100%;
        justify-content: center;
        margin: 10px 0;
    }

    .medication-card-header {
        padding: 15px;
    }

    .medication-card-body {
        padding: 15px;
    }

    .medication-stats {
        grid-template-columns: 1fr;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .medications-cards-grid {
        grid-template-columns: 1fr;
        padding: 10px 0;
    }

    .medication-card-footer {
        flex-direction: column;
        gap: 6px;
    }

    .medication-card-footer .btn {
        flex: none;
    }
}

    /* =============== FOCUS STYLES =============== */
    .btn:focus,
    .form-control:focus,
    .view-btn:focus {
        outline: 2px solid #52B788;
        outline-offset: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="inventory-container">
    <!-- Header Section -->
    <div class="inventory-header">
        <div class="inventory-title-section">
            <div class="inventory-icon">üì¶</div>
            <div>
                <h1 class="inventory-title">Gesti√≥n de Inventario</h1>
                <p class="inventory-subtitle">Administra medicamentos y stock de la cl√≠nica</p>
            </div>
        </div>
        <div class="inventory-actions">
            <button class="btn btn-outline btn-sm" onclick="exportToCSV()">
                üìÑ Reporte PDF
            </button>
            <button class="btn btn-outline btn-sm" onclick="exportToExcel()">
                üìä Exportar Excel
            </button>
            <button class="btn btn-primary" onclick="openAddMedicationModal()">
                ‚ûï Nuevo Medicamento
            </button>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon icon-total">üì¶</div>
                <div class="stat-content">
                    <div class="stat-number" id="totalMedications">-</div>
                    <div class="stat-label">Total Medicamentos</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-value">üí∞</div>
                <div class="stat-content">
                    <div class="stat-number" id="totalValue">-</div>
                    <div class="stat-label">Valor Inventario</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-low">‚ö†Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-number" id="lowStockCount">-</div>
                    <div class="stat-label">Stock Bajo</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-expiring">‚è∞</div>
                <div class="stat-content">
                    <div class="stat-number" id="expiringCount">-</div>
                    <div class="stat-label">Por Vencer</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="tabs-section" style="margin-bottom: 30px;">
        <div class="inventory-tabs">
            <button class="tab-item active" data-tab="medications" onclick="switchTab('medications')">
                <span>üíä</span>
                Medicamentos
            </button>
            <button class="tab-item" data-tab="movements" onclick="switchTab('movements')">
                <span>üìã</span>
                Movimientos
            </button>
            <button class="tab-item" data-tab="alerts" onclick="switchTab('alerts')">
                <span>üö®</span>
                Alertas
            </button>
            <button class="tab-item" data-tab="reports" onclick="switchTab('reports')">
                <span>üìä</span>
                Reportes
            </button>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="quick-actions-section" style="margin-bottom: 30px;">
        <div class="quick-actions-grid">
            <button class="quick-action-btn" onclick="bulkUpdateStock()">
                <span class="quick-action-icon" style="background: #38A3A5;">üì¶</span>
                Actualizaci√≥n Masiva
            </button>
            <button class="quick-action-btn" onclick="checkExpirations()">
                <span class="quick-action-icon" style="background: #ff9800;">‚è∞</span>
                Verificar Vencimientos
            </button>
            <button class="quick-action-btn" onclick="lowStockReport()">
                <span class="quick-action-icon" style="background: #B7E4C7;">‚ö†Ô∏è</span>
                Stock Bajo
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-header">
            <h3 class="filter-title">üîç Filtros y Controles</h3>
            <div class="filter-actions">
                <div class="view-toggle">
                    <button class="view-btn active" id="listViewBtn">
                        üìã Lista
                    </button>
                    <button class="view-btn" id="cardViewBtn">
                        üìä Cards
                    </button>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                    üßπ Limpiar Filtros
                </button>
            </div>
        </div>

        <div class="filter-grid">
            <div class="filter-group">
                <label class="filter-label">Buscar Medicamento</label>
                <div class="search-container">
                    <input type="text" class="search-input" id="searchMedications"
                           placeholder="Cliente, mascota, medicamento...">
                    <span class="search-icon">üîç</span>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Categor√≠a</label>
                <select class="form-select" id="filterCategory">
                    <option value="">Todas las categor√≠as</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Estado</label>
                <select class="form-select" id="filterStock">
                    <option value="">Todos los estados</option>
                    <option value="in_stock">En Stock</option>
                    <option value="low_stock">Stock Bajo</option>
                    <option value="out_of_stock">Sin Stock</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Medications Table/Cards Container -->
    <div class="tab-content active" id="medications-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title" id="tableTitle">üìã Lista de Medicamentos</h3>
            </div>

            <div class="table-container" style="position: relative;">
                <!-- Loading Overlay (solo para la tabla) -->
                <div class="loading-overlay" id="medicationsLoading" style="display: none;">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Cargando medicamentos...</div>
                    </div>
                </div>

                <!-- Table View -->
                <table class="medications-table" id="medicationsTable">
                    <thead>
                        <tr>
                            <th>Medicamento</th>
                            <th>Categor√≠a</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Precio</th>
                            <th>Total</th>
                            <th>Vencimiento</th>
                            <th>Laboratorio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="medicationsTableBody">
                        <tr>
                            <td colspan="9">
                                <div class="empty-state">
                                    <div class="empty-icon">üì¶</div>
                                    <div class="empty-title">Cargando medicamentos...</div>
                                    <div class="empty-subtitle">Por favor espera un momento</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Cards View -->
                <div id="medicationsCardsContainer">
                    <!-- Cards will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Movements Tab -->
    <div class="tab-content" id="movements-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title">üìã Movimientos de Stock</h3>
                <button class="btn btn-primary btn-sm" onclick="loadMovements()">
                    üîç Cargar Movimientos
                </button>
            </div>

            <div style="padding: 20px;">
                <div class="filter-grid" style="margin-bottom: 20px;">
                    <div class="filter-group">
                        <label class="filter-label">Medicamento</label>
                        <select class="form-select" id="filterMedicationMovements">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tipo</label>
                        <select class="form-select" id="filterMovementType">
                            <option value="">Todos</option>
                            <option value="in">Entrada</option>
                            <option value="out">Salida</option>
                            <option value="adjustment">Ajuste</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Per√≠odo</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" class="form-select" id="filterDateFrom">
                            <input type="date" class="form-select" id="filterDateTo">
                        </div>
                    </div>
                </div>

                <div id="movementsContainer">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3rem;">üìã</div>
                        <div>Selecciona filtros y presiona "Cargar Movimientos"</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Tab -->
    <div class="tab-content" id="alerts-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title">üö® Alertas de Inventario</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-sm" onclick="refreshAlerts()">
                        üîÑ Actualizar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="sendAlertNotifications()">
                        üìß Notificar
                    </button>
                </div>
            </div>

            <div style="padding: 20px;" id="alertsContainer">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem;">üö®</div>
                    <div>Cargando alertas...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-content" id="reports-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title">üìä Generador de Reportes</h3>
            </div>

            <div style="padding: 20px;">
                <div class="filter-grid" style="margin-bottom: 20px;">
                    <div class="filter-group">
                        <label class="filter-label">Tipo de Reporte</label>
                        <select class="form-select" id="reportType">
                            <option value="general">Reporte General</option>
                            <option value="movements">Movimientos por Per√≠odo</option>
                            <option value="expiration">Medicamentos por Vencer</option>
                            <option value="low_stock">Stock Bajo</option>
                            <option value="financial">Valorizaci√≥n de Inventario</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Per√≠odo</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" class="form-select" id="reportDateFrom">
                            <input type="date" class="form-select" id="reportDateTo">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Formato</label>
                        <select class="form-select" id="reportFormat">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="generateSelectedReport()">
                        üìä Generar Reporte
                    </button>
                </div>

                <div id="reportPreview">
                    <!-- Report preview will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Medication Modal -->
<div class="modal" id="medicationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="medicationModalTitle">Agregar Medicamento</h3>
            <button class="modal-close" onclick="closeMedicationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="medicationForm">
                <input type="hidden" id="medicationId">

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Nombre del Medicamento</label>
                        <input type="text" class="form-control" id="medicationName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categor√≠a</label>
                        <select class="form-control" id="medicationCategory">
                            <option value="">Seleccionar categor√≠a</option>
                            <option value="Antibi√≥tico">Antibi√≥tico</option>
                            <option value="Analg√©sico">Analg√©sico</option>
                            <option value="Antiinflamatorio">Antiinflamatorio</option>
                            <option value="Antiparasitario">Antiparasitario</option>
                            <option value="Vitaminas">Vitaminas</option>
                            <option value="Vacunas">Vacunas</option>
                            <option value="Sedante">Sedante</option>
                            <option value="Antis√©ptico">Antis√©ptico</option>
                            <option value="Suplemento">Suplemento</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Presentaci√≥n</label>
                        <select class="form-control" id="medicationPresentation">
                            <option value="">Seleccionar presentaci√≥n</option>
                            <option value="Comprimidos">Comprimidos</option>
                            <option value="C√°psulas">C√°psulas</option>
                            <option value="Jarabe">Jarabe</option>
                            <option value="Inyectable">Inyectable</option>
                            <option value="Pomada">Pomada</option>
                            <option value="Gotas">Gotas</option>
                            <option value="Spray">Spray</option>
                            <option value="Polvo">Polvo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Concentraci√≥n</label>
                        <input type="text" class="form-control" id="medicationConcentration"
                               placeholder="ej: 500mg, 250mg/5ml">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Laboratorio</label>
                        <input type="text" class="form-control" id="medicationLaboratory">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Proveedor</label>
                        <input type="text" class="form-control" id="medicationSupplier">
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Precio Unitario</label>
                        <input type="number" class="form-control" id="medicationPrice"
                               step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Stock Inicial</label>
                        <input type="number" class="form-control" id="medicationStock"
                               min="0" value="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Stock M√≠nimo</label>
                        <input type="number" class="form-control" id="medicationMinStock"
                               min="0" value="10">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fecha de Vencimiento</label>
                        <input type="date" class="form-control" id="medicationExpiry">
                    </div>

                    <div class="form-group">
                        <label class="form-label">N√∫mero de Lote</label>
                        <input type="text" class="form-control" id="medicationBatch">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-textarea" id="medicationDescription"
                              placeholder="Descripci√≥n del medicamento, indicaciones, contraindicaciones..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Condiciones de Almacenamiento</label>
                    <textarea class="form-textarea" id="medicationStorage"
                              placeholder="ej: Conservar en lugar fresco y seco, temperatura ambiente..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeMedicationModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveMedication()">
                <span id="saveButtonText">Guardar</span>
            </button>
        </div>
    </div>
</div>

<!-- Stock Update Modal -->
<div class="modal" id="stockModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Actualizar Stock</h3>
            <button class="modal-close" onclick="closeStockModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #D8F3DC; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #2D6A4F; margin-bottom: 5px;" id="stockMedicationName">Medicamento</div>
                <div style="color: #52B788;">Stock actual: <span id="currentStock">0</span> unidades</div>
            </div>

            <form id="stockForm">
                <input type="hidden" id="stockMedicationId">

                <div class="form-group">
                    <label class="form-label required">Tipo de Movimiento</label>
                    <select class="form-control" id="movementType" onchange="updateMovementFields()" required>
                        <option value="">Seleccionar tipo</option>
                        <option value="in">Entrada (Agregar Stock)</option>
                        <option value="out">Salida (Reducir Stock)</option>
                        <option value="adjustment">Ajuste de Inventario</option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Cantidad</label>
                        <input type="number" class="form-control" id="movementQuantity" min="1" required>
                    </div>

                    <div class="form-group" id="unitCostGroup" style="display: none;">
                        <label class="form-label">Costo Unitario</label>
                        <input type="number" class="form-control" id="movementUnitCost" step="0.01" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Motivo/Raz√≥n</label>
                    <select class="form-control" id="movementReason" required>
                        <option value="">Seleccionar motivo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Referencia</label>
                    <input type="text" class="form-control" id="movementReference"
                           placeholder="N√∫mero de factura, prescripci√≥n, etc.">
                </div>

                <div style="background: #B7E4C7; padding: 12px; border-radius: 8px; color: #2D6A4F; display: none;" id="stockWarning">
                    Stock resultante: <strong id="resultingStock">0</strong> unidades
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStockModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveStockMovement()">
                üíæ Actualizar Stock
            </button>
        </div>
    </div>
</div>

<script>
// =============== VARIABLES GLOBALES ===============
let medications = [];
let currentMedicationId = null;
let isEditMode = false;

// =============== INICIALIZACI√ìN ===============
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando Gesti√≥n de Inventario...');

    setupEventListeners();
    loadInitialData();
});

function setupEventListeners() {
    // B√∫squeda
    const searchInput = document.getElementById('searchMedications');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterMedications, 300));
    }

    // Filtros
    ['filterCategory', 'filterStock'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', filterMedications);
        }
    });

    // Cerrar modales al hacer clic fuera
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeAllModals();
        }
    });

    // Atajos de teclado
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAllModals();
        }
        if (event.ctrlKey && event.key === 'n') {
            event.preventDefault();
            openAddMedicationModal();
        }
    });

    // C√°lculo de stock resultante
    const quantityInput = document.getElementById('movementQuantity');
    if (quantityInput) {
        quantityInput.addEventListener('input', calculateResultingStock);
    }
}

async function loadInitialData() {
    try {
        console.log('üîÑ Cargando datos iniciales...');

        await Promise.all([
            loadMedications(),
            loadCategories()
        ]);

        console.log('‚úÖ Datos iniciales cargados');
    } catch (error) {
        console.error('‚ùå Error cargando datos:', error);
        showMessage('Error cargando datos del inventario', 'error');
    }
}

// =============== CARGA DE DATOS ===============
async function loadMedications() {
    try {
        console.log('üì¶ Cargando medicamentos...');
        showLoading('medicationsLoading', true);

        const response = await fetch('/api/admin/inventory/medications');
        const data = await response.json();

        if (data.success) {
            medications = data.medications || [];
            console.log(`‚úÖ ${medications.length} medicamentos cargados`);

            if (data.message && data.message.includes('ejemplo')) {
                showMessage('‚ö†Ô∏è Mostrando datos de ejemplo - Servicio no disponible', 'warning');
            }

            renderMedicationsTable();
            updateStats();
        } else {
            throw new Error(data.message || 'Error cargando medicamentos');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        showMessage('Error cargando medicamentos: ' + error.message, 'error');
        renderEmptyState();
    } finally {
        showLoading('medicationsLoading', false);
    }
}

function renderMedications() {
    console.log(`üìã Renderizando medicamentos en vista: ${currentView || 'table'}`);

    // Asegurar que currentView est√© definida
    if (typeof currentView === 'undefined') {
        window.currentView = 'table';
    }

    if (currentView === 'cards') {
        renderMedicationsCards();
    } else {
        renderMedicationsTable();
        // Asegurar que las tarjetas est√©n ocultas
        const cardsContainer = document.getElementById('medicationsCards');
        if (cardsContainer) cardsContainer.style.display = 'none';

        const tableContainer = document.querySelector('.inventory-table-container');
        if (tableContainer) tableContainer.style.display = 'block';
    }
}

function initializeViewSystem() {
    console.log('üé® Inicializando sistema de vistas...');

    // Asegurar que las variables globales est√©n definidas
    if (typeof currentView === 'undefined') {
        window.currentView = 'table';
    }

    if (typeof medications === 'undefined') {
        window.medications = [];
    }

    try {
        // Inicializar sistema de tarjetas
        initializeCardSystem();

        // Sobrescribir la funci√≥n de renderizado principal
        window.renderMedicationsTable = function() {
            const tbody = document.getElementById('medicationsTableBody');
            const tableContainer = document.querySelector('.inventory-table-container');
            const cardsContainer = document.getElementById('medicationsCards');

            // Mostrar tabla y ocultar tarjetas
            if (tableContainer) tableContainer.style.display = 'block';
            if (cardsContainer) cardsContainer.style.display = 'none';

            if (!tbody) return;

            if (!medications || medications.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üì¶</div>
                            <div style="margin-bottom: 15px;">No hay medicamentos registrados</div>
                            <button class="btn btn-primary" onclick="openAddMedicationModal()">
                                <span>‚ûï</span> Agregar Primer Medicamento
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = medications.map(med => `
                <tr onclick="showMedicationDetails('${med.id}')" style="cursor: pointer;">
                    <td>
                        <div class="medication-image">
                            ${med.name.charAt(0).toUpperCase()}
                        </div>
                    </td>
                    <td>
                        <strong style="display: block; margin-bottom: 2px;">${med.name}</strong>
                        <small style="color: #666;">
                            ${med.presentation || ''} ${med.concentration || ''}
                        </small>
                    </td>
                    <td>
                        <span class="status-badge" style="background: #D8F3DC; color: #2D6A4F;">
                            ${med.category || 'Sin categor√≠a'}
                        </span>
                    </td>
                    <td>
                        <div class="stock-indicator">
                            <strong>${med.stock_quantity || 0}</strong>
                            <div class="stock-bar">
                                <div class="stock-fill ${getStockLevel(med)}"
                                     style="width: ${getStockPercentage(med)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${getStockStatusClass(med)}">
                            ${getStockStatusText(med)}
                        </span>
                    </td>
                    <td>${formatCurrency(med.unit_price || 0)}</td>
                    <td>${formatCurrency((med.unit_price || 0) * (med.stock_quantity || 0))}</td>
                    <td>
                        ${med.expiration_date ? formatDate(med.expiration_date) : 'N/A'}
                        ${getExpiryWarning(med)}
                    </td>
                    <td>${med.laboratory || 'N/A'}</td>
                    <td onclick="event.stopPropagation();">
                        <div class="action-buttons">
                            <button class="btn btn-info btn-xs" onclick="updateStock('${med.id}')" title="Stock">
                                üì¶
                            </button>
                            <button class="btn btn-primary btn-xs" onclick="editMedication('${med.id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-danger btn-xs" onclick="deleteMedication('${med.id}')" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        };

        console.log('‚úÖ Sistema de vistas inicializado');

    } catch (error) {
        console.error('‚ùå Error inicializando sistema de vistas:', error);
    }
}

async function loadCategories() {
    try {
        const response = await fetch('/api/admin/inventory/categories');
        const data = await response.json();

        if (data.success) {
            populateCategoryFilter(data.categories || []);
        }
    } catch (error) {
        console.error('‚ùå Error cargando categor√≠as:', error);
        populateCategoryFilter([
            'Antibi√≥tico', 'Analg√©sico', 'Antiinflamatorio',
            'Antiparasitario', 'Vitaminas', 'Vacunas'
        ]);
    }
}

function populateCategoryFilter(categories) {
    const filterSelect = document.getElementById('filterCategory');
    if (!filterSelect) return;

    filterSelect.innerHTML = '<option value="">Todas las categor√≠as</option>';

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
    });
}

// =============== RENDERIZADO ===============
const originalRenderMedicationsTable = window.renderMedicationsTable;

window.renderMedicationsTable = function() {
    const tbody = document.getElementById('medicationsTableBody');
    const tableContainer = document.querySelector('.inventory-table-container');
    const cardsContainer = document.getElementById('medicationsCards');

    // Mostrar tabla y ocultar tarjetas
    if (tableContainer) tableContainer.style.display = 'block';
    if (cardsContainer) cardsContainer.style.display = 'none';

    // Llamar a la funci√≥n original si existe, o renderizar tabla b√°sica
    if (originalRenderMedicationsTable && typeof originalRenderMedicationsTable === 'function') {
        originalRenderMedicationsTable();
    } else {
        // Renderizado b√°sico de tabla si no existe la funci√≥n original
        if (!tbody) return;

        if (medications.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üì¶</div>
                        <div style="margin-bottom: 15px;">No hay medicamentos registrados</div>
                        <button class="btn btn-primary" onclick="openAddMedicationModal()">
                            <span>‚ûï</span> Agregar Primer Medicamento
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = medications.map(med => `
            <tr onclick="showMedicationDetails('${med.id}')" style="cursor: pointer;">
                <td>
                    <div class="medication-image">
                        ${med.name.charAt(0).toUpperCase()}
                    </div>
                </td>
                <td>
                    <strong style="display: block; margin-bottom: 2px;">${med.name}</strong>
                    <small style="color: #666;">
                        ${med.presentation || ''} ${med.concentration || ''}
                    </small>
                </td>
                <td>
                    <span class="status-badge" style="background: #D8F3DC; color: #2D6A4F;">
                        ${med.category || 'Sin categor√≠a'}
                    </span>
                </td>
                <td>
                    <div class="stock-indicator">
                        <strong>${med.stock_quantity || 0}</strong>
                        <div class="stock-bar">
                            <div class="stock-fill ${getStockLevel(med)}"
                                 style="width: ${getStockPercentage(med)}%"></div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="status-badge ${getStockStatusClass(med)}">
                        ${getStockStatusText(med)}
                    </span>
                </td>
                <td>${formatCurrency(med.unit_price || 0)}</td>
                <td>${formatCurrency((med.unit_price || 0) * (med.stock_quantity || 0))}</td>
                <td>
                    ${med.expiration_date ? formatDate(med.expiration_date) : 'N/A'}
                    ${getExpiryWarning(med)}
                </td>
                <td>${med.laboratory || 'N/A'}</td>
                <td onclick="event.stopPropagation();">
                    <div class="action-buttons">
                        <button class="btn btn-info btn-xs" onclick="updateStock('${med.id}')" title="Stock">
                            üì¶
                        </button>
                        <button class="btn btn-primary btn-xs" onclick="editMedication('${med.id}')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger btn-xs" onclick="deleteMedication('${med.id}')" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
};

function renderEmptyState() {
    const tbody = document.getElementById('medicationsTableBody');
    if (!tbody) return;

    tbody.innerHTML = `
        <tr>
            <td colspan="9">
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <div class="empty-title">No hay medicamentos registrados</div>
                    <div class="empty-subtitle">Comienza agregando tu primer medicamento</div>
                    <button class="btn btn-primary" onclick="openAddMedicationModal()">
                        ‚ûï Agregar Medicamento
                    </button>
                </div>
            </td>
        </tr>
    `;

    updateTableTitle();
}

function updateTableTitle() {
    const title = document.getElementById('tableTitle');
    if (title) {
        title.textContent = `üìã Lista de Medicamentos (${medications.length})`;
    }
}

function updateStats() {
    const stats = {
        total_medications: medications.length,
        total_inventory_value: medications.reduce((sum, med) =>
            sum + (med.unit_price || 0) * (med.stock_quantity || 0), 0),
        low_stock_count: medications.filter(med =>
            getStockStatusText(med) === 'Stock Bajo').length,
        expiring_soon_count: medications.filter(med => {
            if (!med.expiration_date) return false;
            const daysToExpiry = Math.ceil(
                (new Date(med.expiration_date) - new Date()) / (1000 * 60 * 60 * 24)
            );
            return daysToExpiry <= 30 && daysToExpiry > 0;
        }).length
    };

    updateStatsDisplay(stats);
}

function updateStatsDisplay(stats) {
    const elements = {
        'totalMedications': stats.total_medications || 0,
        'totalValue': formatCurrency(stats.total_inventory_value || 0),
        'lowStockCount': stats.low_stock_count || 0,
        'expiringCount': stats.expiring_soon_count || 0
    };

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
}

// =============== FUNCIONES AUXILIARES ===============
function getStockLevel(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'stock-empty';
    if (stock <= minStock) return 'stock-low';
    if (stock <= minStock * 2) return 'stock-medium';
    return 'stock-high';
}

function getStockPercentage(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;
    const maxStock = minStock * 3;

    return Math.min(100, (stock / maxStock) * 100);
}

function getStockStatusClass(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'status-out-of-stock';
    if (stock <= minStock) return 'status-low-stock';
    return 'status-in-stock';
}

function getStockStatusText(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'Sin Stock';
    if (stock <= minStock) return 'Stock Bajo';
    return 'En Stock';
}

function getExpiryWarning(medication) {
    if (!medication.expiration_date) return '';

    const today = new Date();
    const expiryDate = new Date(medication.expiration_date);
    const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

    if (daysToExpiry < 0) {
        return '<div style="color: #081C15; font-size: 0.7rem; margin-top: 2px;">‚ö†Ô∏è VENCIDO</div>';
    } else if (daysToExpiry <= 30) {
        return `<div style="color: #22577A; font-size: 0.7rem; margin-top: 2px;">‚è∞ ${daysToExpiry}d</div>`;
    }

    return '';
}

// =============== MODALES ===============
function openAddMedicationModal() {
    isEditMode = false;
    currentMedicationId = null;
    document.getElementById('medicationModalTitle').textContent = 'Agregar Medicamento';
    document.getElementById('saveButtonText').textContent = 'Guardar';
    document.getElementById('medicationForm').reset();
    document.getElementById('medicationModal').classList.add('show');
}

function editMedication(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    isEditMode = true;
    currentMedicationId = medicationId;
    document.getElementById('medicationModalTitle').textContent = 'Editar Medicamento';
    document.getElementById('saveButtonText').textContent = 'Actualizar';

    // Llenar formulario
    const fields = {
        'medicationName': 'name',
        'medicationCategory': 'category',
        'medicationPresentation': 'presentation',
        'medicationConcentration': 'concentration',
        'medicationLaboratory': 'laboratory',
        'medicationSupplier': 'supplier',
        'medicationPrice': 'unit_price',
        'medicationStock': 'stock_quantity',
        'medicationMinStock': 'minimum_stock_alert',
        'medicationExpiry': 'expiration_date',
        'medicationBatch': 'batch_number',
        'medicationDescription': 'description',
        'medicationStorage': 'storage_conditions'
    };

    Object.entries(fields).forEach(([fieldId, medicationField]) => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.value = medication[medicationField] || '';
        }
    });

    document.getElementById('medicationModal').classList.add('show');
}

function closeMedicationModal() {
    document.getElementById('medicationModal').classList.remove('show');
    document.getElementById('medicationForm').reset();
    isEditMode = false;
    currentMedicationId = null;
}

async function saveMedication() {
    try {
        const form = document.getElementById('medicationForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const medicationData = {
            name: document.getElementById('medicationName').value,
            category: document.getElementById('medicationCategory').value,
            presentation: document.getElementById('medicationPresentation').value,
            concentration: document.getElementById('medicationConcentration').value,
            laboratory: document.getElementById('medicationLaboratory').value,
            supplier: document.getElementById('medicationSupplier').value,
            unit_price: parseFloat(document.getElementById('medicationPrice').value),
            stock_quantity: parseInt(document.getElementById('medicationStock').value) || 0,
            minimum_stock_alert: parseInt(document.getElementById('medicationMinStock').value) || 10,
            expiration_date: document.getElementById('medicationExpiry').value,
            batch_number: document.getElementById('medicationBatch').value,
            description: document.getElementById('medicationDescription').value,
            storage_conditions: document.getElementById('medicationStorage').value
        };

        const url = isEditMode && currentMedicationId
            ? `/api/admin/inventory/medications/${currentMedicationId}`
            : '/api/admin/inventory/medications';

        const method = isEditMode ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(medicationData)
        });

        const data = await response.json();

        if (data.success) {
            showMessage(
                isEditMode ? 'Medicamento actualizado exitosamente' : 'Medicamento creado exitosamente',
                'success'
            );
            closeMedicationModal();
            await loadMedications();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('‚ùå Error guardando medicamento:', error);
        showMessage('Error guardando medicamento: ' + error.message, 'error');
    }
}

// =============== GESTI√ìN DE STOCK ===============
function updateStock(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    currentMedicationId = medicationId;
    document.getElementById('stockMedicationId').value = medicationId;
    document.getElementById('stockMedicationName').textContent = medication.name;
    document.getElementById('currentStock').textContent = medication.stock_quantity || 0;

    document.getElementById('stockForm').reset();
    document.getElementById('stockMedicationId').value = medicationId;
    document.getElementById('unitCostGroup').style.display = 'none';
    document.getElementById('stockWarning').style.display = 'none';

    updateMovementReasons();
    document.getElementById('stockModal').classList.add('show');
}

function updateMovementFields() {
    const movementType = document.getElementById('movementType').value;
    const unitCostGroup = document.getElementById('unitCostGroup');

    unitCostGroup.style.display = movementType === 'in' ? 'block' : 'none';

    updateMovementReasons();
    calculateResultingStock();
}

function updateMovementReasons() {
    const movementType = document.getElementById('movementType').value;
    const reasonSelect = document.getElementById('movementReason');

    reasonSelect.innerHTML = '<option value="">Seleccionar motivo</option>';

    const reasons = {
        'in': ['Compra', 'Donaci√≥n', 'Devoluci√≥n', 'Ajuste positivo'],
        'out': ['Prescripci√≥n m√©dica', 'Vencimiento', 'Da√±o/deterioro', 'Uso interno'],
        'adjustment': ['Correcci√≥n de inventario', 'Auditoria', 'Error de registro']
    };

    if (reasons[movementType]) {
        reasons[movementType].forEach(reason => {
            const option = document.createElement('option');
            option.value = reason;
            option.textContent = reason;
            reasonSelect.appendChild(option);
        });
    }
}

function calculateResultingStock() {
    const currentStock = parseInt(document.getElementById('currentStock').textContent) || 0;
    const movementType = document.getElementById('movementType').value;
    const quantity = parseInt(document.getElementById('movementQuantity').value) || 0;

    if (!movementType || !quantity) {
        document.getElementById('stockWarning').style.display = 'none';
        return;
    }

    let resultingStock = currentStock;

    if (movementType === 'in') {
        resultingStock += quantity;
    } else if (movementType === 'out') {
        resultingStock -= quantity;
    } else if (movementType === 'adjustment') {
        resultingStock = quantity;
    }

    document.getElementById('resultingStock').textContent = resultingStock;
    document.getElementById('stockWarning').style.display = 'block';
}

function closeStockModal() {
    document.getElementById('stockModal').classList.remove('show');
    document.getElementById('stockForm').reset();
    currentMedicationId = null;
}

async function saveStockMovement() {
    try {
        const form = document.getElementById('stockForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const movementType = document.getElementById('movementType').value;
        const quantity = parseInt(document.getElementById('movementQuantity').value);
        const reason = document.getElementById('movementReason').value;
        const reference = document.getElementById('movementReference').value;
        const unitCost = parseFloat(document.getElementById('movementUnitCost').value) || null;
        const currentStock = parseInt(document.getElementById('currentStock').textContent) || 0;

        // CORRECCI√ìN: Validar y limpiar reference_id
        let cleanReference = null;
        if (reference && reference.trim() !== '') {
            cleanReference = reference.trim();
        }

        let requestData = {
            medication_id: currentMedicationId,
            movement_type: movementType,
            quantity: quantity,
            reason: reason,
            reference_id: cleanReference  // Puede ser null
        };

        // Solo agregar unit_cost si tiene valor
        if (unitCost && unitCost > 0) {
            requestData.unit_cost = unitCost;
        }

        // Para ajustes, calcular quantity_change
        if (movementType === 'adjustment') {
            requestData.quantity_change = quantity - currentStock;
        }

        console.log('üì¶ Datos de movimiento enviados:', requestData);

        const response = await fetch('/api/admin/inventory/stock/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Stock actualizado exitosamente', 'success');
            closeStockModal();
            await loadMedications();
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('‚ùå Error actualizando stock:', error);
        showMessage('Error actualizando stock: ' + error.message, 'error');
    }
}

// =============== OTRAS FUNCIONES ===============
async function deleteMedication(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    if (!confirm(`¬øEst√° seguro que desea eliminar el medicamento "${medication.name}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/admin/inventory/medications/${medicationId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Medicamento eliminado exitosamente', 'success');
            await loadMedications();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('‚ùå Error eliminando medicamento:', error);
        showMessage('Error eliminando medicamento: ' + error.message, 'error');
    }
}

function filterMedications() {
    const searchTerm = document.getElementById('searchMedications').value.toLowerCase();
    const categoryFilter = document.getElementById('filterCategory').value;
    const stockFilter = document.getElementById('filterStock').value;

    let filteredMedications = medications.filter(medication => {
        const matchesSearch = !searchTerm ||
            medication.name.toLowerCase().includes(searchTerm) ||
            (medication.laboratory && medication.laboratory.toLowerCase().includes(searchTerm)) ||
            (medication.category && medication.category.toLowerCase().includes(searchTerm));

        const matchesCategory = !categoryFilter || medication.category === categoryFilter;

        let matchesStock = true;
        if (stockFilter) {
            const stockStatus = getStockStatusText(medication).toLowerCase().replace(' ', '_');
            matchesStock = stockStatus === stockFilter;
        }

        return matchesSearch && matchesCategory && matchesStock;
    });

    const originalMedications = medications;
    medications = filteredMedications;
    renderMedicationsTable();
    medications = originalMedications;
}

function clearFilters() {
    document.getElementById('searchMedications').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStock').value = '';
    renderMedicationsTable();
}

function showMedicationDetails(medicationId) {
    console.log('üìã Mostrando detalles del medicamento:', medicationId);
    // Esta funci√≥n se puede expandir para mostrar un modal con detalles completos
}

async function exportToCSV() {
    try {
        console.log('üìÑ Exportando a CSV...');

        const link = document.createElement('a');
        link.href = '/api/admin/inventory/export/csv';
        link.target = '_blank';
        link.click();

        showMessage('Descarga de CSV iniciada', 'success');
    } catch (error) {
        console.error('‚ùå Error exportando CSV:', error);
        showMessage('Error exportando CSV', 'error');
    }
}

async function exportToExcel() {
    showMessage('Exportaci√≥n a Excel en desarrollo', 'info');
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
    });
}

function showLoading(elementId, show) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = show ? 'flex' : 'none';
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// =============== FUNCIONES DE UTILIDAD ===============
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return '$0';
    }

    try {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        }).format(amount);
    } catch (error) {
        return `${amount.toLocaleString() || 0}`;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Fecha inv√°lida';

        return date.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch {
        return 'Fecha inv√°lida';
    }
}

// =============== SISTEMA DE MENSAJES ===============
function showMessage(message, type = 'info') {
    console.log(`üì¢ ${type.toUpperCase()}: ${message}`);

    // Remover mensajes existentes
    const existingMessages = document.querySelectorAll('.dynamic-message');
    existingMessages.forEach(msg => msg.remove());

    // Crear elemento de mensaje
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} dynamic-message`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideInRight 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px 20px;
        border-radius: 8px;
        font-weight: 500;
    `;

    // Estilos seg√∫n el tipo
    const styles = {
        'success': { bg: '#B7E4C7', color: '#2D6A4F', border: '#52B788', icon: '‚úÖ' },
        'error': { bg: '#ffebee', color: '#c62828', border: '#c62828', icon: '‚ùå' },
        'warning': { bg: '#fff3e0', color: '#f57c00', border: '#ff9800', icon: '‚ö†Ô∏è' },
        'info': { bg: '#D8F3DC', color: '#2D6A4F', border: '#52B788', icon: '‚ÑπÔ∏è' }
    };

    const style = styles[type] || styles.info;
    alertDiv.style.background = style.bg;
    alertDiv.style.color = style.color;
    alertDiv.style.borderLeft = `4px solid ${style.border}`;

    alertDiv.innerHTML = `
        <span style="font-size: 1.2rem;">${style.icon}</span>
        <span style="flex: 1;">${message}</span>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        ">&times;</button>
    `;

    document.body.appendChild(alertDiv);

    // Auto remover despu√©s de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => alertDiv.remove(), 300);
        }
    }, 5000);
}

// =============== FUNCIONALIDADES ADICIONALES RESTAURADAS ===============

// Variables para tabs y vistas adicionales
let movements = [];


// =============== GESTI√ìN DE TABS (Corregido) ===============
function switchTab(tabName) {
    console.log('üîÑ Cambiando a tab:', tabName);

    // Actualizar tabs activos
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Mostrar contenido correspondiente
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');

    // Cargar datos espec√≠ficos del tab
    switch (tabName) {
        case 'medications':
            // Ya est√°n cargados, no hacer nada
            break;
        case 'movements':
            loadMovementsTab();
            break;
        case 'alerts':
            loadAlertsTab();
            break;
        case 'reports':
            loadReportsTab();
            break;
    }
}




// =============== RENDERIZADO DE CARDS (Corregido) ===============
function renderMedicationsCard() {
    const cardsContainer = document.getElementById('medicationsCardsContainer');
    if (!cardsContainer) return;

    if (medications.length === 0) {
        cardsContainer.innerHTML = `
            <div style="grid-column: 1 / -1;" class="empty-state">
                <div class="empty-icon">üì¶</div>
                <div class="empty-title">No hay medicamentos registrados</div>
                <div class="empty-subtitle">Comienza agregando tu primer medicamento</div>
                <button class="btn btn-primary" onclick="openAddMedicationModal()">
                    ‚ûï Agregar Medicamento
                </button>
            </div>
        `;
        return;
    }

    cardsContainer.innerHTML = medications.map(med => `
        <div style="
            background: white;
            border: 2px solid #D8F3DC;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        " onclick="showMedicationDetails('${med.id}')"
           onmouseover="this.style.borderColor='#B7E4C7'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.borderColor='#D8F3DC'; this.style.transform='translateY(0)'">

            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <div class="medication-image" style="width: 50px; height: 50px; font-size: 1.2rem;">
                    ${med.name.charAt(0).toUpperCase()}
                </div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 5px 0; color: #2D6A4F; font-size: 1.1rem;">${med.name}</h4>
                    <p style="margin: 0; color: #52B788; font-size: 0.85rem;">
                        ${med.category || 'Sin categor√≠a'} ‚Ä¢ ${med.laboratory || 'N/A'}
                    </p>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #2D6A4F; font-weight: 600;">Stock:</span>
                    <span style="color: #52B788; font-weight: 600;">${med.stock_quantity || 0} unidades</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #2D6A4F; font-weight: 600;">Precio:</span>
                    <span style="color: #52B788; font-weight: 600;">${formatCurrency(med.unit_price || 0)}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #2D6A4F; font-weight: 600;">Estado:</span>
                    <span class="status-badge ${getStockStatusClass(med)}">${getStockStatusText(med)}</span>
                </div>
            </div>

            <div style="display: flex; gap: 8px; justify-content: center;" onclick="event.stopPropagation();">
                <button class="action-btn btn-edit" onclick="editMedication('${med.id}')" title="Editar">‚úèÔ∏è</button>
                <button class="action-btn btn-stock" onclick="updateStock('${med.id}')" title="Stock">üì¶</button>
                <button class="action-btn btn-delete" onclick="deleteMedication('${med.id}')" title="Eliminar">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

// =============== TAB DE MOVIMIENTOS (Restaurado) ===============
async function loadMovementsTab() {
    console.log('üìã Cargando tab de movimientos...');

    // Poblar select de medicamentos
    const medicationSelect = document.getElementById('filterMedicationMovements');
    if (medicationSelect && medications.length > 0) {
        medicationSelect.innerHTML = '<option value="">Todos</option>';
        medications.forEach(med => {
            const option = document.createElement('option');
            option.value = med.id;
            option.textContent = med.name;
            medicationSelect.appendChild(option);
        });
    }

    // Establecer fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    const dateFromEl = document.getElementById('filterDateFrom');
    const dateToEl = document.getElementById('filterDateTo');

    if (dateFromEl && !dateFromEl.value) dateFromEl.value = weekAgo;
    if (dateToEl && !dateToEl.value) dateToEl.value = today;
}

function renderMovements(movementsData = movements) {
    const container = document.getElementById('movementsContainer');
    if (!container) return;

    if (movementsData.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 15px;">üìã</div>
                <div>No hay movimientos que coincidan con los filtros</div>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h4 style="color: #2D6A4F; margin: 0;">üìã Movimientos de Stock (${movementsData.length})</h4>
        </div>
        <div style="max-height: 600px; overflow-y: auto;">
            ${movementsData.map(movement => {
                const medication = medications.find(m => m.id === movement.medication_id);
                return `
                    <div style="
                        background: white;
                        border: 1px solid #D8F3DC;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2D6A4F; margin-bottom: 5px;">
                                ${getMovementTypeText(movement.movement_type)}
                                ${medication ? ` - ${medication.name}` : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #52B788;">
                                ${movement.reason} ‚Ä¢ Cantidad: ${movement.quantity} unidades<br>
                                ${formatDateTime(movement.created_at)}
                                ${movement.reference_id ? ` ‚Ä¢ Ref: ${movement.reference_id}` : ''}
                            </div>
                        </div>
                        <div style="
                            font-weight: 700;
                            font-size: 1.1rem;
                            color: ${movement.movement_type === 'out' ? '#22577A' : '#52B788'};
                            margin-left: 15px;
                        ">
                            ${movement.movement_type === 'out' ? '-' : '+'}${movement.quantity}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

async function updateStockEndpoint() {
    // Esta funci√≥n corrige el endpoint del frontend para manejar los diferentes tipos de movimiento

    const movementType = data.get('movement_type');
    let endpoint, requestData;

    // CORRECCI√ìN: Limpiar campos opcionales antes de enviar
    const cleanReference = data.get('reference_id');
    const cleanUserId = data.get('user_id');

    const baseData = {
        medication_id: data.get('medication_id'),
        quantity: parseInt(data.get('quantity')),
        reason: data.get('reason'),
        reference_id: (cleanReference && cleanReference.trim() !== '') ? cleanReference.trim() : null,
        user_id: (cleanUserId && cleanUserId.trim() !== '') ? cleanUserId.trim() : null
    };

    if (movementType === 'in') {
        endpoint = '/inventory/add-stock';
        requestData = {
            ...baseData,
            unit_cost: data.get('unit_cost') ? parseFloat(data.get('unit_cost')) : null
        };
    } else if (movementType === 'out') {
        endpoint = '/inventory/reduce-stock';
        requestData = baseData;
    } else { // adjustment
        endpoint = '/inventory/update-stock';
        requestData = {
            ...baseData,
            quantity_change: parseInt(data.get('quantity_change', 0))
        };
    }

    return { endpoint, requestData };
}

// =============== TAB DE REPORTES (Restaurado) ===============
function loadReportsTab() {
    console.log('üìä Cargando tab de reportes');

    // Establecer fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    const dateFromEl = document.getElementById('reportDateFrom');
    const dateToEl = document.getElementById('reportDateTo');

    if (dateFromEl && !dateFromEl.value) dateFromEl.value = monthAgo;
    if (dateToEl && !dateToEl.value) dateToEl.value = today;
}

function showReportPreview(data, reportType) {
    const container = document.getElementById('reportPreview');
    if (!container) return;

    let content = '';

    switch (reportType) {
        case 'movements':
            content = generateMovementsReport(data);
            break;
        case 'low_stock':
            content = generateLowStockReport(data);
            break;
        case 'expiration':
            content = generateExpirationReport(data);
            break;
        case 'financial':
            content = generateFinancialReport(data);
            break;
        default:
            content = generateGeneralReport(data);
    }

    container.innerHTML = content;
}

// =============== TAB DE MOVIMIENTOS (Restaurado) ===============
async function loadMovementsTab() {
    console.log('üìã Cargando movimientos...');
    // Funcionalidad de movimientos se puede expandir aqu√≠
}

async function loadMovements() {
    try {
        const medicationId = document.getElementById('filterMedicationMovements')?.value;
        const movementType = document.getElementById('filterMovementType')?.value;
        const dateFrom = document.getElementById('filterDateFrom')?.value;
        const dateTo = document.getElementById('filterDateTo')?.value;

        let url = '/api/admin/inventory/movements?';
        const params = new URLSearchParams();

        if (medicationId) params.append('medication_id', medicationId);
        if (movementType) params.append('movement_type', movementType);
        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        url += params.toString();

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            movements = data.movements || [];
            renderMovements();
            console.log(`‚úÖ ${movements.length} movimientos cargados`);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('‚ùå Error cargando movimientos:', error);
        showMessage('Error cargando movimientos', 'error');
        renderMovements([]);
    }
}

function renderMovements(movementsData = movements) {
    console.log('üìã Renderizando movimientos:', movementsData.length);
    // Implementaci√≥n de renderizado de movimientos
}

function getMovementTypeText(type) {
    const types = {
        'in': 'üì• Entrada',
        'out': 'üì§ Salida',
        'adjustment': '‚öñÔ∏è Ajuste'
    };
    return types[type] || type;
}

// =============== TAB DE ALERTAS (Restaurado) ===============
async function loadAlertsTab() {
    try {
        console.log('üö® Cargando alertas...');

        const [lowStockResponse, expiringResponse] = await Promise.all([
            fetch('/api/admin/inventory/alerts/low-stock'),
            fetch('/api/admin/inventory/alerts/expiring?days=30')
        ]);

        const lowStockData = await lowStockResponse.json();
        const expiringData = await expiringResponse.json();

        renderAlerts(
            lowStockData.success ? lowStockData.low_stock_medications : [],
            expiringData.success ? expiringData.expiring_medications : []
        );
    } catch (error) {
        console.error('‚ùå Error cargando alertas:', error);
        renderAlerts([], []);
    }
}

function renderAlerts(lowStockMeds, expiringMeds) {
    console.log('üö® Renderizando alertas:', lowStockMeds.length, expiringMeds.length);
    // Implementaci√≥n de renderizado de alertas
}

async function refreshAlerts() {
    await loadAlertsTab();
    showMessage('Alertas actualizadas', 'success');
}

async function sendAlertNotifications() {
    try {
        const response = await fetch('/api/admin/inventory/alerts/check-expiration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days_threshold: 30 })
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Notificaciones enviadas exitosamente', 'success');
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('‚ùå Error enviando notificaciones:', error);
        showMessage('Error enviando notificaciones', 'error');
    }
}

// =============== TAB DE REPORTES (Restaurado) ===============
function loadReportsTab() {
    console.log('üìä Cargando tab de reportes');
}

async function generateSelectedReport() {
    try {
        const reportType = document.getElementById('reportType')?.value || 'general';
        const dateFrom = document.getElementById('reportDateFrom')?.value;
        const dateTo = document.getElementById('reportDateTo')?.value;
        const format = document.getElementById('reportFormat')?.value || 'pdf';

        console.log('üìä Generando reporte:', { reportType, dateFrom, dateTo, format });

        let endpoint = '';
        let params = new URLSearchParams();

        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        switch (reportType) {
            case 'movements':
                endpoint = '/api/admin/inventory/movements';
                break;
            case 'low_stock':
                endpoint = '/api/admin/inventory/alerts/low-stock';
                break;
            case 'expiration':
                endpoint = '/api/admin/inventory/alerts/expiring';
                params.append('days', '30');
                break;
            case 'financial':
                endpoint = '/api/admin/inventory/summary';
                break;
            default:
                endpoint = '/api/admin/inventory/summary';
        }

        const url = `${endpoint}${params.toString() ? '?' + params.toString() : ''}`;

        if (format === 'csv') {
            exportToCSV();
        } else {
            const response = await fetch(url);
            const data = await response.json();

            if (data.success) {
                showReportPreview(data, reportType);
                showMessage('Reporte generado exitosamente', 'success');
            } else {
                throw new Error(data.message);
            }
        }
    } catch (error) {
        console.error('‚ùå Error generando reporte:', error);
        showMessage('Error generando reporte: ' + error.message, 'error');
    }
}

function showReportPreview(data, reportType) {
    console.log('üìä Mostrando preview de reporte:', reportType);
    // Implementaci√≥n de preview de reportes
}

// =============== FUNCIONES DE REPORTES ESPEC√çFICOS (Restaurado) ===============
function generateGeneralReport(data) {
    return `
        <div style="padding: 20px; background: white; border-radius: 12px;">
            <h4 style="color: #2D6A4F; margin-bottom: 20px;">üìä Reporte General de Inventario</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: #D8F3DC; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #2D6A4F;">${data.summary?.total_medications || 0}</div>
                    <div style="color: #52B788; font-size: 0.9rem;">Total Medicamentos</div>
                </div>
                <div style="background: #D8F3DC; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #2D6A4F;">${formatCurrency(data.summary?.total_inventory_value || 0)}</div>
                    <div style="color: #52B788; font-size: 0.9rem;">Valor Total</div>
                </div>
            </div>
        </div>
    `;
}

function generateMovementsReport(data) {
    const movements = data.movements || [];

    return `
        <div style="padding: 20px; background: white; border-radius: 12px;">
            <h4 style="color: #2D6A4F; margin-bottom: 20px;">üìã Reporte de Movimientos</h4>
            <p><strong>Total de movimientos:</strong> ${movements.length}</p>
            ${movements.length > 0 ? `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${movements.map(movement => `
                        <div style="padding: 10px; border: 1px solid #D8F3DC; border-radius: 8px; margin-bottom: 8px;">
                            <strong>${getMovementTypeText(movement.movement_type)}</strong> - ${movement.quantity} unidades<br>
                            <small style="color: #666;">${movement.reason} ‚Ä¢ ${formatDateTime(movement.created_at)}</small>
                        </div>
                    `).join('')}
                </div>
            ` : '<p style="text-align: center; color: #666; padding: 40px;">No hay movimientos en el per√≠odo seleccionado</p>'}
        </div>
    `;
}

function generateLowStockReport(data) {
    const lowStockMeds = data.low_stock_medications || [];

    return `
        <div style="padding: 20px; background: white; border-radius: 12px;">
            <h4 style="color: #2D6A4F; margin-bottom: 20px;">‚ö†Ô∏è Reporte de Stock Bajo</h4>
            <p><strong>Medicamentos con stock bajo:</strong> ${lowStockMeds.length}</p>
            ${lowStockMeds.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #D8F3DC;">
                            <tr>
                                <th style="padding: 10px; text-align: left; border: 1px solid #B7E4C7;">Medicamento</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #B7E4C7;">Stock Actual</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #B7E4C7;">Stock M√≠nimo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lowStockMeds.map(med => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #D8F3DC;"><strong>${med.name}</strong></td>
                                    <td style="padding: 10px; border: 1px solid #D8F3DC; color: #22577A; font-weight: 600;">${med.stock_quantity || 0}</td>
                                    <td style="padding: 10px; border: 1px solid #D8F3DC;">${med.minimum_stock_alert || 10}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<p style="text-align: center; color: #666; padding: 40px;">No hay medicamentos con stock bajo</p>'}
        </div>
    `;
}

function generateExpirationReport(data) {
    const expiringMeds = data.expiring_medications || [];

    return `
        <div style="padding: 20px; background: white; border-radius: 12px;">
            <h4 style="color: #2D6A4F; margin-bottom: 20px;">‚è∞ Reporte de Medicamentos por Vencer</h4>
            <p><strong>Medicamentos pr√≥ximos a vencer:</strong> ${expiringMeds.length}</p>
            ${expiringMeds.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #D8F3DC;">
                            <tr>
                                <th style="padding: 10px; text-align: left; border: 1px solid #B7E4C7;">Medicamento</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #B7E4C7;">Vencimiento</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #B7E4C7;">D√≠as Restantes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${expiringMeds.map(med => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #D8F3DC;"><strong>${med.name}</strong></td>
                                    <td style="padding: 10px; border: 1px solid #D8F3DC;">${formatDate(med.expiration_date)}</td>
                                    <td style="padding: 10px; border: 1px solid #D8F3DC; color: ${(med.days_to_expiration || 0) <= 7 ? '#22577A' : '#52B788'}; font-weight: 600;">
                                        ${med.days_to_expiration || 0} d√≠as
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<p style="text-align: center; color: #666; padding: 40px;">No hay medicamentos pr√≥ximos a vencer</p>'}
        </div>
    `;
}

function generateFinancialReport(data) {
    const summary = data.summary || {};

    return `
        <div style="padding: 20px; background: white; border-radius: 12px;">
            <h4 style="color: #2D6A4F; margin-bottom: 20px;">üí∞ Reporte Financiero de Inventario</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: #D8F3DC; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #2D6A4F;">${summary.total_medications || 0}</div>
                    <div style="color: #52B788; font-size: 0.9rem;">Total Medicamentos</div>
                </div>
                <div style="background: #D8F3DC; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #2D6A4F;">${formatCurrency(summary.total_inventory_value || 0)}</div>
                    <div style="color: #52B788; font-size: 0.9rem;">Valor Total</div>
                </div>
            </div>
            <div style="background: #D8F3DC; padding: 15px; border-radius: 8px;">
                <h5 style="color: #2D6A4F; margin-bottom: 10px;">üí° An√°lisis Financiero</h5>
                <ul style="color: #2D6A4F; margin: 0; padding-left: 20px;">
                    <li>Capital invertido: <strong>${formatCurrency(summary.total_inventory_value || 0)}</strong></li>
                    <li>Productos con riesgo: <strong>${summary.expiring_soon_count || 0}</strong></li>
                    <li>Requieren reabastecimiento: <strong>${summary.low_stock_count || 0}</strong></li>
                </ul>
            </div>
        </div>
    `;
}

// =============== FUNCIONES ADICIONALES UTILITARIAS (Restaurado) ===============
function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Fecha inv√°lida';

        return date.toLocaleString('es-CO');
    } catch {
        return 'Fecha inv√°lida';
    }
}

async function bulkUpdateStock() {
    showMessage('Funci√≥n de actualizaci√≥n masiva en desarrollo', 'info');
}

async function checkExpirations() {
    try {
        const response = await fetch('/api/admin/inventory/alerts/check-expiration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days_threshold: 30 })
        });

        const data = await response.json();

        if (data.success) {
            showMessage(`Verificaci√≥n completada. ${data.expiring_medications?.length || 0} medicamentos pr√≥ximos a vencer`, 'info');
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('‚ùå Error verificando vencimientos:', error);
        showMessage('Error verificando vencimientos', 'error');
    }
}

async function lowStockReport() {
    showMessage('Generando reporte de stock bajo...', 'info');
    await loadAlertsTab();
}

async function generateReport() {
    showMessage('Funcionalidad de reportes avanzados disponible', 'info');
}

async function testConnection() {
    try {
        console.log('üîß Probando conexi√≥n con backend...');
        showMessage('Probando conexi√≥n...', 'info');

        const response = await fetch('/api/admin/inventory/medications');
        const data = await response.json();

        if (data.success) {
            showMessage(`‚úÖ Conexi√≥n exitosa! ${data.medications?.length || 0} medicamentos encontrados`, 'success');
        } else {
            showMessage(`‚ùå Error: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('üîß Error de conexi√≥n:', error);
        showMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

// =============== GESTI√ìN DE VISTAS (Nuevo) ===============
let currentView = 'table'; // 'table' o 'cards'

function switchView(viewType) {
    console.log(`üîÑ Cambiando vista a: ${viewType}`);

    if (typeof currentView === 'undefined') {
        console.warn('‚ö†Ô∏è currentView no definida, inicializando...');
        window.currentView = 'table';
    }

    currentView = viewType;

    // Actualizar botones activos
    document.querySelectorAll('.view-toggle').forEach(btn => {
        btn.classList.remove('active');
    });

    const activeButton = document.querySelector(`[data-view="${viewType}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }

    // Renderizar seg√∫n la vista
    if (viewType === 'cards') {
        renderMedicationsCards();
    } else {
        renderMedicationsTable();
    }
}



function renderMedicationsCards() {
    console.log('üé¥ Renderizando vista de tarjetas...');

    const cardsContainer = document.getElementById('medicationsCards');
    const tableContainer = document.querySelector('.inventory-table-container');

    if (!cardsContainer) {
        console.warn('‚ö†Ô∏è Contenedor de tarjetas no encontrado, creando...');
        createCardsContainer();
        return renderMedicationsCards(); // Reintentar
    }

    // Ocultar tabla y mostrar tarjetas
    if (tableContainer) tableContainer.style.display = 'none';
    if (cardsContainer) cardsContainer.style.display = 'grid';

    if (!medications || medications.length === 0) {
        cardsContainer.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 2rem; margin-bottom: 10px;">üì¶</div>
                <div style="margin-bottom: 15px;">No hay medicamentos registrados</div>
                <button class="btn btn-primary" onclick="openAddMedicationModal()">
                    <span>‚ûï</span> Agregar Primer Medicamento
                </button>
            </div>
        `;
        return;
    }

    cardsContainer.innerHTML = medications.map(med => `
        <div class="medication-card" onclick="showMedicationDetails('${med.id}')" style="cursor: pointer;">
            <div class="medication-card-header">
                <div class="medication-image">
                    ${med.name.charAt(0).toUpperCase()}
                </div>
                <div class="medication-info">
                    <h3 class="medication-name">${med.name}</h3>
                    <p class="medication-category">${med.category || 'Sin categor√≠a'}</p>
                </div>
                <div class="medication-status">
                    <span class="status-badge ${getStockStatusClass(med)}">
                        ${getStockStatusText(med)}
                    </span>
                </div>
            </div>

            <div class="medication-card-body">
                <div class="medication-stats">
                    <div class="stat-item">
                        <span class="stat-label">Stock:</span>
                        <span class="stat-value">${med.stock_quantity || 0} unidades</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Precio:</span>
                        <span class="stat-value">${formatCurrency(med.unit_price || 0)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total:</span>
                        <span class="stat-value">${formatCurrency((med.unit_price || 0) * (med.stock_quantity || 0))}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Vence:</span>
                        <span class="stat-value">${med.expiration_date ? formatDate(med.expiration_date) : 'N/A'}</span>
                    </div>
                </div>

                <div class="stock-indicator">
                    <div class="stock-bar">
                        <div class="stock-fill ${getStockLevel(med)}"
                             style="width: ${getStockPercentage(med)}%"></div>
                    </div>
                    <small style="color: #666;">${med.minimum_stock_alert || 10} m√≠n.</small>
                </div>

                ${getExpiryWarning(med)}
            </div>

            <div class="medication-card-footer" onclick="event.stopPropagation();">
                <button class="btn btn-info btn-sm" onclick="updateStock('${med.id}')" title="Actualizar Stock">
                    üì¶ Stock
                </button>
                <button class="btn btn-primary btn-sm" onclick="editMedication('${med.id}')" title="Editar">
                    ‚úèÔ∏è Editar
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteMedication('${med.id}')" title="Eliminar">
                    üóëÔ∏è
                </button>
            </div>
        </div>
    `).join('');

    console.log(`‚úÖ ${medications.length} tarjetas renderizadas`);
}

function createCardsContainer() {
    const tableContainer = document.querySelector('.inventory-table-container');
    if (!tableContainer) {
        console.warn('‚ö†Ô∏è No se encontr√≥ .inventory-table-container');
        return;
    }

    // Verificar si ya existe
    if (document.getElementById('medicationsCards')) {
        console.log('üì¶ Contenedor de tarjetas ya existe');
        return;
    }

    const cardsContainer = document.createElement('div');
    cardsContainer.id = 'medicationsCards';
    cardsContainer.className = 'medications-cards-grid';
    cardsContainer.style.display = 'none';

    // Insertar despu√©s del contenedor de tabla
    tableContainer.parentNode.insertBefore(cardsContainer, tableContainer.nextSibling);
    console.log('‚úÖ Contenedor de tarjetas creado');
}

function initializeCardSystem() {
    console.log('üöÄ Inicializando sistema de tarjetas...');

    try {
        // Agregar CSS si no existe
        addCardsCSS();

        // Agregar botones de vista despu√©s de un delay
        setTimeout(() => {
            addViewToggleButtons();
            createCardsContainer();
            console.log('‚úÖ Sistema de tarjetas inicializado');
        }, 500);

    } catch (error) {
        console.error('‚ùå Error inicializando sistema de tarjetas:', error);
    }
}

function addViewToggleButtons() {
    const inventoryActions = document.querySelector('.inventory-actions');
    if (!inventoryActions) {
        console.warn('‚ö†Ô∏è No se encontr√≥ .inventory-actions');
        return;
    }

    // Verificar si ya existen los botones
    if (document.querySelector('.view-toggle-container')) {
        console.log('üîò Botones de vista ya existen');
        return;
    }

    const viewToggle = document.createElement('div');
    viewToggle.className = 'view-toggle-container';
    viewToggle.innerHTML = `
        <div class="view-toggle-buttons">
            <button class="btn btn-secondary btn-sm view-toggle active" data-view="table" onclick="switchView('table')" title="Vista de Tabla">
                üìã Tabla
            </button>
            <button class="btn btn-secondary btn-sm view-toggle" data-view="cards" onclick="switchView('cards')" title="Vista de Tarjetas">
                üé¥ Tarjetas
            </button>
        </div>
    `;

    inventoryActions.appendChild(viewToggle);
    console.log('‚úÖ Botones de vista agregados');
}

// Event listeners para botones de vista


document.addEventListener('DOMContentLoaded', function() {
    // Agregar CSS para tarjetas
    const styleElement = document.createElement('div');
    styleElement.innerHTML = cardsCSS;
    document.head.appendChild(styleElement.firstElementChild);

    // Agregar botones de vista despu√©s de que se cargue la p√°gina
    setTimeout(() => {
        addViewToggleButtons();
        createCardsContainer();
    }, 500);
});

if (typeof loadMedications === 'function') {
    const originalLoadMedications = loadMedications;
    loadMedications = async function() {
        await originalLoadMedications();
        // Inicializar sistema de vistas despu√©s de cargar datos
        setTimeout(initializeViewSystem, 100);
    };
}

console.log('‚úÖ Funciones de sistema de tarjetas cargadas');

console.log('‚úÖ Sistema de Inventario COMPLETO cargado - Versi√≥n Redise√±ada con toda la funcionalidad');
</script>

<!-- CSS para animaciones de mensajes -->
<style>
@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOutRight {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}

.dynamic-message {
    animation: slideInRight 0.3s ease !important;
}
</style>

{% endblock %}