{% extends "admin/admin_base.html" %}

{% block title %}Gesti√≥n de Usuarios{% endblock %}

{% block page_title %}Gesti√≥n de Usuarios y Roles{% endblock %}

{% block custom_styles %}
<style>
    /* =============== USERS MANAGEMENT SPECIFIC STYLES =============== */
    .users-content {
        padding: 30px;
    }

    .page-header {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        margin-bottom: 30px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .header-info h1 {
        color: #2D6A4F;
        font-size: 2.2rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-info p {
        color: #52B788;
        font-size: 1.1rem;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 15px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(82, 183, 136, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #B7E4C7 0%, #D8F3DC 100%);
        color: #2D6A4F;
        border: 2px solid #B7E4C7;
        padding: 10px 22px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-secondary:hover {
        background: #B7E4C7;
        transform: translateY(-2px);
    }

    /* ESTAD√çSTICAS */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .stat-item {
        background: white;
        padding: 25px;
        border-radius: 15px;
        border: 1px solid #D8F3DC;
        display: flex;
        align-items: center;
        gap: 20px;
        border-left: 4px solid;
        transition: transform 0.3s ease;
    }

    .stat-item:hover {
        transform: translateY(-3px);
    }

    .stat-item.total { border-left-color: #52B788; }
    .stat-item.vets { border-left-color: #38A3A5; }
    .stat-item.clients { border-left-color: #22577A; }
    .stat-item.active { border-left-color: #2D6A4F; }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .stat-icon.total { background: linear-gradient(135deg, #52B788, #38A3A5); }
    .stat-icon.vets { background: linear-gradient(135deg, #38A3A5, #22577A); }
    .stat-icon.clients { background: linear-gradient(135deg, #22577A, #2D6A4F); }
    .stat-icon.active { background: linear-gradient(135deg, #2D6A4F, #081C15); }

    .stat-data {
        flex: 1;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2D6A4F;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #52B788;
        font-size: 0.95rem;
        font-weight: 500;
    }

    /* FILTROS Y CONTROLES */
    .controls-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        margin-bottom: 30px;
    }

    .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .controls-title {
        color: #2D6A4F;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
    }

    .controls-grid {
        display: grid;
        grid-template-columns: 1fr 200px 200px 200px;
        gap: 20px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        color: #2D6A4F;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .form-input,
    .form-select {
        padding: 12px 15px;
        border: 2px solid #D8F3DC;
        border-radius: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
        color: #2D6A4F;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .search-input {
        background: #D8F3DC;
        border: 2px solid transparent;
    }

    .search-input:focus {
        background: white;
        border-color: #52B788;
    }

    /* TABLA DE USUARIOS */
    .users-table-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        overflow: hidden;
    }

    .table-header {
        padding: 25px;
        border-bottom: 1px solid #D8F3DC;
        background: linear-gradient(135deg, #F8FBF9 0%, #F0F8F0 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        color: #2D6A4F;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .results-info {
        color: #52B788;
        font-size: 0.9rem;
    }

    .table-container {
        overflow-x: auto;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table th {
        background: #D8F3DC;
        padding: 18px 20px;
        text-align: left;
        font-weight: 600;
        color: #2D6A4F;
        border-bottom: 2px solid #B7E4C7;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .users-table td {
        padding: 18px 20px;
        border-bottom: 1px solid #D8F3DC;
        vertical-align: middle;
    }

    .users-table tr {
        transition: all 0.2s ease;
    }

    .users-table tr:hover {
        background: rgba(183, 228, 199, 0.15);
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #52B788, #38A3A5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .user-details {
        flex: 1;
    }

    .user-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
    }

    .user-email {
        color: #52B788;
        font-size: 0.85rem;
    }

    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
    }

    .role-badge.admin { background: linear-gradient(135deg, #2D6A4F, #081C15); }
    .role-badge.veterinarian { background: linear-gradient(135deg, #52B788, #38A3A5); }
    .role-badge.receptionist { background: linear-gradient(135deg, #38A3A5, #22577A); }
    .role-badge.auxiliary { background: linear-gradient(135deg, #22577A, #2D6A4F); }
    .role-badge.client { background: linear-gradient(135deg, #B7E4C7, #52B788); color: #2D6A4F; }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-badge.active {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
    }

    .status-badge.inactive {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
    }

    .actions-group {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .action-btn.view {
        background: #22577A;
        color: white;
    }

    .action-btn.edit {
        background: #52B788;
        color: white;
    }

    .action-btn.toggle {
        background: #dc3545;
        color: white;
    }

    .action-btn.activate {
        background: #28a745;
        color: white;
    }

    .action-btn.delete {
        background: #dc3545;
        color: white;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* MODAL STYLES */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(8, 28, 21, 0.8);
        backdrop-filter: blur(5px);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(8, 28, 21, 0.3);
        animation: modalSlideIn 0.3s ease;
        position: relative;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        padding: 25px 30px 0;
        border-bottom: 1px solid #D8F3DC;
        margin-bottom: 25px;
    }

    .modal-title {
        color: #2D6A4F;
        font-size: 1.6rem;
        font-weight: 600;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-subtitle {
        color: #52B788;
        font-size: 1rem;
        margin: 0 0 20px 0;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 25px;
        background: none;
        border: none;
        font-size: 24px;
        color: #52B788;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #D8F3DC;
        color: #2D6A4F;
    }

    .modal-body {
        padding: 0 30px 30px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row.full {
        grid-template-columns: 1fr;
    }

    .modal-actions {
        padding: 20px 30px;
        border-top: 1px solid #D8F3DC;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        background: #F8FBF9;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .btn-cancel:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .btn-save {
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(82, 183, 136, 0.3);
    }

    .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #52B788;
    }

    .empty-state h3 {
        color: #2D6A4F;
        margin-bottom: 15px;
        font-size: 1.4rem;
    }

    .empty-state p {
        margin-bottom: 25px;
        font-size: 1rem;
    }

    /* LOADING STATE */
    .table-loading {
        text-align: center;
        padding: 40px;
        color: #52B788;
    }

    .table-loading .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #D8F3DC;
        border-top: 4px solid #52B788;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
        .controls-grid {
            grid-template-columns: 1fr 180px 180px;
        }
    }

    @media (max-width: 768px) {
        .users-content {
            padding: 20px 15px;
        }

        .header-content {
            flex-direction: column;
            gap: 20px;
            align-items: stretch;
        }

        .header-actions {
            justify-content: center;
        }

        .stats-row {
            grid-template-columns: 1fr;
        }

        .controls-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            margin: 20px;
        }

        .users-table {
            font-size: 0.85rem;
        }

        .users-table th,
        .users-table td {
            padding: 12px 10px;
        }

        .actions-group {
            flex-direction: column;
            gap: 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="users-content">
    <!-- HEADER -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <h1>
                    <span>üë•</span>
                    Gesti√≥n de Usuarios y Roles
                </h1>
                <p>Administra usuarios, roles y permisos del sistema veterinario</p>
            </div>
            <div class="header-actions">
                <button onclick="exportUsers('excel')" class="btn-secondary">
                    üìä Exportar Excel
                </button>
                <button onclick="exportUsers('pdf')" class="btn-secondary">
                    üìÑ Exportar PDF
                </button>
                <button onclick="openUserModal()" class="btn-primary">
                    ‚ûï Nuevo Usuario
                </button>
            </div>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div class="stats-row">
            <div class="stat-item total">
                <div class="stat-icon total">üë•</div>
                <div class="stat-data">
                    <div class="stat-value" id="usersTotal">-</div>
                    <div class="stat-label">Total Usuarios</div>
                </div>
            </div>
            <div class="stat-item vets">
                <div class="stat-icon vets">üë®‚Äç‚öïÔ∏è</div>
                <div class="stat-data">
                    <div class="stat-value" id="usersVets">-</div>
                    <div class="stat-label">Veterinarios</div>
                </div>
            </div>
            <div class="stat-item clients">
                <div class="stat-icon clients">üë§</div>
                <div class="stat-data">
                    <div class="stat-value" id="usersClients">-</div>
                    <div class="stat-label">Clientes</div>
                </div>
            </div>
            <div class="stat-item active">
                <div class="stat-icon active">‚úÖ</div>
                <div class="stat-data">
                    <div class="stat-value" id="usersActive">-</div>
                    <div class="stat-label">Usuarios Activos</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLES Y FILTROS -->
    <div class="controls-section">
        <div class="controls-header">
            <h3 class="controls-title">üîç Filtros y Controles</h3>
            <button onclick="resetFilters()" class="btn-secondary">
                üîÑ Limpiar Filtros
            </button>
        </div>
        <div class="controls-grid">
            <div class="form-group">
                <label for="searchInput" class="form-label">Buscar Usuario</label>
                <input type="text" id="searchInput" class="form-input search-input"
                       placeholder="Nombre, email o tel√©fono..."
                       onkeyup="filterUsers()">
            </div>
            <div class="form-group">
                <label for="roleFilter" class="form-label">Filtrar por Rol</label>
                <select id="roleFilter" class="form-select" onchange="filterUsers()">
                    <option value="">Todos los roles</option>
                    <option value="admin">üëë Administrador</option>
                    <option value="veterinarian">üë®‚Äç‚öïÔ∏è Veterinario</option>
                    <option value="receptionist">üë©‚Äçüíº Recepcionista</option>
                    <option value="auxiliary">üë©‚Äçüî¨ Auxiliar</option>
                    <option value="client">üë§ Cliente</option>
                </select>
            </div>
            <div class="form-group">
                <label for="statusFilter" class="form-label">Filtrar por Estado</label>
                <select id="statusFilter" class="form-select" onchange="filterUsers()">
                    <option value="">Todos los estados</option>
                    <option value="true">‚úÖ Activos</option>
                    <option value="false">‚ùå Inactivos</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sortBy" class="form-label">Ordenar por</label>
                <select id="sortBy" class="form-select" onchange="sortUsers()">
                    <option value="name">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                    <option value="email">Email A-Z</option>
                    <option value="role">Rol</option>
                    <option value="created_at">Fecha registro</option>
                    <option value="created_at_desc">M√°s recientes</option>
                </select>
            </div>
        </div>
    </div>

    <!-- TABLA DE USUARIOS -->
    <div class="users-table-section">
        <div class="table-header">
            <h3 class="table-title">
                üìã Lista de Usuarios
            </h3>
            <div class="results-info" id="resultsInfo">
                Cargando usuarios...
            </div>
        </div>
        <div class="table-container">
            <div id="usersTableContainer">
                <div class="table-loading">
                    <div class="spinner"></div>
                    <span>Cargando usuarios desde el servidor...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA CREAR/EDITAR USUARIO -->
<div class="modal" id="userModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeUserModal()">‚úñ</button>
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">
                <span id="modalIcon">‚ûï</span>
                <span id="modalTitleText">Nuevo Usuario</span>
            </h2>
            <p class="modal-subtitle" id="modalSubtitle">Completa la informaci√≥n del usuario</p>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <input type="hidden" id="userId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName" class="form-label">Nombre *</label>
                        <input type="text" id="firstName" name="first_name" class="form-input" required
                               placeholder="Nombre del usuario">
                    </div>
                    <div class="form-group">
                        <label for="lastName" class="form-label">Apellido *</label>
                        <input type="text" id="lastName" name="last_name" class="form-input" required
                               placeholder="Apellido del usuario">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" id="email" name="email" class="form-input" required
                               placeholder="email@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="phone" class="form-label">Tel√©fono</label>
                        <input type="tel" id="phone" name="phone" class="form-input"
                               placeholder="+57 300 123 4567">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="role" class="form-label">Rol *</label>
                        <select id="role" name="role" class="form-select" required>
                            <option value="">Seleccionar rol</option>
                            <option value="admin">üëë Administrador</option>
                            <option value="veterinarian">üë®‚Äç‚öïÔ∏è Veterinario</option>
                            <option value="receptionist">üë©‚Äçüíº Recepcionista</option>
                            <option value="auxiliary">üë©‚Äçüî¨ Auxiliar</option>
                            <option value="client">üë§ Cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status" class="form-label">Estado</label>
                        <select id="status" name="is_active" class="form-select">
                            <option value="true">‚úÖ Activo</option>
                            <option value="false">‚ùå Inactivo</option>
                        </select>
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label for="address" class="form-label">Direcci√≥n</label>
                        <input type="text" id="address" name="address" class="form-input"
                               placeholder="Direcci√≥n completa (opcional)">
                    </div>
                </div>

                <div class="form-row" id="passwordRow">
                    <div class="form-group">
                        <label for="password" class="form-label">Contrase√±a *</label>
                        <input type="password" id="password" name="password" class="form-input"
                               placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">Confirmar Contrase√±a *</label>
                        <input type="password" id="confirmPassword" name="confirm_password" class="form-input"
                               placeholder="Repetir contrase√±a">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeUserModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="saveUser()" class="btn-save" id="saveBtn">
                <span id="saveBtnIcon">üíæ</span>
                <span id="saveBtnText">Guardar Usuario</span>
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN -->
<div class="modal" id="confirmModal">
    <div class="modal-content" style="max-width: 450px;">
        <button class="modal-close" onclick="closeConfirmModal()">‚úñ</button>
        <div class="modal-header">
            <h2 class="modal-title" id="confirmTitle">
                <span id="confirmIcon">‚ùì</span>
                Confirmar Acci√≥n
            </h2>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">¬øEst√°s seguro de realizar esta acci√≥n?</p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeConfirmModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="executeConfirmAction()" class="btn-save" id="confirmBtn">
                <span id="confirmBtnText">Confirmar</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // =============== VARIABLES GLOBALES ===============
    let allUsers = [];
    let filteredUsers = [];
    let currentEditingUser = null;
    let confirmAction = null;
    let confirmUserId = null;

    // =============== INICIALIZACI√ìN ===============
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando Gesti√≥n de Usuarios...');
        loadUsersData();
    });

    // =============== CARGA DE DATOS ===============
    async function loadUsersData() {
        try {
            console.log('üì° Obteniendo usuarios del Auth Service...');

            // Opci√≥n 1: Intentar a trav√©s del endpoint del frontend (recomendado)
            let response = await fetch('/api/admin/users', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            // Si falla, intentar directamente (fallback)
            if (!response.ok) {
                console.log('‚ö†Ô∏è Intentando conexi√≥n directa al Auth Service...');
                response = await fetch(`${API_CONFIG.AUTH_SERVICE_URL}/auth/users`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.users) {
                allUsers = data.users;
                filteredUsers = [...allUsers];
                displayUsersData();
                updateStatistics();
                showMessage('Usuarios cargados exitosamente', 'success');
            } else {
                throw new Error('No se pudieron obtener los usuarios');
            }

        } catch (error) {
            console.error('‚ùå Error obteniendo usuarios:', error);

            // Mostrar datos de ejemplo en caso de error
            allUsers = getExampleUsers();
            filteredUsers = [...allUsers];
            displayUsersData();
            updateStatistics();
            showMessage('Usando datos de ejemplo - Error de conexi√≥n', 'warning');
        }
    }

    function getExampleUsers() {
        return [
            {
                id: '1',
                first_name: 'Admin',
                last_name: 'Sistema',
                email: 'admin@veterinariaclinic.com',
                role: 'admin',
                is_active: true,
                phone: '+57 300 123 4567',
                address: 'Calle Principal 123',
                created_at: new Date().toISOString()
            },
            {
                id: '2',
                first_name: 'Dr. Juan',
                last_name: 'P√©rez',
                email: 'vet@veterinariaclinic.com',
                role: 'veterinarian',
                is_active: true,
                phone: '+57 300 234 5678',
                address: 'Carrera 15 #45-67',
                created_at: new Date(Date.now() - 86400000).toISOString()
            },
            {
                id: '3',
                first_name: 'Mar√≠a',
                last_name: 'Garc√≠a',
                email: 'recepcion@veterinariaclinic.com',
                role: 'receptionist',
                is_active: true,
                phone: '+57 300 345 6789',
                address: 'Avenida Central 89',
                created_at: new Date(Date.now() - 172800000).toISOString()
            },
            {
                id: '4',
                first_name: 'Carlos',
                last_name: 'L√≥pez',
                email: 'cliente@example.com',
                role: 'client',
                is_active: false,
                phone: '+57 300 456 7890',
                address: 'Calle Secundaria 456',
                created_at: new Date(Date.now() - 259200000).toISOString()
            },
            {
                id: '5',
                first_name: 'Ana',
                last_name: 'Mart√≠nez',
                email: 'auxiliar@veterinariaclinic.com',
                role: 'auxiliary',
                is_active: true,
                phone: '+57 300 567 8901',
                address: 'Plaza Mayor 12',
                created_at: new Date(Date.now() - 345600000).toISOString()
            }
        ];
    }

    // =============== ACTUALIZACI√ìN DE ESTAD√çSTICAS ===============
    function updateStatistics() {
        const totalUsers = allUsers.length;
        const veterinarians = allUsers.filter(u => u.role === 'veterinarian').length;
        const clients = allUsers.filter(u => u.role === 'client').length;
        const activeUsers = allUsers.filter(u => u.is_active === true).length;

        document.getElementById('usersTotal').textContent = totalUsers;
        document.getElementById('usersVets').textContent = veterinarians;
        document.getElementById('usersClients').textContent = clients;
        document.getElementById('usersActive').textContent = activeUsers;
    }

    // =============== MOSTRAR DATOS EN TABLA ===============
    function displayUsersData() {
        const container = document.getElementById('usersTableContainer');
        const resultsInfo = document.getElementById('resultsInfo');

        // Actualizar informaci√≥n de resultados
        resultsInfo.textContent = `Mostrando ${filteredUsers.length} de ${allUsers.length} usuarios`;

        if (filteredUsers.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>üë• No se encontraron usuarios</h3>
                    <p>No hay usuarios que coincidan con los filtros aplicados.</p>
                    <button onclick="resetFilters()" class="btn-primary">
                        üîÑ Limpiar Filtros
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Tel√©fono</th>
                        <th>Fecha Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredUsers.map(user => `
                        <tr>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        ${(user.first_name || 'U').charAt(0).toUpperCase()}
                                    </div>
                                    <div class="user-details">
                                        <div class="user-name">${user.first_name || ''} ${user.last_name || ''}</div>
                                        <div class="user-email">${user.email || 'Sin email'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="role-badge ${user.role}">
                                    ${getRoleIcon(user.role)} ${getRoleLabel(user.role)}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                                    ${user.is_active ? '‚úÖ Activo' : '‚ùå Inactivo'}
                                </span>
                            </td>
                            <td style="color: #52B788;">
                                ${user.phone || 'Sin tel√©fono'}
                            </td>
                            <td style="color: #52B788;">
                                ${formatDate(user.created_at)}
                            </td>
                            <td>
                                <div class="actions-group">
                                    <button onclick="viewUser('${user.id}')" class="action-btn view" title="Ver detalles">
                                        üëÅÔ∏è Ver
                                    </button>
                                    <button onclick="editUser('${user.id}')" class="action-btn edit" title="Editar">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button onclick="toggleUserStatus('${user.id}')"
                                            class="action-btn ${user.is_active ? 'toggle' : 'activate'}"
                                            title="${user.is_active ? 'Desactivar' : 'Activar'}">
                                        ${user.is_active ? 'üö´ Desactivar' : '‚úÖ Activar'}
                                    </button>
                                    <button onclick="deleteUser('${user.id}')" class="action-btn delete" title="Eliminar definitivamente">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    // =============== FILTROS Y B√öSQUEDA ===============
    function filterUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const roleFilter = document.getElementById('roleFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        filteredUsers = allUsers.filter(user => {
            // Filtro de b√∫squeda
            const matchesSearch = !searchTerm ||
                (user.first_name && user.first_name.toLowerCase().includes(searchTerm)) ||
                (user.last_name && user.last_name.toLowerCase().includes(searchTerm)) ||
                (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                (user.phone && user.phone.toLowerCase().includes(searchTerm));

            // Filtro de rol
            const matchesRole = !roleFilter || user.role === roleFilter;

            // Filtro de estado
            const matchesStatus = !statusFilter ||
                (statusFilter === 'true' && user.is_active === true) ||
                (statusFilter === 'false' && user.is_active === false);

            return matchesSearch && matchesRole && matchesStatus;
        });

        displayUsersData();
    }

    function sortUsers() {
        const sortBy = document.getElementById('sortBy').value;

        filteredUsers.sort((a, b) => {
            switch (sortBy) {
                case 'name':
                    return (a.first_name || '').localeCompare(b.first_name || '');
                case 'name_desc':
                    return (b.first_name || '').localeCompare(a.first_name || '');
                case 'email':
                    return (a.email || '').localeCompare(b.email || '');
                case 'role':
                    return (a.role || '').localeCompare(b.role || '');
                case 'created_at':
                    return new Date(a.created_at) - new Date(b.created_at);
                case 'created_at_desc':
                    return new Date(b.created_at) - new Date(a.created_at);
                default:
                    return 0;
            }
        });

        displayUsersData();
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('roleFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('sortBy').value = 'name';

        filteredUsers = [...allUsers];
        displayUsersData();
        showMessage('Filtros restablecidos', 'info');
    }

    // =============== MODAL DE USUARIO ===============
    function openUserModal(userId = null) {
        const modal = document.getElementById('userModal');
        const form = document.getElementById('userForm');

        // Reset form
        form.reset();
        document.getElementById('userId').value = '';
        currentEditingUser = null;

        if (userId) {
            // Modo edici√≥n
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                showMessage('Usuario no encontrado', 'error');
                return;
            }

            currentEditingUser = user;

            // Llenar formulario
            document.getElementById('firstName').value = user.first_name || '';
            document.getElementById('lastName').value = user.last_name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('role').value = user.role || '';
            document.getElementById('status').value = user.is_active.toString();
            document.getElementById('address').value = user.address || '';
            document.getElementById('userId').value = user.id;

            // Actualizar UI del modal
            document.getElementById('modalIcon').textContent = '‚úèÔ∏è';
            document.getElementById('modalTitleText').textContent = 'Editar Usuario';
            document.getElementById('modalSubtitle').textContent = `Modificando: ${user.first_name} ${user.last_name}`;
            document.getElementById('saveBtnIcon').textContent = 'üíæ';
            document.getElementById('saveBtnText').textContent = 'Actualizar Usuario';

            // Ocultar campos de contrase√±a en edici√≥n
            document.getElementById('passwordRow').style.display = 'none';
            document.getElementById('password').required = false;
            document.getElementById('confirmPassword').required = false;
        } else {
            // Modo creaci√≥n
            document.getElementById('modalIcon').textContent = '‚ûï';
            document.getElementById('modalTitleText').textContent = 'Nuevo Usuario';
            document.getElementById('modalSubtitle').textContent = 'Completa la informaci√≥n del usuario';
            document.getElementById('saveBtnIcon').textContent = 'üíæ';
            document.getElementById('saveBtnText').textContent = 'Crear Usuario';

            // Mostrar campos de contrase√±a en creaci√≥n
            document.getElementById('passwordRow').style.display = 'grid';
            document.getElementById('password').required = true;
            document.getElementById('confirmPassword').required = true;
        }

        modal.classList.add('active');
    }

    function closeUserModal() {
        const modal = document.getElementById('userModal');
        modal.classList.remove('active');
        currentEditingUser = null;
    }

    // =============== GUARDAR USUARIO ===============
    async function saveUser() {
        const form = document.getElementById('userForm');
        const saveBtn = document.getElementById('saveBtn');

        // Validar formulario
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Validar contrase√±as si es necesario
        if (!currentEditingUser) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('Las contrase√±as no coinciden', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }
        }

        // Recopilar datos
        const userData = {
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            role: document.getElementById('role').value,
            is_active: document.getElementById('status').value === 'true',
            address: document.getElementById('address').value
        };

        if (!currentEditingUser) {
            userData.password = document.getElementById('password').value;
        }

        // Deshabilitar bot√≥n
        saveBtn.disabled = true;
        document.getElementById('saveBtnText').textContent = 'Guardando...';

        try {
            let response;

            if (currentEditingUser) {
                // Actualizar usuario existente - usar endpoint del frontend
                response = await fetch(`/api/admin/users/${currentEditingUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });
            } else {
                // Crear nuevo usuario - usar endpoint del frontend
                response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });
            }

            if (response.ok) {
                const data = await response.json();

                if (data.success) {
                    showMessage(
                        currentEditingUser ? 'Usuario actualizado exitosamente' : 'Usuario creado exitosamente',
                        'success'
                    );
                    closeUserModal();
                    loadUsersData(); // Recargar datos
                } else {
                    throw new Error(data.message || 'Error al guardar usuario');
                }
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP ${response.status}`);
            }

        } catch (error) {
            console.error('‚ùå Error guardando usuario:', error);
            showMessage('Error al guardar usuario: ' + error.message, 'error');
        } finally {
            // Rehabilitar bot√≥n
            saveBtn.disabled = false;
            document.getElementById('saveBtnText').textContent =
                currentEditingUser ? 'Actualizar Usuario' : 'Crear Usuario';
        }
    }

    // =============== ACCIONES DE USUARIO ===============
    function viewUser(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) {
            showMessage('Usuario no encontrado', 'error');
            return;
        }

        // Crear modal de visualizaci√≥n
        showUserDetailsModal(user);
    }

    function showUserDetailsModal(user) {
        // Crear modal din√°micamente
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.id = 'userDetailsModal';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <button class="modal-close" onclick="closeUserDetailsModal()">‚úñ</button>
                <div class="modal-header">
                    <h2 class="modal-title">
                        <span>üë§</span>
                        Detalles del Usuario
                    </h2>
                    <p class="modal-subtitle">${user.first_name} ${user.last_name}</p>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 20px;">
                        <div class="user-detail-row">
                            <div class="user-avatar" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 20px;">
                                ${(user.first_name || 'U').charAt(0).toUpperCase()}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">üìß Email</label>
                                <div style="padding: 12px; background: #D8F3DC; border-radius: 8px; color: #2D6A4F;">
                                    ${user.email || 'No especificado'}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üìû Tel√©fono</label>
                                <div style="padding: 12px; background: #D8F3DC; border-radius: 8px; color: #2D6A4F;">
                                    ${user.phone || 'No especificado'}
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">üë§ Rol</label>
                                <div style="padding: 12px; background: #D8F3DC; border-radius: 8px;">
                                    <span class="role-badge ${user.role}">
                                        ${getRoleIcon(user.role)} ${getRoleLabel(user.role)}
                                    </span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‚úÖ Estado</label>
                                <div style="padding: 12px; background: #D8F3DC; border-radius: 8px;">
                                    <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                                        ${user.is_active ? '‚úÖ Activo' : '‚ùå Inactivo'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">üè† Direcci√≥n</label>
                                <div style="padding: 12px; background: #D8F3DC; border-radius: 8px; color: #2D6A4F;">
                                    ${user.address || 'No especificada'}
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">üìÖ Fecha de Registro</label>
                                <div style="padding: 12px; background: #D8F3DC; border-radius: 8px; color: #2D6A4F;">
                                    ${formatDateTime(user.created_at)}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üîÑ √öltima Actualizaci√≥n</label>
                                <div style="padding: 12px; background: #D8F3DC; border-radius: 8px; color: #2D6A4F;">
                                    ${formatDateTime(user.updated_at || user.created_at)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeUserDetailsModal()" class="btn-cancel">
                        Cerrar
                    </button>
                    <button type="button" onclick="editUserFromDetails('${user.id}')" class="btn-primary">
                        ‚úèÔ∏è Editar Usuario
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    function closeUserDetailsModal() {
        const modal = document.getElementById('userDetailsModal');
        if (modal) {
            modal.remove();
        }
    }

    function editUserFromDetails(userId) {
        closeUserDetailsModal();
        editUser(userId);
    }

    function editUser(userId) {
        openUserModal(userId);
    }

    function deleteUser(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) {
            showMessage('Usuario no encontrado', 'error');
            return;
        }

        // Verificar si es el usuario actual
        if (isCurrentUser(userId)) {
            showMessage('No puedes eliminar tu propia cuenta', 'error');
            return;
        }

        // Mostrar modal de confirmaci√≥n especial para eliminaci√≥n
        showDeleteConfirmModal(user);
    }

    function showDeleteConfirmModal(user) {
        // Crear modal din√°micamente con advertencias especiales
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.id = 'deleteConfirmModal';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 550px;">
                <button class="modal-close" onclick="closeDeleteConfirmModal()">‚úñ</button>
                <div class="modal-header">
                    <h2 class="modal-title" style="color: #dc3545;">
                        <span>üóëÔ∏è</span>
                        Eliminar Usuario Definitivamente
                    </h2>
                    <p class="modal-subtitle" style="color: #dc3545;">Esta acci√≥n NO se puede deshacer</p>
                </div>
                <div class="modal-body">
                    <div style="background: #ffebee; border: 2px solid #f5c6cb; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 2rem;">‚ö†Ô∏è</span>
                            <div>
                                <h4 style="color: #721c24; margin: 0; font-size: 1.1rem;">ADVERTENCIA IMPORTANTE</h4>
                                <p style="color: #721c24; margin: 5px 0 0 0; font-weight: 600;">Esta acci√≥n eliminar√° permanentemente todos los datos</p>
                            </div>
                        </div>
                        <ul style="color: #721c24; margin: 0; padding-left: 20px;">
                            <li>Se eliminar√°n TODOS los registros del usuario</li>
                            <li>Se perder√°n las historias cl√≠nicas asociadas</li>
                            <li>Se eliminar√°n las citas programadas</li>
                            <li>Esta acci√≥n es IRREVERSIBLE</li>
                        </ul>
                    </div>

                    <div style="background: #D8F3DC; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #2D6A4F; margin: 0 0 15px 0;">Usuario a eliminar:</h4>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px 15px; align-items: center;">
                            <strong style="color: #2D6A4F;">üë§ Nombre:</strong>
                            <span style="color: #52B788;">${user.first_name} ${user.last_name}</span>

                            <strong style="color: #2D6A4F;">üìß Email:</strong>
                            <span style="color: #52B788;">${user.email}</span>

                            <strong style="color: #2D6A4F;">üë§ Rol:</strong>
                            <span class="role-badge ${user.role}" style="font-size: 0.8rem;">
                                ${getRoleIcon(user.role)} ${getRoleLabel(user.role)}
                            </span>

                            <strong style="color: #2D6A4F;">üìÖ Registro:</strong>
                            <span style="color: #52B788;">${formatDate(user.created_at)}</span>
                        </div>
                    </div>

                    <div style="background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 10px; padding: 15px;">
                        <p style="margin: 0; color: #856404; font-weight: 600;">
                            üí° <strong>Alternativa recomendada:</strong>
                            Considera <strong>desactivar</strong> el usuario en lugar de eliminarlo.
                            Esto mantendr√° los registros hist√≥ricos pero impedir√° el acceso al sistema.
                        </p>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeDeleteConfirmModal()" class="btn-cancel">
                        ‚ùå Cancelar
                    </button>
                    <button type="button" onclick="confirmUserDeletion('${user.id}')"
                            style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                        üóëÔ∏è S√≠, Eliminar Definitivamente
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    function closeDeleteConfirmModal() {
        const modal = document.getElementById('deleteConfirmModal');
        if (modal) {
            modal.remove();
        }
    }

    async function confirmUserDeletion(userId) {
        try {
            closeDeleteConfirmModal();

            // Mostrar loading
            showMessage('Eliminando usuario...', 'info');

            // Llamar al endpoint de eliminaci√≥n
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();

                if (data.success) {
                    // Remover usuario de la lista local
                    allUsers = allUsers.filter(u => u.id !== userId);
                    filteredUsers = filteredUsers.filter(u => u.id !== userId);

                    displayUsersData();
                    updateStatistics();

                    showMessage('Usuario eliminado definitivamente del sistema', 'success');
                } else {
                    throw new Error(data.message || 'Error al eliminar usuario');
                }
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP ${response.status}`);
            }

        } catch (error) {
            console.error('‚ùå Error eliminando usuario:', error);
            showMessage('Error al eliminar usuario: ' + error.message, 'error');
        }
    }

    // üîß REEMPLAZA la funci√≥n isCurrentUser y todo el c√≥digo suelto con esto:

function isCurrentUser(userId) {
    // Esta funci√≥n deber√≠a verificar si el userId corresponde al usuario actual
    // Por ahora, implementamos una verificaci√≥n b√°sica
    try {
        // Podr√≠as obtener el usuario actual desde la API o sesi√≥n
        return false; // Por seguridad, por defecto permitir eliminaci√≥n
    } catch {
        return false;
    }
}

function toggleUserStatus(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) {
        showMessage('Usuario no encontrado', 'error');
        return;
    }

    const action = user.is_active ? 'desactivar' : 'activar';
    const actionIcon = user.is_active ? 'üö´' : '‚úÖ';

    showConfirmModal(
        `${actionIcon} Confirmar ${action}`,
        `¬øEst√°s seguro de ${action} al usuario ${user.first_name} ${user.last_name}?`,
        () => executeToggleUserStatus(userId),
        user.is_active ? 'toggle' : 'activate'
    );
}

async function executeToggleUserStatus(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;

    try {
        // Usar endpoint del frontend para cambiar estado
        const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();

            if (data.success) {
                // Actualizar usuario en la lista local
                user.is_active = !user.is_active;

                displayUsersData();
                updateStatistics();

                showMessage(
                    `Usuario ${user.is_active ? 'activado' : 'desactivado'} exitosamente`,
                    'success'
                );
            } else {
                throw new Error(data.message || 'Error al cambiar estado');
            }
        } else {
            const errorData = await response.json();
            throw new Error(errorData.message || `HTTP ${response.status}`);
        }

    } catch (error) {
        console.error('‚ùå Error toggling user status:', error);
        showMessage('Error al cambiar estado del usuario: ' + error.message, 'error');
    }
}



    // =============== MODAL DE CONFIRMACI√ìN ===============
    function showConfirmModal(title, message, onConfirm, actionType = 'confirm') {
        const modal = document.getElementById('confirmModal');

        document.getElementById('confirmIcon').textContent =
            actionType === 'toggle' ? 'üö´' : actionType === 'activate' ? '‚úÖ' : '‚ùì';
        document.getElementById('confirmTitle').innerHTML =
            `<span id="confirmIcon">${document.getElementById('confirmIcon').textContent}</span> ${title}`;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmBtnText').textContent =
            actionType === 'toggle' ? 'Desactivar' : actionType === 'activate' ? 'Activar' : 'Confirmar';

        confirmAction = onConfirm;
        modal.classList.add('active');
    }

    function closeConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.classList.remove('active');
        confirmAction = null;
    }

    function executeConfirmAction() {
        if (confirmAction) {
            confirmAction();
            closeConfirmModal();
        }
    }

    // =============== EXPORTAR DATOS ===============
    function exportUsers(format) {
        try {
            if (format === 'excel') {
                exportToExcel();
            } else if (format === 'pdf') {
                exportToPDF();
            }
        } catch (error) {
            console.error('‚ùå Error exportando:', error);
            showMessage('Error al exportar datos', 'error');
        }
    }

    function exportToExcel() {
        try {
            // Preparar datos para Excel/CSV
            const data = filteredUsers.map(user => ({
                'Nombre': `${user.first_name} ${user.last_name}`,
                'Email': user.email,
                'Tel√©fono': user.phone || '',
                'Rol': getRoleLabel(user.role),
                'Estado': user.is_active ? 'Activo' : 'Inactivo',
                'Direcci√≥n': user.address || '',
                'Fecha Registro': formatDate(user.created_at)
            }));

            // Convertir a CSV
            const csv = convertToCSV(data);
            const filename = `usuarios_${new Date().toISOString().slice(0, 10)}.csv`;
            downloadFile(csv, filename, 'text/csv');
            showMessage('Archivo CSV descargado exitosamente', 'success');
        } catch (error) {
            console.error('‚ùå Error exportando a Excel:', error);
            showMessage('Error al exportar a Excel', 'error');
        }
    }

    function exportToPDF() {
        try {
            // Crear contenido HTML para PDF
            const htmlContent = generatePDFContent();

            // Crear ventana nueva para impresi√≥n/PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();

            // Configurar para imprimir como PDF
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            };

            showMessage('Generaci√≥n de PDF iniciada - Use "Guardar como PDF" en el di√°logo de impresi√≥n', 'info');
        } catch (error) {
            console.error('‚ùå Error exportando a PDF:', error);
            showMessage('Error al generar PDF', 'error');
        }
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';

        const headers = Object.keys(data[0]);
        const csvContent = [
            // Encabezados
            headers.join(','),
            // Datos con comillas para manejar caracteres especiales
            ...data.map(row =>
                headers.map(header => {
                    const value = row[header] || '';
                    // Escapar comillas dobles y envolver en comillas si contiene comas
                    const escapedValue = String(value).replace(/"/g, '""');
                    return value.includes(',') || value.includes('"') || value.includes('\n')
                        ? `"${escapedValue}"`
                        : escapedValue;
                }).join(',')
            )
        ].join('\n');

        return csvContent;
    }

    function downloadFile(content, filename, mimeType) {
        try {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            console.error('‚ùå Error descargando archivo:', error);
            throw error;
        }
    }

    function generatePDFContent() {
        const currentDate = new Date().toLocaleString('es-CO');
        const totalUsers = filteredUsers.length;

        // Generar filas de la tabla
        const tableRows = filteredUsers.map(user => `
            <tr>
                <td>${user.first_name} ${user.last_name}</td>
                <td>${user.email}</td>
                <td>${user.phone || 'N/A'}</td>
                <td>${getRoleLabel(user.role)}</td>
                <td>${user.is_active ? 'Activo' : 'Inactivo'}</td>
                <td>${formatDate(user.created_at)}</td>
            </tr>
        `).join('');

        // Calcular estad√≠sticas
        const stats = {
            total: totalUsers,
            active: filteredUsers.filter(u => u.is_active).length,
            inactive: filteredUsers.filter(u => !u.is_active).length,
            admin: filteredUsers.filter(u => u.role === 'admin').length,
            veterinarian: filteredUsers.filter(u => u.role === 'veterinarian').length,
            receptionist: filteredUsers.filter(u => u.role === 'receptionist').length,
            auxiliary: filteredUsers.filter(u => u.role === 'auxiliary').length,
            client: filteredUsers.filter(u => u.role === 'client').length
        };

        return `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Usuarios - Cl√≠nica Veterinaria</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: white;
            color: #2D6A4F;
            line-height: 1.4;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #52B788;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #2D6A4F;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header h2 {
            color: #52B788;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header p {
            color: #22577A;
            font-size: 1rem;
            margin: 5px 0;
        }

        .stats-section {
            margin: 30px 0;
            padding: 20px;
            background: #D8F3DC;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #52B788;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2D6A4F;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #52B788;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .table-container {
            margin: 30px 0;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        th {
            background: #52B788;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #38A3A5;
        }

        td {
            padding: 10px 8px;
            border: 1px solid #B7E4C7;
            vertical-align: top;
        }

        tr:nth-child(even) {
            background: #D8F3DC;
        }

        tr:nth-child(odd) {
            background: white;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #B7E4C7;
            text-align: center;
            color: #22577A;
            font-size: 0.9rem;
        }

        @media print {
            body { margin: 0; }
            .header h1 { font-size: 2rem; }
            .header h2 { font-size: 1.2rem; }
            table { font-size: 0.8rem; }
            th, td { padding: 8px 6px; }
        }

        @page {
            margin: 1cm;
            size: A4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêæ Cl√≠nica Veterinaria</h1>
        <h2>Reporte de Usuarios y Roles</h2>
        <p><strong>Fecha de generaci√≥n:</strong> ${currentDate}</p>
        <p><strong>Total de usuarios en el reporte:</strong> ${totalUsers}</p>
    </div>

    <div class="stats-section">
        <div class="stat-item">
            <div class="stat-value">${stats.total}</div>
            <div class="stat-label">Total Usuarios</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.active}</div>
            <div class="stat-label">Usuarios Activos</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.veterinarian}</div>
            <div class="stat-label">Veterinarios</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.client}</div>
            <div class="stat-label">Clientes</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.receptionist}</div>
            <div class="stat-label">Recepcionistas</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.auxiliary}</div>
            <div class="stat-label">Auxiliares</div>
        </div>
    </div>

    <div class="table-container">
        <h3 style="color: #2D6A4F; margin-bottom: 15px;">üìã Detalle de Usuarios</h3>
        <table>
            <thead>
                <tr>
                    <th>Nombre Completo</th>
                    <th>Email</th>
                    <th>Tel√©fono</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Fecha Registro</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
    </div>

    <div class="footer">
        <p><strong>Cl√≠nica Veterinaria Universitaria Alexander Von Humboldt</strong></p>
        <p>Sistema de Gesti√≥n de Usuarios - Reporte generado autom√°ticamente</p>
        <p>Este documento contiene informaci√≥n confidencial del sistema</p>
    </div>
</body>
</html>
        `.trim();
    }

    // =============== FUNCIONES AUXILIARES ===============
    function getRoleIcon(role) {
        const icons = {
            admin: 'üëë',
            veterinarian: 'üë®‚Äç‚öïÔ∏è',
            receptionist: 'üë©‚Äçüíº',
            auxiliary: 'üë©‚Äçüî¨',
            client: 'üë§'
        };
        return icons[role] || 'üë§';
    }

    function getRoleLabel(role) {
        const labels = {
            admin: 'Administrador',
            veterinarian: 'Veterinario',
            receptionist: 'Recepcionista',
            auxiliary: 'Auxiliar',
            client: 'Cliente'
        };
        return labels[role] || 'Cliente';
    }

    // =============== CERRAR MODALES AL HACER CLIC FUERA ===============
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            closeUserModal();
            closeConfirmModal();
        }
    });

    // =============== TECLAS DE ACCESO R√ÅPIDO ===============
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeUserModal();
            closeConfirmModal();
        }

        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            openUserModal();
        }
    });

    console.log('‚úÖ Gesti√≥n de Usuarios inicializada correctamente');
</script>
{% endblock %}