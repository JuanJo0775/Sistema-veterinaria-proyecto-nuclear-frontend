{% extends "admin/admin_base.html" %}

{% block title %}Gesti√≥n de Citas{% endblock %}

{% block page_title %}Gesti√≥n de Citas{% endblock %}

{% block custom_styles %}
<style>
    /* =============== APPOINTMENTS MANAGEMENT SPECIFIC STYLES =============== */
    .appointments-content {
        padding: 30px;
    }

    .page-header {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        margin-bottom: 30px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .header-info h1 {
        color: #2D6A4F;
        font-size: 2.2rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-info p {
        color: #52B788;
        font-size: 1.1rem;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 15px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(82, 183, 136, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #B7E4C7 0%, #D8F3DC 100%);
        color: #2D6A4F;
        border: 2px solid #B7E4C7;
        padding: 10px 22px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-secondary:hover {
        background: #B7E4C7;
        transform: translateY(-2px);
    }

    /* ESTAD√çSTICAS */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .stat-item {
        background: white;
        padding: 25px;
        border-radius: 15px;
        border: 1px solid #D8F3DC;
        display: flex;
        align-items: center;
        gap: 20px;
        border-left: 4px solid;
        transition: transform 0.3s ease;
    }

    .stat-item:hover {
        transform: translateY(-3px);
    }

    .stat-item.total { border-left-color: #52B788; }
    .stat-item.today { border-left-color: #38A3A5; }
    .stat-item.scheduled { border-left-color: #22577A; }
    .stat-item.completed { border-left-color: #2D6A4F; }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .stat-icon.total { background: linear-gradient(135deg, #52B788, #38A3A5); }
    .stat-icon.today { background: linear-gradient(135deg, #38A3A5, #22577A); }
    .stat-icon.scheduled { background: linear-gradient(135deg, #22577A, #2D6A4F); }
    .stat-icon.completed { background: linear-gradient(135deg, #2D6A4F, #081C15); }

    .stat-data {
        flex: 1;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2D6A4F;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #52B788;
        font-size: 0.95rem;
        font-weight: 500;
    }

    /* FILTROS Y CONTROLES */
    .controls-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        margin-bottom: 30px;
    }

    .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .controls-title {
        color: #2D6A4F;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
    }

    .controls-grid {
        display: grid;
        grid-template-columns: 2fr 200px 200px 150px 150px 150px;
        gap: 20px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        color: #2D6A4F;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .form-input,
    .form-select {
        padding: 12px 15px;
        border: 2px solid #D8F3DC;
        border-radius: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
        color: #2D6A4F;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .search-input {
        background: #D8F3DC;
        border: 2px solid transparent;
    }

    .search-input:focus {
        background: white;
        border-color: #52B788;
    }

    /* VISTA DE CALENDARIO */
    .view-toggle {
        display: flex;
        gap: 10px;
        margin-left: auto;
    }

    .view-btn {
        padding: 8px 16px;
        border: 2px solid #B7E4C7;
        background: white;
        color: #2D6A4F;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .view-btn.active {
        background: #52B788;
        color: white;
        border-color: #52B788;
    }

    .view-btn:hover {
        background: #B7E4C7;
        transform: translateY(-1px);
    }

    /* TABLA DE CITAS */
    .appointments-table-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        overflow: hidden;
    }

    .table-header {
        padding: 25px;
        border-bottom: 1px solid #D8F3DC;
        background: linear-gradient(135deg, #F8FBF9 0%, #F0F8F0 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        color: #2D6A4F;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .results-info {
        color: #52B788;
        font-size: 0.9rem;
    }

    .table-container {
        overflow-x: auto;
    }

    .appointments-table {
        width: 100%;
        border-collapse: collapse;
    }

    .appointments-table th {
        background: #D8F3DC;
        padding: 18px 20px;
        text-align: left;
        font-weight: 600;
        color: #2D6A4F;
        border-bottom: 2px solid #B7E4C7;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .appointments-table td {
        padding: 18px 20px;
        border-bottom: 1px solid #D8F3DC;
        vertical-align: middle;
    }

    .appointments-table tr {
        transition: all 0.2s ease;
    }

    .appointments-table tr:hover {
        background: rgba(183, 228, 199, 0.15);
    }

    .appointment-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .appointment-avatar {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #52B788, #38A3A5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.2rem;
        border: 3px solid #B7E4C7;
    }

    .appointment-details {
        flex: 1;
    }

    .appointment-date {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
        font-size: 1rem;
    }

    .appointment-time {
        color: #52B788;
        font-size: 0.85rem;
    }

    .client-info {
        display: flex;
        flex-direction: column;
    }

    .client-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
    }

    .client-contact {
        color: #52B788;
        font-size: 0.85rem;
    }

    .pet-info {
        display: flex;
        flex-direction: column;
    }

    .pet-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
    }

    .pet-species {
        color: #52B788;
        font-size: 0.85rem;
    }

    .vet-info {
        display: flex;
        flex-direction: column;
    }

    .vet-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
    }

    .vet-specialty {
        color: #52B788;
        font-size: 0.85rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
    }

    .status-badge.scheduled { background: linear-gradient(135deg, #22577A, #38A3A5); }
    .status-badge.confirmed { background: linear-gradient(135deg, #52B788, #38A3A5); }
    .status-badge.completed { background: linear-gradient(135deg, #2D6A4F, #52B788); }
    .status-badge.cancelled { background: linear-gradient(135deg, #6c757d, #495057); }

    .actions-group {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .action-btn.view {
        background: #22577A;
        color: white;
    }

    .action-btn.edit {
        background: #52B788;
        color: white;
    }

    .action-btn.confirm {
        background: #38A3A5;
        color: white;
    }

    .action-btn.complete {
        background: #2D6A4F;
        color: white;
    }

    .action-btn.cancel {
        background: #6c757d;
        color: white;
    }

    .action-btn.delete {
        background: #dc3545;
        color: white;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* VISTA DE CALENDARIO */
    .calendar-view {
        display: none;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        padding: 30px;
    }

    .calendar-view.active {
        display: block;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .calendar-navigation {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .nav-btn {
        background: #52B788;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }

    .nav-btn:hover {
        background: #2D6A4F;
        transform: scale(1.1);
    }

    .calendar-month {
        font-size: 1.6rem;
        font-weight: 700;
        color: #2D6A4F;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #D8F3DC;
        border-radius: 15px;
        overflow: hidden;
    }

    .calendar-day-header {
        background: #52B788;
        color: white;
        text-align: center;
        padding: 15px 5px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .calendar-day {
        background: white;
        min-height: 120px;
        padding: 10px;
        position: relative;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .calendar-day:hover {
        background: #F8FBF9;
    }

    .calendar-day.other-month {
        background: #f8f9fa;
        color: #6c757d;
    }

    .calendar-day.today {
        background: linear-gradient(135deg, #B7E4C7, #D8F3DC);
    }

    .day-number {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 5px;
    }

    .day-appointments {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .day-appointment {
        background: #52B788;
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .day-appointment:hover {
        background: #2D6A4F;
        transform: scale(1.05);
    }

    .day-appointment.confirmed {
        background: #38A3A5;
    }

    .day-appointment.completed {
        background: #2D6A4F;
    }

    .day-appointment.cancelled {
        background: #6c757d;
    }

    /* MODAL STYLES */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(8, 28, 21, 0.8);
        backdrop-filter: blur(5px);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(8, 28, 21, 0.3);
        animation: modalSlideIn 0.3s ease;
        position: relative;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        padding: 25px 30px 0;
        border-bottom: 1px solid #D8F3DC;
        margin-bottom: 25px;
    }

    .modal-title {
        color: #2D6A4F;
        font-size: 1.6rem;
        font-weight: 600;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-subtitle {
        color: #52B788;
        font-size: 1rem;
        margin: 0 0 20px 0;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 25px;
        background: none;
        border: none;
        font-size: 24px;
        color: #52B788;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #D8F3DC;
        color: #2D6A4F;
    }

    .modal-body {
        padding: 0 30px 30px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row.full {
        grid-template-columns: 1fr;
    }

    .form-row.thirds {
        grid-template-columns: 1fr 1fr 1fr;
    }

    .form-textarea {
        padding: 12px 15px;
        border: 2px solid #D8F3DC;
        border-radius: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
        color: #2D6A4F;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .modal-actions {
        padding: 20px 30px;
        border-top: 1px solid #D8F3DC;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        background: #F8FBF9;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .btn-cancel:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .btn-save {
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(82, 183, 136, 0.3);
    }

    .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* MODAL DE DETALLES */
    .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-item {
        background: #F8FBF9;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #52B788;
    }

    .detail-label {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .detail-value {
        color: #52B788;
        font-size: 1rem;
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #52B788;
    }

    .empty-state h3 {
        color: #2D6A4F;
        margin-bottom: 15px;
        font-size: 1.4rem;
    }

    .empty-state p {
        margin-bottom: 25px;
        font-size: 1rem;
    }

    /* LOADING STATE */
    .table-loading {
        text-align: center;
        padding: 40px;
        color: #52B788;
    }

    .table-loading .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #D8F3DC;
        border-top: 4px solid #52B788;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* VALIDACI√ìN VISUAL */
    .form-input.error,
    .form-select.error {
        border-color: #dc3545;
        box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.1);
    }

    .form-input.success,
    .form-select.success {
        border-color: #52B788;
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .error-message {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 5px;
    }

    .success-message {
        color: #52B788;
        font-size: 0.8rem;
        margin-top: 5px;
    }

    /* HORARIOS DISPONIBLES */
    .available-slots {
        background: #D8F3DC;
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
    }

    .slot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .time-slot {
        background: white;
        border: 2px solid #B7E4C7;
        padding: 8px 12px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        color: #2D6A4F;
    }

    .time-slot:hover {
        background: #B7E4C7;
        transform: translateY(-2px);
    }

    .time-slot.selected {
        background: #52B788;
        color: white;
        border-color: #52B788;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
        .controls-grid {
            grid-template-columns: 2fr 180px 180px 120px;
        }
    }

    @media (max-width: 768px) {
        .appointments-content {
            padding: 20px 15px;
        }

        .header-content {
            flex-direction: column;
            gap: 20px;
            align-items: stretch;
        }

        .header-actions {
            justify-content: center;
        }

        .stats-row {
            grid-template-columns: 1fr;
        }

        .controls-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-row.thirds {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            margin: 20px;
        }

        .appointments-table {
            font-size: 0.85rem;
        }

        .appointments-table th,
        .appointments-table td {
            padding: 12px 10px;
        }

        .actions-group {
            flex-direction: column;
            gap: 4px;
        }

        .calendar-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
        }

        .calendar-day {
            min-height: 80px;
            padding: 5px;
        }

        .details-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="appointments-content">
    <!-- HEADER -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <h1>
                    <span>üìÖ</span>
                    Gesti√≥n de Citas
                </h1>
                <p>Administra las citas m√©dicas y horarios de la cl√≠nica</p>
            </div>
            <div class="header-actions">
                <button onclick="syncWithCalendar()" class="btn-secondary">
                    üîÑ Sincronizar
                </button>
                <button onclick="exportAppointments('pdf')" class="btn-secondary">
                    üìÑ Reporte PDF
                </button>
                <button onclick="exportAppointments('excel')" class="btn-secondary">
                    üìä Exportar Excel
                </button>
                <button onclick="openAppointmentModal()" class="btn-primary">
                    ‚ûï Nueva Cita
                </button>
            </div>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div class="stats-row">
            <div class="stat-item total">
                <div class="stat-icon total">üìÖ</div>
                <div class="stat-data">
                    <div class="stat-value" id="appointmentsTotal">-</div>
                    <div class="stat-label">Total Citas</div>
                </div>
            </div>
            <div class="stat-item today">
                <div class="stat-icon today">üïê</div>
                <div class="stat-data">
                    <div class="stat-value" id="appointmentsToday">-</div>
                    <div class="stat-label">Citas Hoy</div>
                </div>
            </div>
            <div class="stat-item scheduled">
                <div class="stat-icon scheduled">üìã</div>
                <div class="stat-data">
                    <div class="stat-value" id="appointmentsScheduled">-</div>
                    <div class="stat-label">Programadas</div>
                </div>
            </div>
            <div class="stat-item completed">
                <div class="stat-icon completed">‚úÖ</div>
                <div class="stat-data">
                    <div class="stat-value" id="appointmentsCompleted">-</div>
                    <div class="stat-label">Completadas</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLES Y FILTROS -->
    <div class="controls-section">
        <div class="controls-header">
            <h3 class="controls-title">üîç Filtros y Controles</h3>
            <div class="view-toggle">
                <button onclick="switchView('table')" class="view-btn active" id="tableViewBtn">
                    üìã Lista
                </button>
                <button onclick="switchView('calendar')" class="view-btn" id="calendarViewBtn">
                    üìÖ Calendario
                </button>
                <button onclick="resetFilters()" class="btn-secondary">
                    üîÑ Limpiar Filtros
                </button>
            </div>
        </div>
        <div class="controls-grid">
            <div class="form-group">
                <label for="searchInput" class="form-label">Buscar Cita</label>
                <input type="text" id="searchInput" class="form-input search-input"
                       placeholder="Cliente, mascota, veterinario..."
                       onkeyup="filterAppointments()">
            </div>
            <div class="form-group">
                <label for="dateFilter" class="form-label">Filtrar por Fecha</label>
                <input type="date" id="dateFilter" class="form-input" onchange="filterAppointments()">
            </div>
            <div class="form-group">
                <label for="vetFilter" class="form-label">Veterinario</label>
                <select id="vetFilter" class="form-select" onchange="filterAppointments()">
                    <option value="">Todos los veterinarios</option>
                    <!-- Se llenar√° din√°micamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="statusFilter" class="form-label">Estado</label>
                <select id="statusFilter" class="form-select" onchange="filterAppointments()">
                    <option value="">Todos los estados</option>
                    <option value="scheduled">üìã Programada</option>
                    <option value="confirmed">‚úÖ Confirmada</option>
                    <option value="completed">üèÅ Completada</option>
                    <option value="cancelled">‚ùå Cancelada</option>
                </select>
            </div>
            <div class="form-group">
                <label for="clientFilter" class="form-label">Cliente</label>
                <select id="clientFilter" class="form-select" onchange="filterAppointments()">
                    <option value="">Todos los clientes</option>
                    <!-- Se llenar√° din√°micamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="sortBy" class="form-label">Ordenar por</label>
                <select id="sortBy" class="form-select" onchange="sortAppointments()">
                    <option value="date_desc">M√°s recientes</option>
                    <option value="date_asc">M√°s antiguas</option>
                    <option value="time_asc">Hora (temprano)</option>
                    <option value="time_desc">Hora (tarde)</option>
                    <option value="client">Cliente A-Z</option>
                    <option value="status">Estado</option>
                </select>
            </div>
        </div>
    </div>

    <!-- VISTA DE TABLA -->
    <div class="appointments-table-section" id="tableView">
        <div class="table-header">
            <h3 class="table-title">
                üìÖ Lista de Citas
            </h3>
            <div class="results-info" id="resultsInfo">
                Cargando citas...
            </div>
        </div>
        <div class="table-container">
            <div id="appointmentsTableContainer">
                <div class="table-loading">
                    <div class="spinner"></div>
                    <span>Cargando citas desde el servidor...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA DE CALENDARIO -->
    <div class="calendar-view" id="calendarView">
        <div class="calendar-header">
            <div class="calendar-navigation">
                <button onclick="previousMonth()" class="nav-btn">‚Äπ</button>
                <div class="calendar-month" id="calendarMonth">Enero 2024</div>
                <button onclick="nextMonth()" class="nav-btn">‚Ä∫</button>
            </div>
            <button onclick="goToToday()" class="btn-secondary">
                üìÖ Hoy
            </button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- Se llenar√° din√°micamente -->
        </div>
    </div>
</div>

<!-- MODAL PARA CREAR/EDITAR CITA -->
<div class="modal" id="appointmentModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeAppointmentModal()">‚úñ</button>
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">
                <span id="modalIcon">üìÖ</span>
                <span id="modalTitleText">Nueva Cita</span>
            </h2>
            <p class="modal-subtitle" id="modalSubtitle">Programa una nueva cita m√©dica</p>
        </div>
        <div class="modal-body">
            <form id="appointmentForm">
                <input type="hidden" id="appointmentId">

                <!-- INFORMACI√ìN DEL CLIENTE Y MASCOTA -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientId" class="form-label">Cliente *</label>
                        <select id="clientId" name="client_id" class="form-select" required onchange="updateClientPets()">
                            <option value="">Seleccionar cliente</option>
                            <!-- Se llenar√° din√°micamente -->
                        </select>
                        <div class="error-message" id="clientIdError"></div>
                    </div>
                    <div class="form-group">
                        <label for="petId" class="form-label">Mascota *</label>
                        <select id="petId" name="pet_id" class="form-select" required>
                            <option value="">Primero selecciona un cliente</option>
                        </select>
                        <div class="error-message" id="petIdError"></div>
                    </div>
                </div>

                <!-- INFORMACI√ìN DEL VETERINARIO Y FECHA -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="veterinarianId" class="form-label">Veterinario *</label>
                        <select id="veterinarianId" name="veterinarian_id" class="form-select" required onchange="checkAvailableSlots()">
                            <option value="">Seleccionar veterinario</option>
                            <!-- Se llenar√° din√°micamente -->
                        </select>
                        <div class="error-message" id="veterinarianIdError"></div>
                    </div>
                    <div class="form-group">
                        <label for="appointmentDate" class="form-label">Fecha *</label>
                        <input type="date" id="appointmentDate" name="appointment_date" class="form-input" required onchange="checkAvailableSlots()">
                        <div class="error-message" id="appointmentDateError"></div>
                    </div>
                </div>

                <!-- HORARIOS DISPONIBLES -->
                <div class="form-row full" id="availableSlotsSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Horarios Disponibles</label>
                        <div class="available-slots">
                            <div style="color: #2D6A4F; font-weight: 600; margin-bottom: 10px;">
                                Selecciona un horario disponible:
                            </div>
                            <div class="slot-grid" id="availableSlotsGrid">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                        </div>
                        <input type="hidden" id="appointmentTime" name="appointment_time" required>
                        <div class="error-message" id="appointmentTimeError"></div>
                    </div>
                </div>

                <!-- ESTADO -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="appointmentStatus" class="form-label">Estado</label>
                        <select id="appointmentStatus" name="status" class="form-select">
                            <option value="scheduled">üìã Programada</option>
                            <option value="confirmed">‚úÖ Confirmada</option>
                            <option value="completed">üèÅ Completada</option>
                            <option value="cancelled">‚ùå Cancelada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointmentPriority" class="form-label">Prioridad</label>
                        <select id="appointmentPriority" name="priority" class="form-select">
                            <option value="normal">üü¢ Normal</option>
                            <option value="urgent">üü° Urgente</option>
                            <option value="emergency">üî¥ Emergencia</option>
                        </select>
                    </div>
                </div>

                <!-- MOTIVO DE LA CONSULTA -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="appointmentReason" class="form-label">Motivo de la Consulta *</label>
                        <textarea id="appointmentReason" name="reason" class="form-textarea" required
                                  placeholder="Describe el motivo de la consulta..."></textarea>
                        <div class="error-message" id="appointmentReasonError"></div>
                    </div>
                </div>

                <!-- NOTAS ADICIONALES -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="appointmentNotes" class="form-label">Notas Adicionales</label>
                        <textarea id="appointmentNotes" name="notes" class="form-textarea"
                                  placeholder="Notas adicionales para el veterinario..."></textarea>
                    </div>
                </div>

                <!-- OPCIONES DE NOTIFICACI√ìN -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Notificaciones</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; color: #2D6A4F;">
                                <input type="checkbox" id="sendEmailReminder" checked>
                                üìß Enviar recordatorio por email
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; color: #2D6A4F;">
                                <input type="checkbox" id="sendWhatsAppReminder" checked>
                                üì± Enviar recordatorio por WhatsApp
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reminderTime" class="form-label">Recordatorio</label>
                        <select id="reminderTime" class="form-select">
                            <option value="24">24 horas antes</option>
                            <option value="12">12 horas antes</option>
                            <option value="6">6 horas antes</option>
                            <option value="1">1 hora antes</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeAppointmentModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="saveAppointment()" class="btn-save" id="saveBtn">
                <span id="saveBtnIcon">üíæ</span>
                <span id="saveBtnText">Guardar Cita</span>
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER DETALLES DE CITA -->
<div class="modal" id="appointmentDetailsModal">
    <div class="modal-content" style="max-width: 900px;">
        <button class="modal-close" onclick="closeAppointmentDetailsModal()">‚úñ</button>
        <div class="modal-header">
            <h2 class="modal-title" id="detailsModalTitle">
                <span>üìÖ</span>
                <span id="detailsAppointmentTitle">Detalles de Cita</span>
            </h2>
            <p class="modal-subtitle" id="detailsModalSubtitle">Informaci√≥n completa de la cita m√©dica</p>
        </div>
        <div class="modal-body" id="appointmentDetailsContent">
            <!-- Se llenar√° din√°micamente -->
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeAppointmentDetailsModal()" class="btn-cancel">
                Cerrar
            </button>
            <button type="button" onclick="editAppointmentFromDetails()" class="btn-primary" id="editFromDetailsBtn">
                ‚úèÔ∏è Editar Cita
            </button>
            <button type="button" onclick="printAppointment()" class="btn-secondary" id="printAppointmentBtn">
                üñ®Ô∏è Imprimir
            </button>
            <button type="button" onclick="createMedicalRecord()" class="btn-primary" id="createRecordBtn">
                üìÑ Crear Historia Cl√≠nica
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN -->
<div class="modal" id="confirmModal">
    <div class="modal-content" style="max-width: 450px;">
        <button class="modal-close" onclick="closeConfirmModal()">‚úñ</button>
        <div class="modal-header">
            <h2 class="modal-title" id="confirmTitle">
                <span id="confirmIcon">‚ùì</span>
                Confirmar Acci√≥n
            </h2>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">¬øEst√°s seguro de realizar esta acci√≥n?</p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeConfirmModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="executeConfirmAction()" class="btn-save" id="confirmBtn">
                <span id="confirmBtnText">Confirmar</span>
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA CITAS EN LOTE -->
<div class="modal" id="bulkActionsModal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeBulkActionsModal()">‚úñ</button>
        <div class="modal-header">
            <h2 class="modal-title">
                <span>‚ö°</span>
                Acciones en Lote
            </h2>
            <p class="modal-subtitle">Realizar acciones m√∫ltiples en citas seleccionadas</p>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Seleccionar Acci√≥n</label>
                <select id="bulkAction" class="form-select">
                    <option value="">Seleccionar acci√≥n</option>
                    <option value="confirm">‚úÖ Confirmar citas</option>
                    <option value="cancel">‚ùå Cancelar citas</option>
                    <option value="reschedule">üìÖ Reprogramar citas</option>
                    <option value="change_vet">üë®‚Äç‚öïÔ∏è Cambiar veterinario</option>
                    <option value="send_reminders">üìß Enviar recordatorios</option>
                </select>
            </div>
            
            <div id="bulkActionOptions" style="display: none; margin-top: 20px;">
                <!-- Opciones espec√≠ficas seg√∫n la acci√≥n seleccionada -->
            </div>
            
            <div style="background: #D8F3DC; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <div style="color: #2D6A4F; font-weight: 600; margin-bottom: 10px;">
                    Citas Seleccionadas: <span id="selectedCount">0</span>
                </div>
                <div id="selectedAppointmentsList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Lista de citas seleccionadas -->
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeBulkActionsModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="executeBulkAction()" class="btn-save" id="bulkExecuteBtn">
                ‚ö° Ejecutar Acci√≥n
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // =============== VARIABLES GLOBALES ===============
    let allAppointments = [];
    let filteredAppointments = [];
    let allClients = [];
    let allVeterinarians = [];
    let allPets = [];
    let currentEditingAppointment = null;
    let currentViewingAppointment = null;
    let currentView = 'table';
    let currentDate = new Date();
    let confirmAction = null;
    let selectedAppointments = [];

    // =============== INICIALIZACI√ìN ===============
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando Gesti√≥n de Citas...');
        loadInitialData();
        setupEventListeners();
    });

    // =============== CONFIGURAR EVENT LISTENERS ===============
    function setupEventListeners() {
        // Validaci√≥n en tiempo real del formulario
        document.getElementById('appointmentDate').addEventListener('change', validateAppointmentDate);
        document.getElementById('clientId').addEventListener('change', validateClientSelection);
        document.getElementById('petId').addEventListener('change', validatePetSelection);
        document.getElementById('veterinarianId').addEventListener('change', validateVeterinarianSelection);
        document.getElementById('appointmentReason').addEventListener('input', validateReason);

        // Escape key para cerrar modales
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllModals();
            }
        });

        // Auto-guardar drafts (opcional)
        document.getElementById('appointmentForm').addEventListener('input', debounce(saveDraft, 2000));
    }

    // =============== CARGA DE DATOS INICIAL ===============
    async function loadInitialData() {
        try {
            showLoadingMessage('Cargando datos del sistema...');
            
            await Promise.all([
                loadClientsData(),
                loadVeterinariansData(),
                loadPetsData(),
                loadAppointmentsData()
            ]);
            
            console.log('‚úÖ Todos los datos cargados exitosamente');
        } catch (error) {
            console.error('‚ùå Error cargando datos iniciales:', error);
            showMessage('Error cargando datos del sistema', 'error');
        }
    }

    // =============== CARGA DE CLIENTES ===============
    async function loadClientsData() {
        try {
            console.log('üì° Obteniendo clientes del Auth Service...');

            const response = await fetch('/api/admin/users', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.users) {
                    // Filtrar solo clientes activos
                    allClients = data.users.filter(user =>
                        user.role === 'client' && user.is_active === true
                    );
                    populateClientSelects();
                    console.log(`‚úÖ ${allClients.length} clientes cargados`);
                    return;
                }
            }

            throw new Error('No se pudo obtener clientes');

        } catch (error) {
            console.error('‚ùå Error obteniendo clientes:', error);
            // Datos de ejemplo como fallback
            allClients = getExampleClients();
            populateClientSelects();
            showMessage('Usando datos de clientes de ejemplo', 'warning');
        }
    }

    function getExampleClients() {
        return [
            {
                id: 'client1',
                first_name: 'Carlos',
                last_name: 'L√≥pez',
                email: 'carlos@example.com',
                phone: '+1234567893',
                role: 'client'
            },
            {
                id: 'client2',
                first_name: 'Mar√≠a',
                last_name: 'Gonz√°lez',
                email: 'maria@example.com',
                phone: '+1234567894',
                role: 'client'
            },
            {
                id: 'client3',
                first_name: 'Ana',
                last_name: 'Mart√≠nez',
                email: 'ana@example.com',
                phone: '+1234567895',
                role: 'client'
            }
        ];
    }

    function populateClientSelects() {
        const clientSelect = document.getElementById('clientId');
        const clientFilter = document.getElementById('clientFilter');

        // Limpiar opciones existentes
        clientSelect.innerHTML = '<option value="">Seleccionar cliente</option>';
        clientFilter.innerHTML = '<option value="">Todos los clientes</option>';

        // Llenar opciones ordenadas por nombre
        const sortedClients = allClients.sort((a, b) => 
            `${a.first_name} ${a.last_name}`.localeCompare(`${b.first_name} ${b.last_name}`)
        );

        sortedClients.forEach(client => {
            const clientName = `${client.first_name} ${client.last_name}`;

            // Para select de creaci√≥n/edici√≥n
            const option1 = document.createElement('option');
            option1.value = client.id;
            option1.textContent = clientName;
            option1.dataset.phone = client.phone;
            option1.dataset.email = client.email;
            clientSelect.appendChild(option1);

            // Para filtro
            const option2 = document.createElement('option');
            option2.value = client.id;
            option2.textContent = clientName;
            clientFilter.appendChild(option2);
        });
    }

    // =============== CARGA DE VETERINARIOS ===============
    async function loadVeterinariansData() {
        try {
            console.log('üì° Obteniendo veterinarios del Auth Service...');

            const response = await fetch('/api/admin/users', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.users) {
                    // Filtrar solo veterinarios activos
                    allVeterinarians = data.users.filter(user =>
                        user.role === 'veterinarian' && user.is_active === true
                    );
                    populateVeterinarianSelects();
                    console.log(`‚úÖ ${allVeterinarians.length} veterinarios cargados`);
                    return;
                }
            }

            throw new Error('No se pudo obtener veterinarios');

        } catch (error) {
            console.error('‚ùå Error obteniendo veterinarios:', error);
            // Datos de ejemplo como fallback
            allVeterinarians = getExampleVeterinarians();
            populateVeterinarianSelects();
            showMessage('Usando datos de veterinarios de ejemplo', 'warning');
        }
    }

    function getExampleVeterinarians() {
        return [
            {
                id: 'vet1',
                first_name: 'Dr. Juan',
                last_name: 'P√©rez',
                email: 'juan.perez@veterinariaclinic.com',
                role: 'veterinarian'
            },
            {
                id: 'vet2',
                first_name: 'Dra. Laura',
                last_name: 'Rodr√≠guez',
                email: 'laura.rodriguez@veterinariaclinic.com',
                role: 'veterinarian'
            }
        ];
    }

    function populateVeterinarianSelects() {
        const vetSelect = document.getElementById('veterinarianId');
        const vetFilter = document.getElementById('vetFilter');

        // Limpiar opciones existentes
        vetSelect.innerHTML = '<option value="">Seleccionar veterinario</option>';
        vetFilter.innerHTML = '<option value="">Todos los veterinarios</option>';

        // Llenar opciones ordenadas por nombre
        const sortedVets = allVeterinarians.sort((a, b) => 
            `${a.first_name} ${a.last_name}`.localeCompare(`${b.first_name} ${b.last_name}`)
        );

        sortedVets.forEach(vet => {
            const vetName = `${vet.first_name} ${vet.last_name}`;

            // Para select de creaci√≥n/edici√≥n
            const option1 = document.createElement('option');
            option1.value = vet.id;
            option1.textContent = vetName;
            vetSelect.appendChild(option1);

            // Para filtro
            const option2 = document.createElement('option');
            option2.value = vet.id;
            option2.textContent = vetName;
            vetFilter.appendChild(option2);
        });
    }

    // =============== CARGA DE MASCOTAS ===============
    async function loadPetsData() {
        try {
            console.log('üì° Obteniendo mascotas del Medical Service...');

            const response = await fetch('/api/admin/pets', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.pets) {
                    allPets = data.pets;
                    console.log(`‚úÖ ${allPets.length} mascotas cargadas`);
                    return;
                }
            }

            throw new Error('No se pudo conectar con Medical Service');

        } catch (error) {
            console.error('‚ùå Error obteniendo mascotas:', error);
            // Datos de ejemplo como fallback
            allPets = getExamplePets();
            showMessage('Usando datos de mascotas de ejemplo', 'warning');
        }
    }

    function getExamplePets() {
        return [
            {
                id: '1',
                name: 'Max',
                species: 'perro',
                breed: 'Golden Retriever',
                owner_name: 'Carlos L√≥pez',
                owner_id: 'client1'
            },
            {
                id: '2',
                name: 'Luna',
                species: 'gato',
                breed: 'Siam√©s',
                owner_name: 'Carlos L√≥pez',
                owner_id: 'client1'
            },
            {
                id: '3',
                name: 'Rocky',
                species: 'perro',
                breed: 'Bulldog Franc√©s',
                owner_name: 'Mar√≠a Gonz√°lez',
                owner_id: 'client2'
            },
            {
                id: '4',
                name: 'Mila',
                species: 'gato',
                breed: 'Persa',
                owner_name: 'Ana Mart√≠nez',
                owner_id: 'client3'
            }
        ];
    }

    // =============== CARGA DE CITAS ===============
    async function loadAppointmentsData() {
        try {
            console.log('üì° Obteniendo citas del Appointment Service...');

            const response = await fetch('/api/admin/appointments', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.appointments) {
                    allAppointments = enrichAppointmentsData(data.appointments);
                    filteredAppointments = [...allAppointments];
                    displayAppointmentsData();
                    updateStatistics();
                    console.log(`‚úÖ ${allAppointments.length} citas cargadas`);
                    return;
                }
            }

            throw new Error('No se pudo conectar con Appointment Service');

        } catch (error) {
            console.error('‚ùå Error obteniendo citas:', error);
            // Usar datos de ejemplo como fallback
            allAppointments = getExampleAppointments();
            filteredAppointments = [...allAppointments];
            displayAppointmentsData();
            updateStatistics();
            showMessage('Usando datos de citas de ejemplo', 'warning');
        }
    }

    function enrichAppointmentsData(appointments) {
        return appointments.map(appointment => {
            // Enriquecer con datos de cliente
            const client = allClients.find(c => c.id === appointment.client_id);
            if (client) {
                appointment.client_name = `${client.first_name} ${client.last_name}`;
                appointment.client_email = client.email;
                appointment.client_phone = client.phone;
            }

            // Enriquecer con datos de veterinario
            const vet = allVeterinarians.find(v => v.id === appointment.veterinarian_id);
            if (vet) {
                appointment.veterinarian_name = `${vet.first_name} ${vet.last_name}`;
            }

            // Enriquecer con datos de mascota
            const pet = allPets.find(p => p.id === appointment.pet_id);
            if (pet) {
                appointment.pet_name = pet.name;
                appointment.pet_species = pet.species;
                appointment.pet_breed = pet.breed;
            }

            return appointment;
        });
    }

    function getExampleAppointments() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const nextWeek = new Date(today);
        nextWeek.setDate(nextWeek.getDate() + 7);

        return [
            {
                id: '1',
                pet_id: '1',
                pet_name: 'Max',
                pet_species: 'perro',
                pet_breed: 'Golden Retriever',
                client_id: 'client1',
                client_name: 'Carlos L√≥pez',
                client_phone: '+1234567893',
                client_email: 'carlos@example.com',
                veterinarian_id: 'vet1',
                veterinarian_name: 'Dr. Juan P√©rez',
                appointment_date: today.toISOString().split('T')[0],
                appointment_time: '10:00',
                status: 'confirmed',
                priority: 'normal',
                reason: 'Consulta de rutina y vacunaci√≥n anual',
                notes: 'Primera visita del a√±o. Revisar historial de vacunas.',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            },
            {
                id: '2',
                pet_id: '2',
                pet_name: 'Luna',
                pet_species: 'gato',
                pet_breed: 'Siam√©s',
                client_id: 'client1',
                client_name: 'Carlos L√≥pez',
                client_phone: '+1234567893',
                client_email: 'carlos@example.com',
                veterinarian_id: 'vet1',
                veterinarian_name: 'Dr. Juan P√©rez',
                appointment_date: tomorrow.toISOString().split('T')[0],
                appointment_time: '14:30',
                status: 'scheduled',
                priority: 'urgent',
                reason: 'Control post-operatorio esterilizaci√≥n',
                notes: 'Revisar cicatrizaci√≥n y retirar puntos si es necesario.',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            },
            {
                id: '3',
                pet_id: '3',
                pet_name: 'Rocky',
                pet_species: 'perro',
                pet_breed: 'Bulldog Franc√©s',
                client_id: 'client2',
                client_name: 'Mar√≠a Gonz√°lez',
                client_phone: '+1234567894',
                client_email: 'maria@example.com',
                veterinarian_id: 'vet2',
                veterinarian_name: 'Dra. Laura Rodr√≠guez',
                appointment_date: nextWeek.toISOString().split('T')[0],
                appointment_time: '16:00',
                status: 'scheduled',
                priority: 'emergency',
                reason: 'Dificultad respiratoria - Emergencia',
                notes: 'Cliente reporta respiraci√≥n muy dificultosa desde anoche.',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            }
        ];
    }

    // =============== ACTUALIZACI√ìN DE ESTAD√çSTICAS ===============
    function updateStatistics() {
        const totalAppointments = allAppointments.length;
        const today = new Date().toDateString();
        const appointmentsToday = allAppointments.filter(a =>
            new Date(a.appointment_date).toDateString() === today
        ).length;
        const scheduledAppointments = allAppointments.filter(a => 
            a.status === 'scheduled' || a.status === 'confirmed'
        ).length;
        const completedAppointments = allAppointments.filter(a => a.status === 'completed').length;

        document.getElementById('appointmentsTotal').textContent = totalAppointments;
        document.getElementById('appointmentsToday').textContent = appointmentsToday;
        document.getElementById('appointmentsScheduled').textContent = scheduledAppointments;
        document.getElementById('appointmentsCompleted').textContent = completedAppointments;
    }

    // =============== MOSTRAR DATOS ===============
    function displayAppointmentsData() {
        if (currentView === 'table') {
            displayTableView();
        } else {
            displayCalendarView();
        }
    }

    function displayTableView() {
        const container = document.getElementById('appointmentsTableContainer');
        const resultsInfo = document.getElementById('resultsInfo');

        // Actualizar informaci√≥n de resultados
        resultsInfo.textContent = `Mostrando ${filteredAppointments.length} de ${allAppointments.length} citas`;

        if (filteredAppointments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>üìÖ No se encontraron citas</h3>
                    <p>No hay citas que coincidan con los filtros aplicados.</p>
                    <button onclick="resetFilters()" class="btn-primary">
                        üîÑ Limpiar Filtros
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <table class="appointments-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="margin-right: 8px;">
                            Fecha/Hora
                        </th>
                        <th>Cliente</th>
                        <th>Mascota</th>
                        <th>Veterinario</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th>Prioridad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredAppointments.map(appointment => `
                        <tr ${selectedAppointments.includes(appointment.id) ? 'style="background: rgba(82, 183, 136, 0.1);"' : ''}>
                            <td>
                                <div class="appointment-info">
                                    <input type="checkbox" class="appointment-checkbox" 
                                           value="${appointment.id}" 
                                           onchange="toggleAppointmentSelection('${appointment.id}')"
                                           ${selectedAppointments.includes(appointment.id) ? 'checked' : ''}
                                           style="margin-right: 8px;">
                                    <div class="appointment-avatar">${getPriorityIcon(appointment.priority)}</div>
                                    <div class="appointment-details">
                                        <div class="appointment-date">${formatDate(appointment.appointment_date)}</div>
                                        <div class="appointment-time">${appointment.appointment_time}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="client-info">
                                    <div class="client-name">${appointment.client_name || 'Cliente desconocido'}</div>
                                    <div class="client-contact">${appointment.client_phone || appointment.client_email || ''}</div>
                                </div>
                            </td>
                            <td>
                                <div class="pet-info">
                                    <div class="pet-name">${appointment.pet_name || 'Mascota desconocida'}</div>
                                    <div class="pet-species">${getSpeciesLabel(appointment.pet_species)} ${appointment.pet_breed ? `‚Ä¢ ${appointment.pet_breed}` : ''}</div>
                                </div>
                            </td>
                            <td>
                                <div class="vet-info">
                                    <div class="vet-name">${appointment.veterinarian_name || 'Veterinario desconocido'}</div>
                                    <div class="vet-specialty">Medicina Veterinaria</div>
                                </div>
                            </td>
                            <td style="max-width: 200px;">
                                <div style="color: #2D6A4F; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${appointment.reason || 'Consulta general'}
                                </div>
                                ${appointment.notes ? `<div style="color: #52B788; font-size: 0.85rem; margin-top: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${appointment.notes}</div>` : ''}
                            </td>
                            <td style="text-align: center;">
                                ${getStatusBadge(appointment.status)}
                            </td>
                            <td style="text-align: center;">
                                ${getPriorityBadge(appointment.priority)}
                            </td>
                            <td>
                                <div class="actions-group">
                                    <button onclick="viewAppointment('${appointment.id}')" class="action-btn view" title="Ver detalles">
                                        üëÅÔ∏è Ver
                                    </button>
                                    <button onclick="editAppointment('${appointment.id}')" class="action-btn edit" title="Editar">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    ${appointment.status === 'scheduled' ? `
                                        <button onclick="confirmAppointment('${appointment.id}')" class="action-btn confirm" title="Confirmar">
                                            ‚úÖ Confirmar
                                        </button>
                                    ` : ''}
                                    ${appointment.status !== 'completed' && appointment.status !== 'cancelled' ? `
                                        <button onclick="completeAppointment('${appointment.id}')" class="action-btn complete" title="Completar">
                                            üèÅ Completar
                                        </button>
                                    ` : ''}
                                    ${appointment.status !== 'cancelled' ? `
                                        <button onclick="cancelAppointment('${appointment.id}')" class="action-btn cancel" title="Cancelar">
                                            ‚ùå Cancelar
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteAppointment('${appointment.id}')" class="action-btn delete" title="Eliminar">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        // Agregar bot√≥n de acciones en lote si hay citas seleccionadas
        if (selectedAppointments.length > 0) {
            showBulkActionsButton();
        } else {
            hideBulkActionsButton();
        }
    }

    // =============== VISTA DE CALENDARIO ===============
    function displayCalendarView() {
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarMonth = document.getElementById('calendarMonth');

        // Actualizar t√≠tulo del mes
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        calendarMonth.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

        // Generar calendario
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        let calendarHTML = '';

        // Headers de d√≠as
        const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        dayHeaders.forEach(day => {
            calendarHTML += `<div class="calendar-day-header">${day}</div>`;
        });

        // Generar d√≠as del calendario
        const today = new Date();
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);

            const isCurrentMonth = date.getMonth() === currentDate.getMonth();
            const isToday = date.toDateString() === today.toDateString();
            const dateString = date.toISOString().split('T')[0];

            // Obtener citas del d√≠a
            const dayAppointments = filteredAppointments.filter(apt => apt.appointment_date === dateString);

            let dayClass = 'calendar-day';
            if (!isCurrentMonth) dayClass += ' other-month';
            if (isToday) dayClass += ' today';

            calendarHTML += `
                <div class="${dayClass}" onclick="selectCalendarDay('${dateString}')">
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-appointments">
                        ${dayAppointments.slice(0, 3).map(apt => `
                            <div class="day-appointment ${apt.status}" 
                                 onclick="event.stopPropagation(); viewAppointment('${apt.id}')" 
                                 title="${apt.appointment_time} - ${apt.client_name} (${apt.pet_name})">
                                ${apt.appointment_time} ${apt.pet_name}
                            </div>
                        `).join('')}
                        ${dayAppointments.length > 3 ? `<div class="day-appointment">+${dayAppointments.length - 3} m√°s</div>` : ''}
                    </div>
                </div>
            `;
        }

        calendarGrid.innerHTML = calendarHTML;
    }

    // =============== FILTROS Y B√öSQUEDA ===============
    function filterAppointments() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const dateFilter = document.getElementById('dateFilter').value;
        const vetFilter = document.getElementById('vetFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const clientFilter = document.getElementById('clientFilter').value;

        filteredAppointments = allAppointments.filter(appointment => {
            // Filtro de b√∫squeda
            const matchesSearch = !searchTerm ||
                (appointment.client_name && appointment.client_name.toLowerCase().includes(searchTerm)) ||
                (appointment.pet_name && appointment.pet_name.toLowerCase().includes(searchTerm)) ||
                (appointment.veterinarian_name && appointment.veterinarian_name.toLowerCase().includes(searchTerm)) ||
                (appointment.reason && appointment.reason.toLowerCase().includes(searchTerm)) ||
                (appointment.notes && appointment.notes.toLowerCase().includes(searchTerm));

            // Filtro de fecha
            const matchesDate = !dateFilter || appointment.appointment_date === dateFilter;

            // Filtro de veterinario
            const matchesVet = !vetFilter || appointment.veterinarian_id === vetFilter;

            // Filtro de estado
            const matchesStatus = !statusFilter || appointment.status === statusFilter;

            // Filtro de cliente
            const matchesClient = !clientFilter || appointment.client_id === clientFilter;

            return matchesSearch && matchesDate && matchesVet && matchesStatus && matchesClient;
        });

        displayAppointmentsData();
    }

    function sortAppointments() {
        const sortBy = document.getElementById('sortBy').value;

        filteredAppointments.sort((a, b) => {
            switch (sortBy) {
                case 'date_asc':
                    return new Date(a.appointment_date + ' ' + a.appointment_time) - new Date(b.appointment_date + ' ' + b.appointment_time);
                case 'date_desc':
                    return new Date(b.appointment_date + ' ' + b.appointment_time) - new Date(a.appointment_date + ' ' + a.appointment_time);
                case 'time_asc':
                    return a.appointment_time.localeCompare(b.appointment_time);
                case 'time_desc':
                    return b.appointment_time.localeCompare(a.appointment_time);
                case 'client':
                    return (a.client_name || '').localeCompare(b.client_name || '');
                case 'status':
                    return (a.status || '').localeCompare(b.status || '');
                default:
                    return 0;
            }
        });

        displayAppointmentsData();
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFilter').value = '';
        document.getElementById('vetFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('clientFilter').value = '';
        document.getElementById('sortBy').value = 'date_desc';

        filteredAppointments = [...allAppointments];
        displayAppointmentsData();
        showMessage('Filtros restablecidos', 'info');
    }

    // =============== CAMBIO DE VISTAS ===============
    function switchView(view) {
        currentView = view;
        const tableView = document.getElementById('tableView');
        const calendarView = document.getElementById('calendarView');
        const tableBtn = document.getElementById('tableViewBtn');
        const calendarBtn = document.getElementById('calendarViewBtn');

        if (view === 'table') {
            tableView.style.display = 'block';
            calendarView.classList.remove('active');
            tableBtn.classList.add('active');
            calendarBtn.classList.remove('active');
            displayTableView();
        } else {
            tableView.style.display = 'none';
            calendarView.classList.add('active');
            tableBtn.classList.remove('active');
            calendarBtn.classList.add('active');
            displayCalendarView();
        }
    }

    // =============== NAVEGACI√ìN DEL CALENDARIO ===============
    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        displayCalendarView();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        displayCalendarView();
    }

    function goToToday() {
        currentDate = new Date();
        displayCalendarView();
    }

    function selectCalendarDay(dateString) {
        // Cambiar a vista de tabla y filtrar por fecha
        document.getElementById('dateFilter').value = dateString;
        switchView('table');
        filterAppointments();
    }

    // =============== MODAL DE CITA ===============
    function openAppointmentModal(appointmentId = null) {
        const modal = document.getElementById('appointmentModal');
        const form = document.getElementById('appointmentForm');

        // Reset form
        form.reset();
        clearValidationErrors();
        document.getElementById('appointmentId').value = '';
        currentEditingAppointment = null;

        // Ocultar secci√≥n de horarios disponibles
        document.getElementById('availableSlotsSection').style.display = 'none';

        if (appointmentId) {
            // Modo edici√≥n
            const appointment = allAppointments.find(a => a.id === appointmentId);
            if (!appointment) {
                showMessage('Cita no encontrada', 'error');
                return;
            }

            currentEditingAppointment = appointment;

            // Llenar formulario
            document.getElementById('clientId').value = appointment.client_id || '';
            document.getElementById('petId').value = appointment.pet_id || '';
            document.getElementById('veterinarianId').value = appointment.veterinarian_id || '';
            document.getElementById('appointmentDate').value = appointment.appointment_date || '';
            document.getElementById('appointmentTime').value = appointment.appointment_time || '';
            document.getElementById('appointmentStatus').value = appointment.status || 'scheduled';
            document.getElementById('appointmentPriority').value = appointment.priority || 'normal';
            document.getElementById('appointmentReason').value = appointment.reason || '';
            document.getElementById('appointmentNotes').value = appointment.notes || '';
            document.getElementById('appointmentId').value = appointment.id;

            // Actualizar mascotas del cliente
            updateClientPets();

            // Actualizar UI del modal
            document.getElementById('modalIcon').textContent = '‚úèÔ∏è';
            document.getElementById('modalTitleText').textContent = 'Editar Cita';
            document.getElementById('modalSubtitle').textContent = `Modificando cita de: ${appointment.client_name}`;
            document.getElementById('saveBtnIcon').textContent = 'üíæ';
            document.getElementById('saveBtnText').textContent = 'Actualizar Cita';
        } else {
            // Modo creaci√≥n
            document.getElementById('modalIcon').textContent = 'üìÖ';
            document.getElementById('modalTitleText').textContent = 'Nueva Cita';
            document.getElementById('modalSubtitle').textContent = 'Programa una nueva cita m√©dica';
            document.getElementById('saveBtnIcon').textContent = 'üíæ';
            document.getElementById('saveBtnText').textContent = 'Crear Cita';

            // Establecer fecha m√≠nima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;
            document.getElementById('appointmentDate').value = today;
        }

        modal.classList.add('active');
    }

    function closeAppointmentModal() {
        const modal = document.getElementById('appointmentModal');
        modal.classList.remove('active');
        currentEditingAppointment = null;
        clearValidationErrors();
    }

    // =============== ACTUALIZAR MASCOTAS POR CLIENTE ===============
    function updateClientPets() {
        const clientId = document.getElementById('clientId').value;
        const petSelect = document.getElementById('petId');

        // Limpiar opciones
        petSelect.innerHTML = '<option value="">Seleccionar mascota</option>';
        clearValidationError('petId');

        if (!clientId) {
            petSelect.innerHTML = '<option value="">Primero selecciona un cliente</option>';
            return;
        }

        // Filtrar mascotas del cliente
        const clientPets = allPets.filter(pet => pet.owner_id === clientId);

        if (clientPets.length === 0) {
            petSelect.innerHTML = '<option value="">Este cliente no tiene mascotas registradas</option>';
            showValidationError('petId', 'Este cliente no tiene mascotas registradas');
            return;
        }

        // Llenar con las mascotas del cliente ordenadas por nombre
        const sortedPets = clientPets.sort((a, b) => a.name.localeCompare(b.name));
        
        sortedPets.forEach(pet => {
            const option = document.createElement('option');
            option.value = pet.id;
            option.textContent = `${pet.name} (${getSpeciesLabel(pet.species)})`;
            option.dataset.species = pet.species;
            option.dataset.breed = pet.breed;
            petSelect.appendChild(option);
        });

        showValidationSuccess('petId');
    }

    // =============== VERIFICAR HORARIOS DISPONIBLES ===============
    async function checkAvailableSlots() {
        const veterinarianId = document.getElementById('veterinarianId').value;
        const appointmentDate = document.getElementById('appointmentDate').value;
        const slotsSection = document.getElementById('availableSlotsSection');
        const slotsGrid = document.getElementById('availableSlotsGrid');

        // Limpiar selecci√≥n previa
        document.getElementById('appointmentTime').value = '';
        
        if (!veterinarianId || !appointmentDate) {
            slotsSection.style.display = 'none';
            return;
        }

        try {
            slotsGrid.innerHTML = '<div style="color: #52B788;">üîÑ Cargando horarios disponibles...</div>';
            slotsSection.style.display = 'block';

            const response = await fetch(`/api/admin/appointments/available-slots?veterinarian_id=${veterinarianId}&date=${appointmentDate}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.available_slots) {
                    displayAvailableSlots(data.available_slots);
                } else {
                    slotsGrid.innerHTML = '<div style="color: #dc3545;">‚ùå Error obteniendo horarios</div>';
                }
            } else {
                throw new Error('Error del servidor');
            }

        } catch (error) {
            console.error('‚ùå Error obteniendo horarios:', error);
            // Horarios de ejemplo como fallback
            const exampleSlots = [
                '08:00', '08:30', '09:00', '09:30', '10:00', '10:30',
                '11:00', '11:30', '14:00', '14:30', '15:00', '15:30',
                '16:00', '16:30', '17:00'
            ];
            displayAvailableSlots(exampleSlots);
            showMessage('Usando horarios de ejemplo', 'warning');
        }
    }

    function displayAvailableSlots(slots) {
        const slotsGrid = document.getElementById('availableSlotsGrid');
        
        if (slots.length === 0) {
            slotsGrid.innerHTML = '<div style="color: #dc3545;">‚ùå No hay horarios disponibles para esta fecha</div>';
            return;
        }

        slotsGrid.innerHTML = slots.map(time => `
            <div class="time-slot" onclick="selectTimeSlot('${time}')">
                ${time}
            </div>
        `).join('');
    }

    function selectTimeSlot(time) {
        // Limpiar selecciones previas
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });

        // Seleccionar el slot clickeado
        event.target.classList.add('selected');
        document.getElementById('appointmentTime').value = time;
        
        clearValidationError('appointmentTime');
        showValidationSuccess('appointmentTime');
    }

    // =============== VALIDACIONES DEL FORMULARIO ===============
    function validateAppointmentDate() {
        const dateInput = document.getElementById('appointmentDate');
        const selectedDate = new Date(dateInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
            showValidationError('appointmentDate', 'No se pueden programar citas en fechas pasadas');
            return false;
        }

        // Verificar si es domingo (opcional - depende de las pol√≠ticas de la cl√≠nica)
        if (selectedDate.getDay() === 0) {
            showValidationError('appointmentDate', 'Los domingos no hay atenci√≥n');
            return false;
        }

        clearValidationError('appointmentDate');
        showValidationSuccess('appointmentDate');
        return true;
    }

    function validateClientSelection() {
        const clientSelect = document.getElementById('clientId');
        
        if (!clientSelect.value) {
            showValidationError('clientId', 'Debe seleccionar un cliente');
            return false;
        }

        clearValidationError('clientId');
        showValidationSuccess('clientId');
        return true;
    }

    function validatePetSelection() {
        const petSelect = document.getElementById('petId');
        
        if (!petSelect.value) {
            showValidationError('petId', 'Debe seleccionar una mascota');
            return false;
        }

        clearValidationError('petId');
        showValidationSuccess('petId');
        return true;
    }

    function validateVeterinarianSelection() {
        const vetSelect = document.getElementById('veterinarianId');
        
        if (!vetSelect.value) {
            showValidationError('veterinarianId', 'Debe seleccionar un veterinario');
            return false;
        }

        clearValidationError('veterinarianId');
        showValidationSuccess('veterinarianId');
        return true;
    }

    function validateReason() {
        const reasonInput = document.getElementById('appointmentReason');
        const reason = reasonInput.value.trim();
        
        if (!reason) {
            showValidationError('appointmentReason', 'Debe especificar el motivo de la consulta');
            return false;
        }

        if (reason.length < 10) {
            showValidationError('appointmentReason', 'El motivo debe tener al menos 10 caracteres');
            return false;
        }

        clearValidationError('appointmentReason');
        showValidationSuccess('appointmentReason');
        return true;
    }

    function validateTimeSelection() {
        const timeInput = document.getElementById('appointmentTime');
        
        if (!timeInput.value) {
            showValidationError('appointmentTime', 'Debe seleccionar un horario');
            return false;
        }

        clearValidationError('appointmentTime');
        return true;
    }

    function showValidationError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(fieldId + 'Error');
        
        field.classList.add('error');
        field.classList.remove('success');
        
        if (errorElement) {
            errorElement.textContent = message;
        }
    }

    function showValidationSuccess(fieldId) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(fieldId + 'Error');
        
        field.classList.remove('error');
        field.classList.add('success');
        
        if (errorElement) {
            errorElement.textContent = '';
        }
    }

    function clearValidationError(fieldId) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(fieldId + 'Error');
        
        field.classList.remove('error', 'success');
        
        if (errorElement) {
            errorElement.textContent = '';
        }
    }

    function clearValidationErrors() {
        const errorElements = document.querySelectorAll('.error-message');
        const formElements = document.querySelectorAll('.form-input, .form-select');
        
        errorElements.forEach(el => el.textContent = '');
        formElements.forEach(el => el.classList.remove('error', 'success'));
    }

    // =============== GUARDAR CITA ===============
    async function saveAppointment() {
        const form = document.getElementById('appointmentForm');
        const saveBtn = document.getElementById('saveBtn');

        // Validar formulario completo
        const isValid = validateFullForm();

        if (!isValid) {
            showMessage('Por favor, corrija los errores en el formulario', 'error');
            return;
        }

        // Recopilar datos de la cita
        const appointmentData = {
            client_id: document.getElementById('clientId').value,
            pet_id: document.getElementById('petId').value,
            veterinarian_id: document.getElementById('veterinarianId').value,
            appointment_date: document.getElementById('appointmentDate').value,
            appointment_time: document.getElementById('appointmentTime').value,
            status: document.getElementById('appointmentStatus').value,
            priority: document.getElementById('appointmentPriority').value,
            reason: document.getElementById('appointmentReason').value.trim(),
            notes: document.getElementById('appointmentNotes').value.trim(),
            send_email_reminder: document.getElementById('sendEmailReminder').checked,
            send_whatsapp_reminder: document.getElementById('sendWhatsAppReminder').checked,
            reminder_time: parseInt(document.getElementById('reminderTime').value)
        };

        // Deshabilitar bot√≥n
        saveBtn.disabled = true;
        document.getElementById('saveBtnText').textContent = 'Guardando...';

        try {
            let response;
            let endpoint = '/api/admin/appointments';
            let method = 'POST';

            if (currentEditingAppointment) {
                // Actualizar cita existente
                endpoint = `/api/admin/appointments/${currentEditingAppointment.id}`;
                method = 'PUT';
            }

            response = await fetch(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(appointmentData)
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showMessage(
                        currentEditingAppointment ? 'Cita actualizada exitosamente' : 'Cita creada exitosamente',
                        'success'
                    );

                    closeAppointmentModal();

                    // Recargar datos
                    await loadAppointmentsData();

                    // Enviar notificaciones si est√° habilitado
                    if (appointmentData.send_email_reminder || appointmentData.send_whatsapp_reminder) {
                        sendAppointmentNotifications(data.appointment || appointmentData);
                    }

                } else {
                    showMessage(data.message || 'Error al guardar la cita', 'error');
                }
            } else {
                const errorData = await response.json();
                showMessage(errorData.message || 'Error del servidor', 'error');
            }

        } catch (error) {
            console.error('‚ùå Error guardando cita:', error);

            // Fallback: guardar localmente
            saveAppointmentLocally(appointmentData);
        } finally {
            // Rehabilitar bot√≥n
            saveBtn.disabled = false;
            document.getElementById('saveBtnText').textContent =
                currentEditingAppointment ? 'Actualizar Cita' : 'Crear Cita';
        }
    }

    function validateFullForm() {
        let isValid = true;

        // Validar todos los campos requeridos
        if (!validateClientSelection()) isValid = false;
        if (!validatePetSelection()) isValid = false;
        if (!validateVeterinarianSelection()) isValid = false;
        if (!validateAppointmentDate()) isValid = false;
        if (!validateTimeSelection()) isValid = false;
        if (!validateReason()) isValid = false;

        return isValid;
    }

    async function saveAppointmentLocally(appointmentData) {
        try {
            // Enriquecer datos con informaci√≥n de cliente, mascota y veterinario
            const client = allClients.find(c => c.id === appointmentData.client_id);
            const pet = allPets.find(p => p.id === appointmentData.pet_id);
            const vet = allVeterinarians.find(v => v.id === appointmentData.veterinarian_id);

            const enrichedAppointment = {
                id: currentEditingAppointment ? currentEditingAppointment.id : `apt_${Date.now()}`,
                ...appointmentData,
                client_name: client ? `${client.first_name} ${client.last_name}` : 'Cliente desconocido',
                client_email: client?.email,
                client_phone: client?.phone,
                pet_name: pet?.name || 'Mascota desconocida',
                pet_species: pet?.species,
                pet_breed: pet?.breed,
                veterinarian_name: vet ? `${vet.first_name} ${vet.last_name}` : 'Veterinario desconocido',
                created_at: currentEditingAppointment ? currentEditingAppointment.created_at : new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            if (currentEditingAppointment) {
                // Actualizar en datos locales
                const index = allAppointments.findIndex(a => a.id === currentEditingAppointment.id);
                if (index !== -1) {
                    allAppointments[index] = enrichedAppointment;
                }
            } else {
                // Agregar a datos locales
                allAppointments.unshift(enrichedAppointment);
            }

            filteredAppointments = [...allAppointments];
            displayAppointmentsData();
            updateStatistics();

            showMessage(
                currentEditingAppointment ? 'Cita actualizada localmente' : 'Cita creada localmente',
                'warning'
            );

            closeAppointmentModal();

        } catch (error) {
            console.error('‚ùå Error en fallback local:', error);
            showMessage('Error al guardar la cita', 'error');
        }
    }

    // =============== ENVIAR NOTIFICACIONES ===============
    async function sendAppointmentNotifications(appointment) {
        try {
            const response = await fetch('/api/admin/appointments/send-notifications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    appointment_id: appointment.id,
                    send_email: appointment.send_email_reminder,
                    send_whatsapp: appointment.send_whatsapp_reminder,
                    reminder_hours: appointment.reminder_time
                })
            });

            if (response.ok) {
                showMessage('Notificaciones programadas exitosamente', 'info');
            }
        } catch (error) {
            console.error('‚ùå Error enviando notificaciones:', error);
        }
    }

    // =============== ACCIONES DE CITA ===============
    function viewAppointment(appointmentId) {
        const appointment = allAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
            showMessage('Cita no encontrada', 'error');
            return;
        }

        showAppointmentDetailsModal(appointment);
    }

    function showAppointmentDetailsModal(appointment) {
        currentViewingAppointment = appointment;
        const modal = document.getElementById('appointmentDetailsModal');

        // Actualizar t√≠tulo
        document.getElementById('detailsAppointmentTitle').textContent =
            `Cita - ${appointment.pet_name}`;
        document.getElementById('detailsModalSubtitle').textContent =
            `${formatDate(appointment.appointment_date)} a las ${appointment.appointment_time}`;

        // Generar contenido de detalles
        const content = `
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label">Cliente</div>
                    <div class="detail-value">${appointment.client_name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tel√©fono</div>
                    <div class="detail-value">${appointment.client_phone || 'No disponible'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${appointment.client_email || 'No disponible'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Mascota</div>
                    <div class="detail-value">${appointment.pet_name} (${getSpeciesLabel(appointment.pet_species)})</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Raza</div>
                    <div class="detail-value">${appointment.pet_breed || 'No especificada'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Veterinario</div>
                    <div class="detail-value">${appointment.veterinarian_name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Fecha</div>
                    <div class="detail-value">${formatDate(appointment.appointment_date)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Hora</div>
                    <div class="detail-value">${appointment.appointment_time}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value">${getStatusBadge(appointment.status)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Prioridad</div>
                    <div class="detail-value">${getPriorityBadge(appointment.priority)}</div>
                </div>
            </div>

            <div class="detail-item" style="margin-top: 20px;">
                <div class="detail-label">Motivo de la Consulta</div>
                <div class="detail-value" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #52B788;">
                    ${appointment.reason}
                </div>
            </div>

            ${appointment.notes ? `
                <div class="detail-item" style="margin-top: 20px;">
                    <div class="detail-label">Notas Adicionales</div>
                    <div class="detail-value" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #38A3A5;">
                        ${appointment.notes}
                    </div>
                </div>
            ` : ''}

            <div style="background: #D8F3DC; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <div style="color: #2D6A4F; font-weight: 600; margin-bottom: 10px;">Informaci√≥n del Sistema</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                    <div>
                        <strong>Creada:</strong> ${formatDateTime(appointment.created_at)}
                    </div>
                    <div>
                        <strong>Actualizada:</strong> ${formatDateTime(appointment.updated_at)}
                    </div>
                </div>
            </div>
        `;

        document.getElementById('appointmentDetailsContent').innerHTML = content;

        // Configurar botones del modal
        document.getElementById('editFromDetailsBtn').onclick = () => editAppointmentFromDetails(appointment.id);
        document.getElementById('printAppointmentBtn').onclick = () => printAppointment(appointment.id);
        document.getElementById('createRecordBtn').onclick = () => createMedicalRecord(appointment.id);

        modal.classList.add('active');
    }

    function closeAppointmentDetailsModal() {
        const modal = document.getElementById('appointmentDetailsModal');
        modal.classList.remove('active');
        currentViewingAppointment = null;
    }

    function editAppointment(appointmentId) {
        openAppointmentModal(appointmentId);
    }

    function editAppointmentFromDetails(appointmentId) {
        closeAppointmentDetailsModal();
        editAppointment(appointmentId);
    }

    // =============== ACCIONES DE ESTADO DE CITA ===============
    async function confirmAppointment(appointmentId) {
        await updateAppointmentStatus(appointmentId, 'confirmed', '‚úÖ Confirmar Cita',
            '¬øConfirmar esta cita?');
    }

    async function completeAppointment(appointmentId) {
        await updateAppointmentStatus(appointmentId, 'completed', 'üèÅ Completar Cita',
            '¬øMarcar esta cita como completada?');
    }

    async function cancelAppointment(appointmentId) {
        await updateAppointmentStatus(appointmentId, 'cancelled', '‚ùå Cancelar Cita',
            '¬øCancelar esta cita? Esta acci√≥n enviar√° una notificaci√≥n al cliente.');
    }

    async function updateAppointmentStatus(appointmentId, newStatus, title, message) {
        const appointment = allAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
            showMessage('Cita no encontrada', 'error');
            return;
        }

        confirmAction = () => executeStatusUpdate(appointmentId, newStatus);
        showConfirmModal(title, message, 'Confirmar', getStatusIcon(newStatus));
    }

    async function executeStatusUpdate(appointmentId, newStatus) {
        try {
            const response = await fetch(`/api/admin/appointments/${appointmentId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Actualizar en datos locales
                    const appointment = allAppointments.find(a => a.id === appointmentId);
                    if (appointment) {
                        appointment.status = newStatus;
                        appointment.updated_at = new Date().toISOString();
                    }

                    filteredAppointments = [...allAppointments];
                    displayAppointmentsData();
                    updateStatistics();

                    showMessage(`Cita ${getStatusText(newStatus).toLowerCase()} exitosamente`, 'success');

                    // Enviar notificaci√≥n al cliente
                    if (newStatus === 'cancelled') {
                        sendCancellationNotification(appointment);
                    }
                }
            } else {
                throw new Error('Error del servidor');
            }

        } catch (error) {
            console.error('‚ùå Error actualizando estado:', error);

            // Fallback: actualizar localmente
            const appointment = allAppointments.find(a => a.id === appointmentId);
            if (appointment) {
                appointment.status = newStatus;
                appointment.updated_at = new Date().toISOString();
                filteredAppointments = [...allAppointments];
                displayAppointmentsData();
                updateStatistics();
            }

            showMessage(`Cita ${getStatusText(newStatus).toLowerCase()} (modo local)`, 'warning');
        }

        closeConfirmModal();
    }

    async function deleteAppointment(appointmentId) {
        const appointment = allAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
            showMessage('Cita no encontrada', 'error');
            return;
        }

        confirmAction = () => executeDeleteAppointment(appointmentId);
        showConfirmModal(
            'üóëÔ∏è Eliminar Cita',
            `¬øEliminar permanentemente la cita de ${appointment.client_name} el ${formatDate(appointment.appointment_date)}?`,
            'Eliminar',
            'üóëÔ∏è'
        );
    }

    async function executeDeleteAppointment(appointmentId) {
        try {
            const response = await fetch(`/api/admin/appointments/${appointmentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                // Eliminar de datos locales
                allAppointments = allAppointments.filter(a => a.id !== appointmentId);
                filteredAppointments = [...allAppointments];
                displayAppointmentsData();
                updateStatistics();

                showMessage('Cita eliminada exitosamente', 'success');
            } else {
                throw new Error('Error del servidor');
            }

        } catch (error) {
            console.error('‚ùå Error eliminando cita:', error);

            // Fallback: eliminar localmente
            allAppointments = allAppointments.filter(a => a.id !== appointmentId);
            filteredAppointments = [...allAppointments];
            displayAppointmentsData();
            updateStatistics();

            showMessage('Cita eliminada (modo local)', 'warning');
        }

        closeConfirmModal();
    }

    // =============== SELECCI√ìN M√öLTIPLE Y ACCIONES EN LOTE ===============
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const appointmentCheckboxes = document.querySelectorAll('.appointment-checkbox');

        if (selectAllCheckbox.checked) {
            selectedAppointments = filteredAppointments.map(a => a.id);
            appointmentCheckboxes.forEach(cb => cb.checked = true);
        } else {
            selectedAppointments = [];
            appointmentCheckboxes.forEach(cb => cb.checked = false);
        }

        updateBulkActionsButton();
        displayAppointmentsData();
    }

    function toggleAppointmentSelection(appointmentId) {
        const index = selectedAppointments.indexOf(appointmentId);

        if (index > -1) {
            selectedAppointments.splice(index, 1);
        } else {
            selectedAppointments.push(appointmentId);
        }

        // Actualizar estado del checkbox "Seleccionar todo"
        const selectAllCheckbox = document.getElementById('selectAll');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = selectedAppointments.length === filteredAppointments.length;
            selectAllCheckbox.indeterminate = selectedAppointments.length > 0 && selectedAppointments.length < filteredAppointments.length;
        }

        updateBulkActionsButton();
        displayAppointmentsData();
    }

    function updateBulkActionsButton() {
        if (selectedAppointments.length > 0) {
            showBulkActionsButton();
        } else {
            hideBulkActionsButton();
        }
    }

    function showBulkActionsButton() {
        let bulkBtn = document.getElementById('bulkActionsBtn');

        if (!bulkBtn) {
            bulkBtn = document.createElement('button');
            bulkBtn.id = 'bulkActionsBtn';
            bulkBtn.className = 'btn-primary';
            bulkBtn.style.position = 'fixed';
            bulkBtn.style.bottom = '30px';
            bulkBtn.style.right = '30px';
            bulkBtn.style.zIndex = '1000';
            bulkBtn.onclick = openBulkActionsModal;

            document.body.appendChild(bulkBtn);
        }

        bulkBtn.innerHTML = `‚ö° Acciones en Lote (${selectedAppointments.length})`;
        bulkBtn.style.display = 'block';
    }

    function hideBulkActionsButton() {
        const bulkBtn = document.getElementById('bulkActionsBtn');
        if (bulkBtn) {
            bulkBtn.style.display = 'none';
        }
    }

    function openBulkActionsModal() {
        const modal = document.getElementById('bulkActionsModal');
        const selectedCount = document.getElementById('selectedCount');
        const selectedList = document.getElementById('selectedAppointmentsList');

        selectedCount.textContent = selectedAppointments.length;

        // Mostrar lista de citas seleccionadas
        const selectedAppointmentDetails = selectedAppointments.map(id => {
            const apt = allAppointments.find(a => a.id === id);
            return apt ? `
                <div style="padding: 8px; background: white; margin: 5px 0; border-radius: 5px; border-left: 3px solid #52B788;">
                    <strong>${apt.client_name}</strong> - ${apt.pet_name}<br>
                    <small>${formatDate(apt.appointment_date)} ${apt.appointment_time}</small>
                </div>
            ` : '';
        }).join('');

        selectedList.innerHTML = selectedAppointmentDetails;

        modal.classList.add('active');
    }

    function closeBulkActionsModal() {
        const modal = document.getElementById('bulkActionsModal');
        modal.classList.remove('active');
    }

    async function executeBulkAction() {
        const action = document.getElementById('bulkAction').value;

        if (!action) {
            showMessage('Seleccione una acci√≥n', 'error');
            return;
        }

        const executeBtn = document.getElementById('bulkExecuteBtn');
        executeBtn.disabled = true;
        executeBtn.textContent = 'Ejecutando...';

        try {
            const response = await fetch('/api/admin/appointments/bulk-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    action: action,
                    appointment_ids: selectedAppointments
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showMessage(`Acci√≥n ejecutada en ${selectedAppointments.length} citas`, 'success');

                    // Recargar datos
                    await loadAppointmentsData();

                    // Limpiar selecci√≥n
                    selectedAppointments = [];
                    hideBulkActionsButton();
                    closeBulkActionsModal();
                }
            } else {
                throw new Error('Error del servidor');
            }

        } catch (error) {
            console.error('‚ùå Error en acci√≥n en lote:', error);
            showMessage('Error ejecutando acci√≥n en lote', 'error');
        } finally {
            executeBtn.disabled = false;
            executeBtn.textContent = '‚ö° Ejecutar Acci√≥n';
        }
    }

    // =============== FUNCIONES DE EXPORTACI√ìN ===============
    async function exportAppointments(format) {
        try {
            if (format === 'pdf') {
                exportAppointmentsToPDF();
            } else if (format === 'excel') {
                exportAppointmentsToExcel();
            }
        } catch (error) {
            console.error('‚ùå Error exportando:', error);
            showMessage('Error al exportar reporte', 'error');
        }
    }

    function exportAppointmentsToPDF() {
        // Crear ventana de impresi√≥n con el reporte
        const printWindow = window.open('', '_blank');

        const reportContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Reporte de Citas</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #52B788; padding-bottom: 20px; }
                    .title { font-size: 24px; color: #2D6A4F; margin-bottom: 10px; }
                    .subtitle { color: #52B788; margin-bottom: 20px; }
                    .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                    .summary-item { text-align: center; padding: 15px; background: #D8F3DC; border-radius: 10px; }
                    .summary-value { font-size: 20px; font-weight: bold; color: #2D6A4F; }
                    .summary-label { color: #52B788; margin-top: 5px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { padding: 10px; border: 1px solid #B7E4C7; text-align: left; }
                    th { background: #D8F3DC; color: #2D6A4F; font-weight: bold; }
                    tr:nth-child(even) { background: #F8FBF9; }
                    .status-confirmed { color: #52B788; font-weight: bold; }
                    .status-scheduled { color: #22577A; }
                    .status-completed { color: #2D6A4F; font-weight: bold; }
                    .status-cancelled { color: #6c757d; }
                    .priority-emergency { color: #dc3545; font-weight: bold; }
                    .priority-urgent { color: #f57c00; font-weight: bold; }
                    .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="title">REPORTE DE CITAS M√âDICAS</div>
                    <div class="subtitle">Cl√≠nica Veterinaria - ${formatDate(new Date().toISOString())}</div>
                </div>

                <div class="summary">
                    <div class="summary-item">
                        <div class="summary-value">${allAppointments.length}</div>
                        <div class="summary-label">Total Citas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${allAppointments.filter(a => a.status === 'confirmed' || a.status === 'scheduled').length}</div>
                        <div class="summary-label">Programadas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${allAppointments.filter(a => a.status === 'completed').length}</div>
                        <div class="summary-label">Completadas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${allAppointments.filter(a => a.priority === 'emergency').length}</div>
                        <div class="summary-label">Emergencias</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Cliente</th>
                            <th>Mascota</th>
                            <th>Veterinario</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Motivo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredAppointments.map(appointment => `
                            <tr>
                                <td>${formatDate(appointment.appointment_date)}</td>
                                <td>${appointment.appointment_time}</td>
                                <td>${appointment.client_name}</td>
                                <td>${appointment.pet_name} (${getSpeciesLabel(appointment.pet_species)})</td>
                                <td>${appointment.veterinarian_name}</td>
                                <td class="status-${appointment.status}">${getStatusText(appointment.status)}</td>
                                <td class="priority-${appointment.priority}">${getPriorityText(appointment.priority)}</td>
                                <td>${appointment.reason}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="footer">
                    Reporte generado el ${formatDateTime(new Date().toISOString())} - Total de citas: ${filteredAppointments.length}
                </div>
            </body>
            </html>
        `;

        printWindow.document.write(reportContent);
        printWindow.document.close();

        printWindow.onload = function() {
            printWindow.print();
        };

        showMessage('Generando reporte PDF...', 'info');
    }

    function exportAppointmentsToExcel() {
        // Preparar datos para Excel
        const excelData = filteredAppointments.map(appointment => ({
            'Fecha': formatDate(appointment.appointment_date),
            'Hora': appointment.appointment_time,
            'Cliente': appointment.client_name,
            'Tel√©fono': appointment.client_phone || '',
            'Email': appointment.client_email || '',
            'Mascota': appointment.pet_name,
            'Especie': getSpeciesLabel(appointment.pet_species),
            'Raza': appointment.pet_breed || '',
            'Veterinario': appointment.veterinarian_name,
            'Estado': getStatusText(appointment.status),
            'Prioridad': getPriorityText(appointment.priority),
            'Motivo': appointment.reason,
            'Notas': appointment.notes || '',
            'Creada': formatDateTime(appointment.created_at),
            'ID': appointment.id
        }));

        // Convertir a CSV
        const csvContent = convertToCSV(excelData);
        downloadCSV(csvContent, `citas_${new Date().toISOString().split('T')[0]}.csv`);

        showMessage('Archivo Excel descargado exitosamente', 'success');
    }

    // =============== OTRAS FUNCIONES ===============
    async function syncWithCalendar() {
        try {
            showMessage('Sincronizando con el sistema...', 'info');
            await loadAppointmentsData();
            showMessage('Sincronizaci√≥n completada', 'success');
        } catch (error) {
            showMessage('Error en la sincronizaci√≥n', 'error');
        }
    }

    async function printAppointment(appointmentId) {
        const appointment = currentViewingAppointment || allAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
            showMessage('Cita no encontrada', 'error');
            return;
        }

        // Crear ventana de impresi√≥n
        const printWindow = window.open('', '_blank');

        const printContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Cita - ${appointment.pet_name}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.4;
                        color: #333;
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 20px;
                    }
                    .header {
                        text-align: center;
                        border-bottom: 2px solid #52B788;
                        padding-bottom: 20px;
                        margin-bottom: 30px;
                    }
                    .clinic-name {
                        font-size: 24px;
                        font-weight: bold;
                        color: #2D6A4F;
                        margin-bottom: 5px;
                    }
                    .clinic-subtitle {
                        color: #52B788;
                        margin-bottom: 10px;
                    }
                    .appointment-title {
                        font-size: 20px;
                        color: #2D6A4F;
                        margin-top: 15px;
                    }
                    .section {
                        margin-bottom: 25px;
                        page-break-inside: avoid;
                    }
                    .section-title {
                        background: #D8F3DC;
                        color: #2D6A4F;
                        padding: 10px;
                        margin-bottom: 10px;
                        font-weight: bold;
                        border-left: 4px solid #52B788;
                    }
                    .info-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 15px;
                        margin-bottom: 15px;
                    }
                    .info-item {
                        margin-bottom: 10px;
                    }
                    .info-label {
                        font-weight: bold;
                        color: #2D6A4F;
                    }
                    .info-value {
                        color: #333;
                        margin-left: 10px;
                    }
                    .text-content {
                        background: #F8FBF9;
                        padding: 15px;
                        border-radius: 5px;
                        border-left: 3px solid #52B788;
                        min-height: 50px;
                    }
                    .footer {
                        margin-top: 40px;
                        text-align: center;
                        color: #666;
                        font-size: 12px;
                        border-top: 1px solid #ddd;
                        padding-top: 20px;
                    }
                    .signature-section {
                        margin-top: 40px;
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 40px;
                    }
                    .signature {
                        text-align: center;
                        border-top: 1px solid #333;
                        padding-top: 10px;
                        margin-top: 40px;
                    }
                    @media print {
                        body { print-color-adjust: exact; }
                        .header { break-after: avoid; }
                        .section { break-inside: avoid; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="clinic-name">CL√çNICA VETERINARIA</div>
                    <div class="clinic-subtitle">Sistema de Gesti√≥n de Citas</div>
                    <div class="appointment-title">COMPROBANTE DE CITA</div>
                </div>

                <!-- INFORMACI√ìN DE LA CITA -->
                <div class="section">
                    <div class="section-title">üìÖ INFORMACI√ìN DE LA CITA</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Fecha:</span>
                            <span class="info-value">${formatDate(appointment.appointment_date)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Hora:</span>
                            <span class="info-value">${appointment.appointment_time}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Estado:</span>
                            <span class="info-value">${getStatusText(appointment.status)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Prioridad:</span>
                            <span class="info-value">${getPriorityText(appointment.priority)}</span>
                        </div>
                    </div>
                </div>

                <!-- INFORMACI√ìN DEL CLIENTE -->
                <div class="section">
                    <div class="section-title">üë§ INFORMACI√ìN DEL CLIENTE</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Nombre:</span>
                            <span class="info-value">${appointment.client_name}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tel√©fono:</span>
                            <span class="info-value">${appointment.client_phone || 'No disponible'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${appointment.client_email || 'No disponible'}</span>
                        </div>
                    </div>
                </div>

                <!-- INFORMACI√ìN DE LA MASCOTA -->
                <div class="section">
                    <div class="section-title">üêæ INFORMACI√ìN DE LA MASCOTA</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Nombre:</span>
                            <span class="info-value">${appointment.pet_name}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Especie:</span>
                            <span class="info-value">${getSpeciesLabel(appointment.pet_species)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Raza:</span>
                            <span class="info-value">${appointment.pet_breed || 'No especificada'}</span>
                        </div>
                    </div>
                </div>

                <!-- INFORMACI√ìN DEL VETERINARIO -->
                <div class="section">
                    <div class="section-title">üë®‚Äç‚öïÔ∏è VETERINARIO</div>
                    <div class="info-item">
                        <span class="info-label">Nombre:</span>
                        <span class="info-value">${appointment.veterinarian_name}</span>
                    </div>
                </div>

                <!-- MOTIVO -->
                <div class="section">
                    <div class="section-title">üìã MOTIVO DE LA CONSULTA</div>
                    <div class="text-content">
                        ${appointment.reason}
                    </div>
                </div>

                ${appointment.notes ? `
                    <div class="section">
                        <div class="section-title">üìù NOTAS ADICIONALES</div>
                        <div class="text-content">
                            ${appointment.notes}
                        </div>
                    </div>
                ` : ''}

                <!-- FIRMAS -->
                <div class="signature-section">
                    <div>
                        <div class="signature">
                            <div>Firma del Cliente</div>
                        </div>
                    </div>
                    <div>
                        <div class="signature">
                            <div>Firma del Veterinario</div>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    Comprobante generado el ${new Date().toLocaleDateString('es-CO')} - ID: ${appointment.id}
                </div>
            </body>
            </html>
        `;

        printWindow.document.write(printContent);
        printWindow.document.close();

        // Esperar a que cargue e imprimir
        printWindow.onload = function() {
            printWindow.print();
            // Cerrar ventana despu√©s de imprimir (opcional)
            setTimeout(() => {
                printWindow.close();
            }, 1000);
        };
    }

    async function createMedicalRecord(appointmentId) {
        const appointment = allAppointments.find(a => a.id === appointmentId);
        if (!appointment) {
            showMessage('Cita no encontrada', 'error');
            return;
        }

        try {
            // Crear historia cl√≠nica basada en la cita
            const recordData = {
                pet_id: appointment.pet_id,
                veterinarian_id: appointment.veterinarian_id,
                appointment_id: appointment.id,
                symptoms_description: appointment.reason,
                is_emergency: appointment.priority === 'emergency',
                status: 'draft'
            };

            const response = await fetch('/api/admin/medical-records', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(recordData)
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showMessage('Historia cl√≠nica creada exitosamente', 'success');

                    // Opcional: redirigir a la p√°gina de historias cl√≠nicas
                    if (confirm('¬øDesea ir a la p√°gina de historias cl√≠nicas para completar el registro?')) {
                        window.location.href = '/admin/medical-records';
                    }
                }
            } else {
                throw new Error('Error del servidor');
            }

        } catch (error) {
            console.error('‚ùå Error creando historia cl√≠nica:', error);
            showMessage('Error al crear historia cl√≠nica', 'error');
        }
    }

    async function sendCancellationNotification(appointment) {
        try {
            const response = await fetch('/api/admin/appointments/send-cancellation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    appointment_id: appointment.id,
                    client_email: appointment.client_email,
                    client_phone: appointment.client_phone
                })
            });

            if (response.ok) {
                showMessage('Notificaci√≥n de cancelaci√≥n enviada', 'info');
            }
        } catch (error) {
            console.error('‚ùå Error enviando notificaci√≥n de cancelaci√≥n:', error);
        }
    }

    // =============== MODALES DE CONFIRMACI√ìN ===============
    function showConfirmModal(title, message, buttonText, icon) {
        const modal = document.getElementById('confirmModal');

        document.getElementById('confirmIcon').textContent = icon;
        document.getElementById('confirmTitle').innerHTML = `<span>${icon}</span> ${title}`;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmBtnText').textContent = buttonText;

        modal.classList.add('active');
    }

    function closeConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.classList.remove('active');
        confirmAction = null;
    }

    function executeConfirmAction() {
        if (confirmAction && typeof confirmAction === 'function') {
            confirmAction();
        }
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('active');
        });
        currentEditingAppointment = null;
        currentViewingAppointment = null;
        confirmAction = null;
    }

    // =============== FUNCIONES DE UTILIDAD ===============
    function getStatusBadge(status) {
        const badges = {
            'scheduled': '<span class="status-badge scheduled">üìã Programada</span>',
            'confirmed': '<span class="status-badge confirmed">‚úÖ Confirmada</span>',
            'completed': '<span class="status-badge completed">üèÅ Completada</span>',
            'cancelled': '<span class="status-badge cancelled">‚ùå Cancelada</span>'
        };
        return badges[status] || '<span class="status-badge scheduled">üìã Programada</span>';
    }

    function getStatusText(status) {
        const texts = {
            'scheduled': 'Programada',
            'confirmed': 'Confirmada',
            'completed': 'Completada',
            'cancelled': 'Cancelada'
        };
        return texts[status] || 'Programada';
    }

    function getStatusIcon(status) {
        const icons = {
            'scheduled': 'üìã',
            'confirmed': '‚úÖ',
            'completed': 'üèÅ',
            'cancelled': '‚ùå'
        };
        return icons[status] || 'üìã';
    }

    function getPriorityBadge(priority) {
        const badges = {
            'normal': '<span class="priority-badge normal">üü¢ Normal</span>',
            'urgent': '<span class="priority-badge urgent">üü° Urgente</span>',
            'emergency': '<span class="priority-badge emergency">üî¥ Emergencia</span>'
        };
        return badges[priority] || '<span class="priority-badge normal">üü¢ Normal</span>';
    }

    function getPriorityText(priority) {
        const texts = {
            'normal': 'Normal',
            'urgent': 'Urgente',
            'emergency': 'Emergencia'
        };
        return texts[priority] || 'Normal';
    }

    function getPriorityIcon(priority) {
        const icons = {
            'normal': 'üü¢',
            'urgent': 'üü°',
            'emergency': 'üî¥'
        };
        return icons[priority] || 'üü¢';
    }

    function getSpeciesLabel(species) {
        const labels = {
            'perro': 'üêï Perro',
            'gato': 'üê± Gato',
            'ave': 'ü¶ú Ave',
            'conejo': 'üê∞ Conejo',
            'hamster': 'üêπ H√°mster',
            'otro': 'üêæ Otro'
        };
        return labels[species] || 'üêæ Desconocido';
    }

    function showLoadingMessage(message) {
        const container = document.getElementById('appointmentsTableContainer');
        container.innerHTML = `
            <div class="table-loading">
                <div class="spinner"></div>
                <span>${message}</span>
            </div>
        `;
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';

        const headers = Object.keys(data[0]);
        const csvHeaders = headers.join(',');

        const csvRows = data.map(row =>
            headers.map(header => {
                const value = row[header] || '';
                // Escapar comillas y encerrar en comillas si contiene comas
                return `"${value.toString().replace(/"/g, '""')}"`;
            }).join(',')
        );

        return [csvHeaders, ...csvRows].join('\n');
    }

    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');

        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function saveDraft() {
        // Guardar borrador autom√°ticamente (opcional)
        const form = document.getElementById('appointmentForm');
        if (form && document.getElementById('appointmentModal').classList.contains('active')) {
            console.log('üíæ Auto-guardando borrador...');
            // Aqu√≠ se podr√≠a implementar el guardado autom√°tico
        }
    }



    // =============== FUNCIONES GLOBALES PARA USO EN HTML ===============

    // Hacer funciones disponibles globalmente para los onclick en HTML
    window.openAppointmentModal = openAppointmentModal;
    window.closeAppointmentModal = closeAppointmentModal;
    window.saveAppointment = saveAppointment;
    window.viewAppointment = viewAppointment;
    window.editAppointment = editAppointment;
    window.deleteAppointment = deleteAppointment;
    window.confirmAppointment = confirmAppointment;
    window.completeAppointment = completeAppointment;
    window.cancelAppointment = cancelAppointment;
    window.updateClientPets = updateClientPets;
    window.checkAvailableSlots = checkAvailableSlots;
    window.selectTimeSlot = selectTimeSlot;
    window.filterAppointments = filterAppointments;
    window.sortAppointments = sortAppointments;F
    window.resetFilters = resetFilters;
    window.switchView = switchView;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.goToToday = goToToday;
    window.selectCalendarDay = selectCalendarDay;
    window.syncWithCalendar = syncWithCalendar;
    window.exportAppointments = exportAppointments;
    window.closeAppointmentDetailsModal = closeAppointmentDetailsModal;
    window.editAppointmentFromDetails = editAppointmentFromDetails;
    window.printAppointment = printAppointment;
    window.createMedicalRecord = createMedicalRecord;
    window.toggleSelectAll = toggleSelectAll;
    window.toggleAppointmentSelection = toggleAppointmentSelection;
    window.openBulkActionsModal = openBulkActionsModal;
    window.closeBulkActionsModal = closeBulkActionsModal;
    window.executeBulkAction = executeBulkAction;
    window.showConfirmModal = showConfirmModal;
    window.closeConfirmModal = closeConfirmModal;
    window.executeConfirmAction = executeConfirmAction;

    console.log('‚úÖ Gesti√≥n de Citas - JavaScript cargado completamente');

    </script>
{% endblock %}